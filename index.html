<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema VIVABOX - Control Completo de Cajas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            line-height: 1.4;
        }
        
        /* HEADER PRINCIPAL */
        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .main-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .main-header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        /* NAVEGACI√ìN POR PESTA√ëAS */
        .tabs-container {
            background-color: white;
            border-bottom: 3px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tabs-nav {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: auto;
        }
        
        .tab-button {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab-button:hover {
            background-color: #f8f9fa;
            color: #495057;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background-color: #f8f9fa;
        }
        
        /* CONTENIDO DE PESTA√ëAS */
        .tab-content {
    display: none !important;
    min-height: calc(100vh - 140px);
}

.tab-content.active {
    display: block !important;
}
        
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
        }
        
        /* ESTILOS GENERALES PARA TODAS LAS SECCIONES */
        .section {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #dee2e6;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: bold;
            color: #495057;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        /* BOTONES */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 5px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* TABLAS */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table th {
            background-color: #495057;
            color: white;
            padding: 15px 12px;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
        }
        
        .table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
        }
        
        .table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .table tr:hover {
            background-color: #e9ecef;
        }
        
        /* ALERTAS */
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .alert-error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        /* ESTILOS ESPEC√çFICOS PARA CONFIGURACI√ìN */
        .config-section {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .config-item {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #bbdefb;
        }
        
        .config-item label {
            color: #1976d2;
        }
        
        /* ESTILOS PARA CAT√ÅLOGO */
        .catalog-table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .catalog-table th {
            background-color: #ff9800;
            color: white;
        }
        
        .catalog-table .money {
            text-align: right;
            font-family: monospace;
            font-weight: bold;
        }
        
        /* ESTILOS PARA CALENDARIO */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #333;
            font-size: 10px;
        }
        
        .calendar-table td {
            border: 1px solid #666;
            padding: 5px;
            text-align: center;
            vertical-align: top;
            width: 16.66%;
            height: 40px;
        }
        
        .day-header {
            background-color: #4caf50;
            color: white;
            font-weight: bold;
            font-size: 9px;
        }
        
        .date-cell {
            background-color: #e8f5e8;
            font-size: 8px;
            font-weight: bold;
            color: #2e7d32;
        }
        
        .calc-cell {
            background-color: #ffffff;
            font-size: 7px;
            position: relative;
        }
        
        .calc-cell.alert {
            background-color: #ffcdd2;
            color: #c62828;
        }
        
        /* UTILIDADES */
        .hidden {
            display: none;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .amount-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .amount-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .content-wrapper {
                padding: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                flex-direction: column;
            }
            
            .tab-button {
                min-width: auto;
            }
        }

        /* RESPONSIVE PARA RESUMEN DE MOVIMIENTOS */
@media (max-width: 768px) {
    .grid-resumen-movimientos {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
    }
}

/* ESTILOS ESPEC√çFICOS PARA SUB-PESTA√ëAS DE MOVIMIENTOS */
.mov-content {
    width: 100%;
    min-height: 400px;
}

.mov-content.active {
    display: block !important;
}

.mov-content:not(.active) {
    display: none !important;
}

.mov-tab {
    position: relative;
    z-index: 1;
}

.mov-tab.active {
    background-color: #667eea !important;
    color: white !important;
}

.mov-tab:not(.active) {
    background-color: transparent !important;
    color: #6c757d !important;
}

.mov-tab:hover:not(.active) {
    background-color: #e9ecef !important;
    color: #495057 !important;
}
/* CORRECCI√ìN ESPEC√çFICA PARA SUB-PESTA√ëAS DE MOVIMIENTOS */

.mov-content.active {
    display: block !important; /* Cuando tiene clase active, se muestra */
}

/* CORRECCI√ìN: Eliminar la regla que causa conflicto */
.mov-content:not(.active) {
    display: none !important;
}

/* Estilos para los botones de sub-pesta√±as */
.mov-tab {
    position: relative;
    z-index: 1;
    transition: all 0.3s ease;
}

.mov-tab.active {
    background-color: #667eea !important;
    color: white !important;
    font-weight: bold !important;
}

.mov-tab:not(.active) {
    background-color: transparent !important;
    color: #6c757d !important;
    font-weight: bold !important;
}

.mov-tab:hover:not(.active) {
    background-color: #e9ecef !important;
    color: #495057 !important;
}

/* Asegurar que el contenido se muestre correctamente */
#adicionales-subtab.active,
#edicion-subtab.active {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}


/* SOLUCI√ìN DEFINITIVA PARA SUB-PESTA√ëAS DE MOVIMIENTOS */

/* Resetear todas las reglas conflictivas de mov-content */
.mov-content {
    width: 100% !important;
    min-height: 400px !important;
    display: none !important; /* Por defecto oculto */
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
    background-color: transparent !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* Mostrar cuando est√° activo */
.mov-content.active {
    display: block !important;
}

/* Asegurar que el contenido interno sea visible */
#edicion-subtab .section,
#adicionales-subtab .section {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    background-color: white !important;
    border-radius: 12px !important;
    padding: 25px !important;
    margin-bottom: 25px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
    border: 1px solid #dee2e6 !important;
}

/* Estilo espec√≠fico para la secci√≥n de edici√≥n */
#edicion-subtab .section:first-child {
    background-color: #fff8f0 !important;
    border-color: #fd7e14 !important;
}

/* Asegurar que los formularios sean visibles */
#edicion-subtab .form-grid,
#edicion-subtab .form-group,
#edicion-subtab .section-title {
    display: block !important;
    visibility: visible !important;
}

/* T√≠tulos de secci√≥n visibles */
.section-title {
    font-size: 18px !important;
    font-weight: bold !important;
    color: #495057 !important;
    margin-bottom: 20px !important;
    padding-bottom: 10px !important;
    border-bottom: 2px solid #e9ecef !important;
    display: block !important;
}

/* Botones de sub-pesta√±as */
.mov-tab {
    transition: all 0.3s ease !important;
    cursor: pointer !important;
}

.mov-tab.active {
    background-color: #667eea !important;
    color: white !important;
    font-weight: bold !important;
}

.mov-tab:not(.active) {
    background-color: transparent !important;
    color: #6c757d !important;
}

.mov-tab:hover:not(.active) {
    background-color: #e9ecef !important;
    color: #495057 !important;
}

/* CORRECCI√ìN ESPEC√çFICA PARA FORM-GRID DE EDICI√ìN */
#edicion-subtab .form-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
    gap: 20px !important;
}

#edicion-subtab .form-group {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
}
    </style>
</head>
<body>
    <!-- HEADER PRINCIPAL -->
    <div class="main-header">
        <h1>üìä SISTEMA VIVABOX - CONTROL COMPLETO DE CAJAS üìä</h1>
        <p>Gesti√≥n integral de inversiones, ganancias y proyecciones financieras</p>
    </div>
    
    <!-- NAVEGACI√ìN POR PESTA√ëAS -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-button active" onclick="switchMainTab('configuracion')">
                ‚öôÔ∏è Configuraci√≥n
            </button>
            <button class="tab-button" onclick="switchMainTab('control')">
                üìÖ Control Diario
            </button>
            <button class="tab-button" onclick="switchMainTab('registro')">
                üì¶ Registro de Cajas
            </button>
            <button class="tab-button" onclick="switchMainTab('automatizacion')">
                üîß Automatizaci√≥n
            </button>
            <button class="tab-button" onclick="switchMainTab('movimientos')">
                üí∞ Movimientos
            </button>
        </div>
    </div>
    <!-- TAB 1: CONFIGURACI√ìN -->
    <div id="configuracion-tab" class="tab-content active">
        <div class="content-wrapper">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 24px;">
                üìä CONFIGURACI√ìN DEL SISTEMA üìä
            </h2>
            
            <!-- CONFIGURACI√ìN PRINCIPAL -->
            <div class="section config-section">
                <div class="section-title">üîß A. CONFIGURACI√ìN PRINCIPAL</div>
                <div class="form-grid">
                    <div class="config-item">
                        <label for="saldo-inicial">Saldo Inicial (pesos):</label>
                        <input type="number" id="saldo-inicial" placeholder="Ej: 5500" min="0" onchange="updateSystemConfig()">
                        <small style="color: #666;">üí∞ Cantidad con la que comenzar√°s</small>
                    </div>
                    
                    <div class="config-item">
                        <label for="fecha-inicio">Fecha de Inicio:</label>
                        <input type="date" id="fecha-inicio" onchange="updateSystemConfig()">
                        <small style="color: #666;">üìÖ Fecha del D√çA 1 (formato DD/MM/AAAA)</small>
                    </div>
                    
                    <div class="config-item">
                        <label for="nombre-usuario">Nombre del Usuario:</label>
                        <input type="text" id="nombre-usuario" placeholder="Tu nombre" onchange="updateSystemConfig()">
                        <small style="color: #666;">üë§ Para personalizar reportes</small>
                    </div>
                    
                    <div class="config-item">
                        <label>Moneda del Sistema:</label>
                        <div style="font-weight: bold; color: #4CAF50; padding: 12px; background-color: #f8f9fa; border-radius: 4px;">
                            Pesos ($)
                        </div>
                        <small style="color: #666;">üíµ Moneda predefinida del sistema</small>
                    </div>
                </div>
            </div>
            
            <!-- CAT√ÅLOGO DE CAJAS -->
            <div class="section">
                <div class="section-title">üì¶ B. CAT√ÅLOGO DE CAJAS DISPONIBLES</div>
                <table class="table catalog-table">
                    <thead>
                        <tr>
                            <th>Tipo de Caja</th>
                            <th>Precio (pesos)</th>
                            <th>Ganancia Diaria (pesos)</th>
                            <th>ROI Diario (%)</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Caja B√°sica</strong></td>
                            <td class="money">200</td>
                            <td class="money">10</td>
                            <td class="money">5.0%</td>
                            <td>Caja de entrada para principiantes</td>
                        </tr>
                        <tr>
                            <td><strong>Caja Est√°ndar</strong></td>
                            <td class="money">700</td>
                            <td class="money">35</td>
                            <td class="money">5.0%</td>
                            <td>Caja intermedia con buen rendimiento</td>
                        </tr>
                        <tr>
                            <td><strong>Caja Avanzada</strong></td>
                            <td class="money">1,800</td>
                            <td class="money">90</td>
                            <td class="money">5.0%</td>
                            <td>Caja para inversores experimentados</td>
                        </tr>
                        <tr>
                            <td><strong>Caja Premium</strong></td>
                            <td class="money">5,500</td>
                            <td class="money">330</td>
                            <td class="money">6.0%</td>
                            <td>Caja de alto rendimiento</td>
                        </tr>
                        <tr style="background-color: #E8F5E8;">
                            <td><strong>Caja Promocional</strong></td>
                            <td class="money">0</td>
                            <td class="money">35</td>
                            <td class="money">‚àû</td>
                            <td>Caja gratuita (normalmente 2 d√≠as)</td>
                        </tr>
                        <tr>
                            <td><strong>Caja VIP</strong></td>
                            <td class="money">19,000</td>
                            <td class="money">1,140</td>
                            <td class="money">6.0%</td>
                            <td>Caja de m√°ximo rendimiento</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="alert alert-info">
                    <strong>üìù Nota:</strong> Estos precios y ganancias son los valores normales. En el sistema podr√°s aplicar descuentos o bonificaciones especiales cuando sea necesario.
                </div>
            </div>
            
            <!-- INSTRUCCIONES DE USO -->
            <div class="section">
                <div class="section-title">üìñ C. INSTRUCCIONES DETALLADAS DE USO</div>
                
                <div style="line-height: 1.6;">
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">üöÄ PASO 1: Configuraci√≥n Inicial</h3>
                    <ol style="padding-left: 20px;">
                        <li style="margin-bottom: 8px;"><strong>Establece tu saldo inicial:</strong> Ingresa la cantidad de dinero con la que comenzar√°s tu inversi√≥n en la casilla "Saldo Inicial".</li>
                        <li style="margin-bottom: 8px;"><strong>Selecciona la fecha de inicio:</strong> Elige el d√≠a en que comenzar√°s tu control en la casilla "Fecha de Inicio". Esta ser√° la fecha del D√çA 1.</li>
                        <li style="margin-bottom: 8px;"><strong>Verifica el cat√°logo:</strong> Revisa que todos los tipos de cajas y sus valores est√©n correctos seg√∫n tus necesidades actuales.</li>
                    </ol>
                    
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">üì¶ PASO 2: Registro de Cajas</h3>
                    <ol style="padding-left: 20px;">
                        <li style="margin-bottom: 8px;"><strong>Ve a la pesta√±a "Registro de Cajas":</strong> Aqu√≠ registrar√°s todas las compras de cajas que realices.</li>
                        <li style="margin-bottom: 8px;"><strong>Usa el formulario:</strong> Selecciona el tipo de caja, el d√≠a de compra, la duraci√≥n y aplica descuentos si es necesario.</li>
                        <li style="margin-bottom: 8px;"><strong>Confirma la compra:</strong> El sistema autom√°ticamente restar√° el costo de la caja del d√≠a seleccionado y comenzar√° a sumar las ganancias diarias.</li>
                    </ol>
                    
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">üìà PASO 3: Control Diario</h3>
                    <ol style="padding-left: 20px;">
                        <li style="margin-bottom: 8px;"><strong>Ve a la pesta√±a "Control Diario":</strong> Esta es tu hoja principal para seguimiento e impresi√≥n.</li>
                        <li style="margin-bottom: 8px;"><strong>Revisa los c√°lculos autom√°ticos:</strong> Cada d√≠a mostrar√° el desglose completo de operaciones.</li>
                        <li style="margin-bottom: 8px;"><strong>Observa las alertas:</strong> Los d√≠as con fondo rojo indican que una caja vencer√° ese d√≠a.</li>
                    </ol>
                    
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">üí∞ PASO 4: Movimientos Adicionales</h3>
                    <ol style="padding-left: 20px;">
                        <li style="margin-bottom: 8px;"><strong>Ve a la pesta√±a "Movimientos":</strong> Para registrar ingresos o gastos extra.</li>
                        <li style="margin-bottom: 8px;"><strong>Especifica el d√≠a:</strong> Selecciona en qu√© d√≠a del mes aplicar el movimiento.</li>
                        <li style="margin-bottom: 8px;"><strong>Indica el tipo:</strong> Especifica si es ingreso (+) o egreso (-).</li>
                    </ol>
                    
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">‚úèÔ∏è PASO 5: Ediciones Especiales</h3>
                    <ol style="padding-left: 20px;">
                        <li style="margin-bottom: 8px;"><strong>Usa la secci√≥n de edici√≥n en "Movimientos":</strong> Para modificar d√≠as espec√≠ficos cuando sea necesario.</li>
                        <li style="margin-bottom: 8px;"><strong>Casos de uso:</strong> Cuando no se cobra una ganancia (poner ganancia real = 0) o corregir errores.</li>
                        <li style="margin-bottom: 8px;"><strong>Selecciona el d√≠a:</strong> Elige qu√© d√≠a modificar y ajusta los valores necesarios.</li>
                    </ol>
                    
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è IMPORTANTE:</strong> 
                        <ul style="margin: 10px 0;">
                            <li>Solo puedes tener UNA caja de cada tipo activa al mismo tiempo</li>
                            <li>Las ganancias se calculan autom√°ticamente desde el d√≠a de compra</li>
                            <li>Los d√≠as de vencimiento aparecen en ROJO para alertarte</li>
                            <li>El formato de los 90 d√≠as NO debe modificarse para mantener la impresi√≥n perfecta</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong>‚úÖ CONSEJOS PARA MEJOR USO:</strong>
                        <ul style="margin: 10px 0;">
                            <li>Revisa diariamente la hoja de control para estar al pendiente de vencimientos</li>
                            <li>Planifica las compras nuevas 1-2 d√≠as antes de que venzan las cajas actuales</li>
                            <li>Usa la proyecci√≥n de 90 d√≠as para planificar estrategias futuras</li>
                            <li>Consulta la pesta√±a de Automatizaci√≥n para reportes avanzados</li>
                        </ul>
                    </div>
                    
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">üîÑ FLUJO DE TRABAJO RECOMENDADO</h3>
                    <ol style="padding-left: 20px;">
                        <li style="margin-bottom: 8px;"><strong>Al iniciar:</strong> Configuraci√≥n ‚Üí Registro primera caja ‚Üí Verificar control diario</li>
                        <li style="margin-bottom: 8px;"><strong>Diariamente:</strong> Revisar control diario ‚Üí Verificar alertas rojas ‚Üí Planificar pr√≥ximas compras</li>
                        <li style="margin-bottom: 8px;"><strong>Al comprar:</strong> Registro de cajas ‚Üí Verificar c√°lculos ‚Üí Confirmar en control diario</li>
                        <li style="margin-bottom: 8px;"><strong>Si hay cambios:</strong> Movimientos adicionales o Edici√≥n d√≠as seg√∫n sea necesario</li>
                        <li style="margin-bottom: 8px;"><strong>Para an√°lisis:</strong> Consultar pesta√±a de Automatizaci√≥n para reportes detallados</li>
                    </ol>
                </div>
            </div>
            
            <div class="text-center" style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="switchMainTab('registro')">
                    ‚û°Ô∏è CONTINUAR A REGISTRO DE CAJAS
                </button>
                <button class="btn btn-success" onclick="exportConfig()">
                    üíæ GUARDAR CONFIGURACI√ìN
                </button>
            </div>
            
            <div id="config-alerts"></div>
        </div>
    </div>
    <!-- TAB 2: CONTROL DIARIO -->
    <div id="control-tab" class="tab-content">
        <div class="content-wrapper">
            <!-- HEADER DEL CONTROL -->
            <div class="section">
                <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                    <h1 style="margin: 0; font-size: 18px; color: #333; font-weight: bold;">CONTROL DE INVERSI√ìN EN CAJAS - VIVABOX</h1>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px;">
                        <span><strong>FECHA DE INICIO:</strong> <span id="display-fecha-inicio">[CONFIGURAR]</span></span>
                        <span><strong>NOMBRE:</strong> <span id="display-nombre">[CONFIGURAR]</span></span>
                        <span><strong>SALDO INICIAL:</strong> $<span id="display-saldo">[CONFIGURAR]</span></span>
                    </div>
                </div>
                
                <!-- TABLA 1: D√çAS 1-30 -->
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background-color: #E3F2FD; padding: 8px; border-radius: 4px;">
    <div style="font-weight: bold; font-size: 14px; color: #2196F3;">
        üìÖ CONTROL DE D√çAS <span id="control-range-display">1-30</span>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="changeControlRange(1)" style="padding: 6px 12px; font-size: 12px;">
            D√≠as 1-30
        </button>
        <button class="btn btn-secondary" onclick="changeControlRange(2)" style="padding: 6px 12px; font-size: 12px;">
            D√≠as 31-60
        </button>
        <button class="btn btn-secondary" onclick="changeControlRange(3)" style="padding: 6px 12px; font-size: 12px;">
            D√≠as 61-90
        </button>
    </div>
</div>
                    <div id="automation-table-container">
    <table class="calendar-table">
        <!-- Fila 1: D√≠as 1-6 -->
        <tr>
            <td class="day-header">D√çA 1</td><td class="day-header">D√çA 2</td><td class="day-header">D√çA 3</td><td class="day-header">D√çA 4</td><td class="day-header">D√çA 5</td><td class="day-header">D√çA 6</td>
        </tr>
        <tr>
            <td class="date-cell" id="auto-date-1">[FECHA]</td><td class="date-cell" id="auto-date-2">[FECHA]</td><td class="date-cell" id="auto-date-3">[FECHA]</td><td class="date-cell" id="auto-date-4">[FECHA]</td><td class="date-cell" id="auto-date-5">[FECHA]</td><td class="date-cell" id="auto-date-6">[FECHA]</td>
        </tr>
        <tr>
            <td class="calc-cell" id="auto-calc-1"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-1">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-1">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-2"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-2">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-2">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-3"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-3">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-3">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-4"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-4">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-4">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-5"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-5">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-5">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-6"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-6">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-6">[OPS]</div></div></td>
        </tr>
        
        <!-- Fila 2: D√≠as 7-12 -->
        <tr>
            <td class="day-header">D√çA 7</td><td class="day-header">D√çA 8</td><td class="day-header">D√çA 9</td><td class="day-header">D√çA 10</td><td class="day-header">D√çA 11</td><td class="day-header">D√çA 12</td>
        </tr>
        <tr>
            <td class="date-cell" id="auto-date-7">[FECHA]</td><td class="date-cell" id="auto-date-8">[FECHA]</td><td class="date-cell" id="auto-date-9">[FECHA]</td><td class="date-cell" id="auto-date-10">[FECHA]</td><td class="date-cell" id="auto-date-11">[FECHA]</td><td class="date-cell" id="auto-date-12">[FECHA]</td>
        </tr>
        <tr>
            <td class="calc-cell" id="auto-calc-7"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-7">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-7">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-8"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-8">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-8">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-9"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-9">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-9">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-10"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-10">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-10">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-11"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-11">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-11">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-12"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-12">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-12">[OPS]</div></div></td>
        </tr>
        
        <!-- Fila 3: D√≠as 13-18 -->
        <tr>
            <td class="day-header">D√çA 13</td><td class="day-header">D√çA 14</td><td class="day-header">D√çA 15</td><td class="day-header">D√çA 16</td><td class="day-header">D√çA 17</td><td class="day-header">D√çA 18</td>
        </tr>
        <tr>
            <td class="date-cell" id="auto-date-13">[FECHA]</td><td class="date-cell" id="auto-date-14">[FECHA]</td><td class="date-cell" id="auto-date-15">[FECHA]</td><td class="date-cell" id="auto-date-16">[FECHA]</td><td class="date-cell" id="auto-date-17">[FECHA]</td><td class="date-cell" id="auto-date-18">[FECHA]</td>
        </tr>
        <tr>
            <td class="calc-cell" id="auto-calc-13"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-13">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-13">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-14"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-14">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-14">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-15"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-15">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-15">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-16"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-16">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-16">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-17"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-17">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-17">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-18"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-18">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-18">[OPS]</div></div></td>
        </tr>
        
        <!-- Fila 4: D√≠as 19-24 -->
        <tr>
            <td class="day-header">D√çA 19</td><td class="day-header">D√çA 20</td><td class="day-header">D√çA 21</td><td class="day-header">D√çA 22</td><td class="day-header">D√çA 23</td><td class="day-header">D√çA 24</td>
        </tr>
        <tr>
            <td class="date-cell" id="auto-date-19">[FECHA]</td><td class="date-cell" id="auto-date-20">[FECHA]</td><td class="date-cell" id="auto-date-21">[FECHA]</td><td class="date-cell" id="auto-date-22">[FECHA]</td><td class="date-cell" id="auto-date-23">[FECHA]</td><td class="date-cell" id="auto-date-24">[FECHA]</td>
        </tr>
        <tr>
            <td class="calc-cell" id="auto-calc-19"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-19">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-19">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-20"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-20">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-20">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-21"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-21">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-21">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-22"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-22">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-22">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-23"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-23">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-23">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-24"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-24">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-24">[OPS]</div></div></td>
        </tr>
        
        <!-- Fila 5: D√≠as 25-30 -->
        <tr>
            <td class="day-header">D√çA 25</td><td class="day-header">D√çA 26</td><td class="day-header">D√çA 27</td><td class="day-header">D√çA 28</td><td class="day-header">D√çA 29</td><td class="day-header">D√çA 30</td>
        </tr>
        <tr>
            <td class="date-cell" id="auto-date-25">[FECHA]</td><td class="date-cell" id="auto-date-26">[FECHA]</td><td class="date-cell" id="auto-date-27">[FECHA]</td><td class="date-cell" id="auto-date-28">[FECHA]</td><td class="date-cell" id="auto-date-29">[FECHA]</td><td class="date-cell" id="auto-date-30">[FECHA]</td>
        </tr>
        <tr>
            <td class="calc-cell" id="auto-calc-25"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-25">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-25">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-26"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-26">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-26">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-27"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-27">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-27">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-28"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-28">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-28">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-29"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-29">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-29">[OPS]</div></div></td>
            <td class="calc-cell" id="auto-calc-30"><div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;"><div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-30">$0</div><div style="color: #666; font-size: 6px;" id="auto-ops-30">[OPS]</div></div></td>
        </tr>
    </table>
</div>
                </div>
            </div>
            
            <!-- BOTONES DE ACCI√ìN -->
            <div class="text-center" style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="recalculateControl()">üîÑ Recalcular</button>
                <button class="btn btn-success" onclick="printControl()">üñ®Ô∏è Imprimir</button>
                <button class="btn btn-warning" onclick="switchMainTab('registro')">üì¶ Agregar Caja</button>
                <button class="btn btn-secondary" onclick="switchMainTab('movimientos')">üí∞ Movimientos</button>
            </div>
            
            <div id="control-alerts"></div>
        </div>
    </div>
    <!-- TAB 3: REGISTRO DE CAJAS -->
    <div id="registro-tab" class="tab-content">
        <div class="content-wrapper">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 24px;">
                üì¶ REGISTRO Y CONTROL DE CAJAS üì¶
            </h2>
            
            <!-- FORMULARIO DE NUEVA CAJA -->
            <div class="section">
                <div class="section-title">üõí AGREGAR NUEVA CAJA</div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reg-tipo-caja">Tipo de Caja:</label>
                        <select id="reg-tipo-caja" onchange="updateBoxPrices()">
                            <option value="">Seleccionar tipo de caja...</option>
                            <option value="basica" data-precio="200" data-ganancia="10">Caja B√°sica - $200</option>
                            <option value="estandar" data-precio="700" data-ganancia="35">Caja Est√°ndar - $700</option>
                            <option value="avanzada" data-precio="1800" data-ganancia="90">Caja Avanzada - $1,800</option>
                            <option value="premium" data-precio="5500" data-ganancia="330">Caja Premium - $5,500</option>
                            <option value="promocional" data-precio="0" data-ganancia="35">Caja Promocional - GRATIS</option>
                            <option value="vip" data-precio="19000" data-ganancia="1140">Caja VIP - $19,000</option>
                            <option value="especial" data-precio="0" data-ganancia="0">‚≠ê Caja Especial - Personalizar</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reg-dia-compra">D√≠a de Compra (1-90):</label>
                        <input type="number" id="reg-dia-compra" min="1" max="90" placeholder="Ej: 1">
                    </div>
                    
                    <div class="form-group">
                        <label for="reg-duracion-dias">Duraci√≥n (d√≠as):</label>
                        <input type="number" id="reg-duracion-dias" min="1" max="365" placeholder="Ej: 30">
                    </div>
                    
                    <div class="form-group">
                        <label for="reg-descuento-pct">Descuento (%):</label>
                        <input type="number" id="reg-descuento-pct" min="0" max="100" step="0.1" placeholder="0" oninput="calculateBoxFinalPrice()">
                    </div>
                </div>
                
                <!-- DISPLAY DE PRECIOS -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="text-align: center; padding: 10px; border-radius: 6px; background-color: #e9ecef; color: #495057;">
                        <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">PRECIO ORIGINAL</div>
                        <div style="font-size: 18px; font-weight: bold;" id="reg-precio-original">$0</div>
                    </div>
                    <div style="text-align: center; padding: 10px; border-radius: 6px; background-color: #fff3cd; color: #856404;">
                        <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">DESCUENTO</div>
                        <div style="font-size: 18px; font-weight: bold;" id="reg-descuento-monto">$0</div>
                    </div>
                    <div style="text-align: center; padding: 10px; border-radius: 6px; background-color: #d4edda; color: #155724;">
                        <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">PRECIO FINAL</div>
                        <div style="font-size: 18px; font-weight: bold;" id="reg-precio-final">$0</div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button class="btn btn-primary" onclick="addNewBox()">
                        ‚ûï AGREGAR CAJA
                    </button>
                    <button class="btn btn-success" onclick="clearBoxForm()">
                        üîÑ LIMPIAR FORMULARIO
                    </button>
                </div>
                
                <div id="reg-alerts"></div>
            </div>
            
            <!-- TABLA DE CAJAS REGISTRADAS -->
            <div class="section">
                <div class="section-title">üìã CAJAS REGISTRADAS</div>
                
                <table class="table" id="reg-boxes-table">
                    <thead>
                        <tr>
                            <th>Tipo de Caja</th>
                            <th>D√≠a Compra</th>
                            <th>Duraci√≥n</th>
                            <th>Precio Pagado</th>
                            <th>Ganancia Diaria</th>
                            <th>D√≠a Vencimiento</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="reg-boxes-tbody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 30px; color: #6c757d;">
                                No hay cajas registradas. Agrega tu primera caja usando el formulario arriba.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- MODAL PARA CAJA ESPECIAL -->
    <div id="modal-caja-especial" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #667eea; padding-bottom: 15px;">
                <h3 style="margin: 0; color: #667eea; font-size: 20px;">‚≠ê Crear Caja Especial</h3>
                <button onclick="cerrarModalCajaEspecial()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer; padding: 5px;">&times;</button>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="especial-nombre">Nombre de la Caja:</label>
                    <input type="text" id="especial-nombre" placeholder="Ej: Caja Black Friday 2025" maxlength="50" oninput="actualizarVistaPreviaCajaEspecial()">
                </div>
                
                <div class="form-group">
                    <label for="especial-precio">Precio de la Caja:</label>
                    <input type="number" id="especial-precio" placeholder="Ej: 3000" min="0" step="0.01" oninput="actualizarVistaPreviaCajaEspecial()">
                </div>
                
                <div class="form-group">
                    <label for="especial-ganancia">Ganancia Diaria:</label>
                    <input type="number" id="especial-ganancia" placeholder="Ej: 150" min="0" step="0.01" oninput="actualizarVistaPreviaCajaEspecial()">
                </div>
                
                <div class="form-group">
                    <label for="especial-duracion">Duraci√≥n (d√≠as):</label>
                    <input type="number" id="especial-duracion" placeholder="Ej: 30" min="1" oninput="actualizarVistaPreviaCajaEspecial()">
                </div>
                
                <div class="form-group">
                    <label for="especial-dia-compra">D√≠a de Compra (1-90):</label>
                    <input type="number" id="especial-dia-compra" placeholder="Ej: 1" min="1" max="90" oninput="actualizarVistaPreviaCajaEspecial()">
                </div>
                
                <div class="form-group">
                    <label for="especial-descuento">Descuento (%):</label>
                    <input type="number" id="especial-descuento" placeholder="Ej: 10" min="0" max="100" step="0.1" value="0" oninput="actualizarVistaPreviaCajaEspecial()">
                </div>
            </div>
            
            <!-- Vista previa de la caja especial -->
            <div style="background-color: #f8f9fa; border: 2px solid #667eea; border-radius: 8px; padding: 15px; margin: 20px 0;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 10px;">üìä VISTA PREVIA DE LA CAJA</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;">
                    <div><strong>Precio Final:</strong> <span id="especial-preview-precio">$0</span></div>
                    <div><strong>ROI Diario:</strong> <span id="especial-preview-roi">0%</span></div>
                    <div><strong>Vencimiento:</strong> <span id="especial-preview-vencimiento">D√≠a --</span></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="crearCajaEspecial()" style="margin-right: 10px;">
                    ‚≠ê Crear Caja Especial
                </button>
                <button class="btn btn-secondary" onclick="cerrarModalCajaEspecial()">
                    Cancelar
                </button>
            </div>
            
            <div id="especial-alerts" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <!-- TAB 4: AUTOMATIZACI√ìN -->
    <div id="automatizacion-tab" class="tab-content">
        <div class="content-wrapper">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 24px;">
                üîß MOTOR DE AUTOMATIZACI√ìN Y AN√ÅLISIS üîß
            </h2>
            
            <!-- ESTADO DEL SISTEMA -->
            <div class="section">
                <div class="section-title">üìä ESTADO ACTUAL DEL SISTEMA</div>
                <!-- SELECTOR DE FECHA PARA AN√ÅLISIS -->
        <div style="background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div style="font-weight: bold; color: #1976d2;">
                    üìÖ Analizar estado al d√≠a:
                </div>
                <input type="number" id="analysis-day-selector" min="1" max="90" value="1" 
                       style="padding: 8px 12px; border: 2px solid #2196f3; border-radius: 6px; font-weight: bold; text-align: center; width: 80px;"
                       onchange="updateMetricsBySelectedDate()">
                <div style="font-size: 12px; color: #666;">
                    D√≠a 1-90 del sistema
                </div>
                <div style="font-size: 12px; color: #666;" id="analysis-real-date">
                    Fecha real: --
                </div>
            </div>
        </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #c8e6c9;">
                        <div style="font-size: 14px; font-weight: bold; color: #2e7d32; margin-bottom: 5px; line-height: 1.2; min-height: 40px; display: flex; align-items: center;" id="auto-status-boxes">0</div>
                        <div style="font-size: 12px; color: #666;">Cajas Activas en Fecha</div>
                    </div>
                    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #c8e6c9;">
                        <div style="font-size: 20px; font-weight: bold; color: #2e7d32; margin-bottom: 5px;" id="auto-status-investment">$0</div>
                        <div style="font-size: 12px; color: #666;">Total Invertido</div>
                    </div>
                    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #c8e6c9;">
                        <div style="font-size: 20px; font-weight: bold; color: #2e7d32; margin-bottom: 5px;" id="auto-status-daily">$0</div>
                        <div style="font-size: 12px; color: #666;">Ganancia Diaria</div>
                    </div>
                    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #c8e6c9;">
                        <div style="font-size: 20px; font-weight: bold; color: #2e7d32; margin-bottom: 5px;" id="auto-status-balance">$0</div>
                        <div style="font-size: 12px; color: #666;">Saldo Actual</div>
                    </div>
                    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #c8e6c9;">
                        <div style="font-size: 14px; font-weight: bold; color: #2e7d32; margin-bottom: 5px; line-height: 1.3; min-height: 60px; display: flex; align-items: center; text-align: center;" id="auto-status-expiring">0</div>
                        <div style="font-size: 12px; color: #666;">Alertas de Vencimiento</div>
                    </div>
                    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #c8e6c9;">
                        <div style="font-size: 20px; font-weight: bold; color: #2e7d32; margin-bottom: 5px;" id="auto-status-projection">$0</div>
                        <div style="font-size: 12px; color: #6c757d;">Proyecci√≥n 90 d√≠as</div>
                    </div>
                </div>
            </div>
            
            <!-- MOTOR DE C√ÅLCULOS -->
            <div class="section">
                <div class="section-title">üßÆ MOTOR DE C√ÅLCULOS AUTOM√ÅTICOS</div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="recalculateAllSystem()">üîÑ Recalcular Todo</button>
                    <button class="btn btn-warning" onclick="updateAllDates()">üìÖ Actualizar Fechas</button>
                    <button class="btn btn-primary" onclick="generateSystemReport()">üìä Generar Reporte</button>
                    <button class="btn btn-secondary" onclick="exportSystemData()">üíæ Exportar Datos</button>
                    <button class="btn btn-success" onclick="startImportProcess()">üì• Importar Datos</button>
                </div>
                
                
            </div>
            
            <div id="auto-alerts"></div>
        </div>
    </div>
    <!-- TAB 5: MOVIMIENTOS -->
    <div id="movimientos-tab" class="tab-content">
        <div class="content-wrapper">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 24px;">
                üí∞ MOVIMIENTOS ADICIONALES Y EDICI√ìN DE D√çAS üí∞
            </h2>
            
            <!-- SUB-TABS PARA MOVIMIENTOS -->
<div style="display: flex; background-color: #f8f9fa; border-radius: 8px; padding: 5px; margin-bottom: 25px;">
    <button id="btn-adicionales" style="flex: 1; padding: 12px 20px; text-align: center; background-color: #667eea; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; color: white;" class="mov-tab active" onclick="switchMovTab('adicionales')">
        üí∞ Movimientos Adicionales
    </button>
    <button id="btn-edicion" style="flex: 1; padding: 12px 20px; text-align: center; background-color: transparent; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; color: #6c757d;" class="mov-tab" onclick="switchMovTab('edicion')">
        ‚úèÔ∏è Edici√≥n de D√≠as
    </button>
</div>
            
            <!-- SUB-TAB: MOVIMIENTOS ADICIONALES -->
            <div id="adicionales-subtab" class="mov-content active" style="display: block;">
                <!-- FORMULARIO DE NUEVO MOVIMIENTO -->
                <div class="section" style="background-color: #f8fff9; border-color: #28a745;">
                    <div class="section-title" style="color: #155724;">‚ûï AGREGAR NUEVO MOVIMIENTO</div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="mov-day">D√≠a del Movimiento (1-90):</label>
                            <input type="number" id="mov-day" min="1" max="90" placeholder="Ej: 15">
                        </div>
                        
                        <div class="form-group">
                            <label for="mov-type">Tipo de Movimiento:</label>
                            <select id="mov-type" onchange="updateMovementCategories()">
                                <option value="">Seleccionar tipo...</option>
                                <option value="income">üí∞ Ingreso (+)</option>
                                <option value="expense">üí∏ Egreso (-)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="mov-amount">Monto (pesos):</label>
                            <input type="number" id="mov-amount" min="0" step="0.01" placeholder="Ej: 1500">
                        </div>
                        
                        <div class="form-group">
                            <label for="mov-category">Categor√≠a:</label>
                            <select id="mov-category">
                                <option value="">Seleccionar categor√≠a...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="mov-description">Descripci√≥n:</label>
                        <textarea id="mov-description" placeholder="Describe el motivo del movimiento..." style="resize: vertical; min-height: 80px;"></textarea>
                    </div>
                    
                    <!-- VISTA PREVIA DEL IMPACTO -->
                    <div style="background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <div style="font-weight: bold; color: #1976d2; margin-bottom: 10px;">üìä VISTA PREVIA DEL IMPACTO</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #bbdefb;">
        <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">Saldo Antes</div>
        <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="mov-balance-before">$0</div>
        <div style="font-size: 10px; color: #999; margin-top: 4px;">Balance del d√≠a seleccionado</div>
    </div>
    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #bbdefb;">
        <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">Movimiento</div>
        <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="mov-movement-value">$0</div>
        <div style="font-size: 10px; color: #999; margin-top: 4px;">Monto a ingresar/egresar</div>
    </div>
    <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #bbdefb;">
        <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">Saldo Despu√©s</div>
        <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="mov-balance-after">$0</div>
        <div style="font-size: 10px; color: #999; margin-top: 4px;">Balance resultante</div>
    </div>
</div>
                    </div>
                    
                    <div class="text-center" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="addMovement()">
                            ‚ûï AGREGAR MOVIMIENTO
                        </button>
                        <button class="btn btn-secondary" onclick="clearMovementForm()">
                            üîÑ LIMPIAR FORMULARIO
                        </button>
                    </div>
                    
                    <div id="mov-alerts"></div>
                </div>
                
                <!-- RESUMEN DE MOVIMIENTOS -->
<div class="grid-resumen-movimientos" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 25px 0; max-width: 100%;">
    <div style="background-color: white; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #dee2e6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 14px;">üí∞ TOTAL INGRESOS</h4>
        <div style="font-size: 22px; font-weight: bold; color: #28a745; margin-bottom: 5px;" id="mov-total-income">$0</div>
        <div style="font-size: 12px; color: #6c757d;">Saldo inicial + Recargas</div>
    </div>
    
    <div style="background-color: white; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #dee2e6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 14px;">üí∏ TOTAL EGRESOS</h4>
        <div style="font-size: 22px; font-weight: bold; color: #dc3545; margin-bottom: 5px;" id="mov-total-expenses">$0</div>
        <div style="font-size: 12px; color: #6c757d;">Todos los gastos registrados</div>
    </div>
    
    <div style="background-color: white; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #dee2e6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 14px;">üìä GANANCIA REAL</h4>
        <div style="font-size: 22px; font-weight: bold; margin-bottom: 5px;" id="mov-net-balance">$0</div>
        <div style="font-size: 12px; color: #6c757d;">Capital real - Egresos</div>
    </div>
</div>

<!-- SEPARADOR VISUAL -->
<div style="margin: 30px 0; border-bottom: 2px solid #e9ecef;"></div>
                
                <!-- HISTORIAL DE MOVIMIENTOS -->
                <div class="section">
                    <div class="section-title">üìã HISTORIAL DE MOVIMIENTOS</div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;" id="mov-filter-type" onchange="filterMovements()">
                            <option value="">Todos los tipos</option>
                            <option value="income">Solo ingresos</option>
                            <option value="expense">Solo egresos</option>
                        </select>
                        
                        <input type="number" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;" id="mov-filter-day" placeholder="D√≠a espec√≠fico" onchange="filterMovements()">
                        
                        <button class="btn btn-secondary" onclick="clearMovFilters()">üîÑ Limpiar Filtros</button>
                        <button class="btn btn-primary" onclick="exportMovements()">üìä Exportar</button>
                    </div>
                    
                    <table class="table" id="mov-table">
                        <thead>
                            <tr>
                                <th>D√≠a</th>
                                <th>Tipo</th>
                                <th>Categor√≠a</th>
                                <th>Monto</th>
                                <th>Descripci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="mov-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">
                                    No hay movimientos registrados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- SUB-TAB: EDICI√ìN DE D√çAS -->
             
                <!-- FORMULARIO DE EDICI√ìN -->
<div id="edicion-subtab" class="mov-content">
                <div class="section" style="background-color: #fff8f0; border-color: #fd7e14;">
                    <div class="section-title" style="color: #8a4a00;">‚úèÔ∏è EDITAR D√çA ESPEC√çFICO</div>
                    
                    <!-- FORMULARIO PRINCIPAL (2x2 GRID) -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="edit-day">D√≠a a Editar (1-90):</label>
                            <input type="number" id="edit-day" min="1" max="90" placeholder="Ej: 15" onchange="loadDayEditData()">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-reason">Motivo de la Edici√≥n:</label>
                            <select id="edit-reason" onchange="updateEditForm()">
                                <option value="">Seleccionar motivo...</option>
                                <option value="no-cobro">No se cobr√≥ ganancia</option>
                                <option value="cobro-parcial">Cobro parcial</option>
                                <option value="error-calculo">Error en c√°lculo</option>
                                <option value="ajuste-manual">Ajuste manual</option>
                                <option value="correccion">Correcci√≥n de datos</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-real-earnings">Ganancia Real del D√≠a:</label>
                            <input type="number" id="edit-real-earnings" min="0" step="0.01" placeholder="Ej: 1500">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-adjustment">Monto de Ajuste:</label>
                            <input type="number" id="edit-adjustment" step="0.01" placeholder="Ej: 0">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="edit-notes">Notas de la Edici√≥n:</label>
                        <textarea id="edit-notes" placeholder="Describe el motivo de la edici√≥n..." style="resize: vertical; min-height: 80px;"></textarea>
                    </div>
                    
                    
                    <!-- COMPARACI√ìN ANTES/DESPU√âS (ESTILO VISTA PREVIA) -->
                    <div style="background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <div style="font-weight: bold; color: #1976d2; margin-bottom: 10px;">üîç COMPARACI√ìN ANTES/DESPU√âS</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #bbdefb;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">Ganancia Original</div>
                                <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="edit-original-earnings">$0</div>
                                <div style="font-size: 10px; color: #999; margin-top: 4px;">Calculada autom√°ticamente</div>
                            </div>
                            <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #bbdefb;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">Ganancia Real</div>
                                <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="edit-real-earnings-display">$0</div>
                                <div style="font-size: 10px; color: #999; margin-top: 4px;">Ganancia + Ajuste</div>
                            </div>
                            <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #bbdefb;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">Diferencia</div>
                                <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="edit-earnings-difference">$0</div>
                                <div style="font-size: 10px; color: #999; margin-top: 4px;">Impacto del cambio</div>
                            </div>
                            <div style="background-color: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #bbdefb;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">Nuevo Saldo</div>
                                <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="edit-new-balance">$0</div>
                                <div style="font-size: 10px; color: #999; margin-top: 4px;">Balance resultante</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BOTONES DE ACCI√ìN (CENTRADOS) -->
                    <div class="text-center" style="margin-top: 20px;">
                        <button class="btn btn-warning" onclick="applyDayEdit()">
                            ‚úèÔ∏è APLICAR EDICI√ìN
                        </button>
                        <button class="btn btn-secondary" onclick="clearEditForm()">
                            üîÑ LIMPIAR FORMULARIO
                        </button>
                        <button class="btn btn-danger" onclick="undoLastEdit()">
                            ‚Ü©Ô∏è DESHACER √öLTIMA EDICI√ìN
                        </button>
                    </div>
                    
                    <div id="edit-alerts"></div>
                </div>
                
                <!-- HISTORIAL DE EDICIONES -->
                <div class="section">
                    <div class="section-title">üìù HISTORIAL DE EDICIONES</div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
    <select style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;" id="edit-filter-reason" onchange="filterEditions()">
        <option value="">Todos los motivos</option>
        <option value="no-cobro">No se cobr√≥</option>
        <option value="cobro-parcial">Cobro parcial</option>
        <option value="error-calculo">Error de c√°lculo</option>
        <option value="ajuste-manual">Ajuste manual</option>
    </select>
    
    <input type="number" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;" id="edit-filter-day" placeholder="D√≠a espec√≠fico" min="1" max="90" onchange="filterEditions()">
    
    <select style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;" id="edit-filter-impact" onchange="filterEditions()">
        <option value="">Todos los impactos</option>
        <option value="positive">Solo positivos</option>
        <option value="negative">Solo negativos</option>
        <option value="neutral">Solo neutros</option>
        <option value="significant">Solo significativos</option>
    </select>
    
    <button class="btn btn-secondary" onclick="clearEditFilters()">üîÑ Limpiar Filtros</button>
    <button class="btn btn-primary" onclick="exportEditions()">üìä Exportar</button>
</div>
                    
                    <table class="table" id="edit-table">
                        <thead>
                            <tr>
                                <th>D√≠a</th>
                                <th>Motivo</th>
                                <th>Ganancia Original</th>
                                <th>Ganancia Real</th>
                                <th>Diferencia</th>
                                <th>Notas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="edit-tbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px; color: #6c757d;">
                                    No hay ediciones registradas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
    
            

    <script>
        // =====================================================
// VIVABOX SISTEMA - PARTE 6 CORREGIDA
// Funciones Base y Estructura Principal
// =====================================================

// Variables globales del sistema - CORREGIDAS
let systemConfig = {
    initialBalance: 0,
    startDate: new Date(),
    userName: '',
    currentDay: 1
};

let boxes = [];
let additionalMovements = [];
let dayEditions = [];
let dailyBalances = [];
// Variables globales para control de rangos - INICIALIZACI√ìN CORREGIDA
window.automationRange = 1;
window.controlRange = 1;

// Cat√°logo de cajas - VERIFICADO
const boxCatalog = {
    basica: { price: 200, earning: 10, name: 'Caja B√°sica' },
    estandar: { price: 700, earning: 35, name: 'Caja Est√°ndar' },
    avanzada: { price: 1800, earning: 90, name: 'Caja Avanzada' },
    premium: { price: 5500, earning: 330, name: 'Caja Premium' },
    promocional: { price: 0, earning: 35, name: 'Caja Promocional' },
    vip: { price: 19000, earning: 1140, name: 'Caja VIP' }
};

// Categor√≠as de movimientos - VERIFICADO
const movementCategories = {
    income: {
        recarga: 'Recarga de fondos',
        //venta: 'Venta adicional',
        bonus: 'Bonificaci√≥n',
        regalo: 'Regalo/Premio',
        //prestamo: 'Pr√©stamo recibido',
        otros: 'Otros ingresos'
    },
    expense: {
        //comida: 'Gastos de comida',
        Retiro: 'Retiro',
        //emergencia: 'Emergencia',
        prestamo_pago: 'Pago de pr√©stamo',
        otros: 'Otros gastos'
    }
};

// =====================================================
// FUNCI√ìN AUXILIAR PARA FECHAS SIN ZONA HORARIA
// =====================================================

function createDateWithoutTimezone(dateString) {
    try {
        if (!dateString) return new Date();
        
        // Si es un string de input date (YYYY-MM-DD)
        if (typeof dateString === 'string' && dateString.includes('-')) {
            const parts = dateString.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // Enero es 0
            const day = parseInt(parts[2]);
            return new Date(year, month, day);
        }
        
        // Si ya es una fecha, crear una nueva sin zona horaria
        if (dateString instanceof Date) {
            return new Date(dateString.getFullYear(), dateString.getMonth(), dateString.getDate());
        }
        
        return new Date(dateString);
    } catch (error) {
        console.error('Error en createDateWithoutTimezone:', error);
        return new Date();
    }
}

function formatDateDisplay(date, includeYear = true) {
    try {
        if (!date || !(date instanceof Date)) return '[FECHA]';
        
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        
        if (includeYear) {
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        } else {
            return `${day}/${month}`;
        }
    } catch (error) {
        console.error('Error en formatDateDisplay:', error);
        return '[ERROR]';
    }
}

// =====================================================
// FUNCIONES DE NAVEGACI√ìN - CORREGIDAS
// =====================================================

function switchMainTab(tabName) {
    try {
        // PASO 1: Ocultar TODAS las pesta√±as forzadamente
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none'; // Forzar ocultaci√≥n
        });
        
        // PASO 2: Remover clase active de todos los botones
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // PASO 3: Mostrar SOLO la pesta√±a seleccionada
        const selectedTab = document.getElementById(tabName + '-tab');
        if (selectedTab) {
            selectedTab.classList.add('active');
            selectedTab.style.display = 'block'; // Forzar visualizaci√≥n
        }
        
        // PASO 4: Marcar el bot√≥n como activo
        const activeButton = Array.from(document.querySelectorAll('.tab-button'))
            .find(btn => btn.textContent.includes(getTabDisplayName(tabName)));
        if (activeButton) {
            activeButton.classList.add('active');
        }
        
        // PASO 5: Actualizar datos seg√∫n la pesta√±a
        updateTabData(tabName);
        
        logMessage(`üìã Cambiado a pesta√±a: ${tabName}`);
    } catch (error) {
        console.error('Error en switchMainTab:', error);
    }
}

function getTabDisplayName(tabName) {
    const tabNames = {
        'configuracion': 'Configuraci√≥n',
        'control': 'Control Diario',
        'registro': 'Registro de Cajas',
        'automatizacion': 'Automatizaci√≥n',
        'movimientos': 'Movimientos'
    };
    return tabNames[tabName] || tabName;
}

function switchMovTab(subtabName) {
    try {
        logMessage(`üìù Intentando cambiar a sub-pesta√±a: ${subtabName}`);
        
        // Manejar contenido de adicionales
        const adicionalesTab = document.getElementById('adicionales-subtab');
        const edicionContent = document.getElementById('edicion-subtab');
        
        // Limpiar estados activos de botones
        document.querySelectorAll('.mov-tab').forEach(tab => {
            tab.classList.remove('active');
            tab.style.backgroundColor = 'transparent';
            tab.style.color = '#6c757d';
            tab.style.fontWeight = 'bold';
        });
        
        if (subtabName === 'adicionales') {
    // Mostrar adicionales, ocultar edici√≥n
    if (adicionalesTab) {
        adicionalesTab.classList.add('active');
        adicionalesTab.style.display = 'block';
        adicionalesTab.style.visibility = 'visible';
    }
    if (edicionContent) {
        edicionContent.classList.remove('active');
        edicionContent.style.display = 'none';
        edicionContent.style.visibility = 'hidden';
    }
            
            // Activar bot√≥n adicionales
            const btnAdicionales = document.getElementById('btn-adicionales');
            if (btnAdicionales) {
                btnAdicionales.classList.add('active');
                btnAdicionales.style.backgroundColor = '#667eea';
                btnAdicionales.style.color = 'white';
            }
            
        } else if (subtabName === 'edicion') {
    // Ocultar adicionales, mostrar edici√≥n
    if (adicionalesTab) {
        adicionalesTab.classList.remove('active');
        adicionalesTab.style.display = 'none';
        adicionalesTab.style.visibility = 'hidden';
        // Forzar ocultaci√≥n de contenido interno
        adicionalesTab.style.setProperty('display', 'none', 'important');
    }
    if (edicionContent) {
        edicionContent.classList.add('active');
        edicionContent.style.display = 'block';
        edicionContent.style.visibility = 'visible';
    }
            
            // Activar bot√≥n edici√≥n
            const btnEdicion = document.getElementById('btn-edicion');
            if (btnEdicion) {
                btnEdicion.classList.add('active');
                btnEdicion.style.backgroundColor = '#667eea';
                btnEdicion.style.color = 'white';
            }
        // AGREGAR estas l√≠neas al final del bloque de edici√≥n:
    setTimeout(() => {
        setupEditFormListeners();
    }, 200);
}
        
        
        logMessage(`‚úÖ Cambio completado a sub-pesta√±a: ${subtabName}`);
        
    } catch (error) {
        console.error('Error en switchMovTab:', error);
        logMessage(`‚ùå Error al cambiar a sub-pesta√±a: ${subtabName}`);
    }
}

// INICIALIZACI√ìN AUTOM√ÅTICA DE LISTENERS DE EDICI√ìN
document.addEventListener('DOMContentLoaded', function() {
    // Configurar listeners despu√©s de que la p√°gina cargue
    setTimeout(() => {
        setupEditFormListeners();
        logMessage('üîß Event listeners de edici√≥n inicializados autom√°ticamente');
    }, 2000);
});

// TAMBI√âN configurar cuando se cambie a la pesta√±a de movimientos
function forceSetupEditListeners() {
    setTimeout(() => {
        setupEditFormListeners();
        logMessage('üîß Event listeners de edici√≥n reconfigurados');
    }, 500);
}

// =====================================================
// FUNCIONES DE CONFIGURACI√ìN - CORREGIDAS
// =====================================================

function updateSystemConfig() {
    try {
        const saldoInput = document.getElementById('saldo-inicial');
        const nombreInput = document.getElementById('nombre-usuario');
        const fechaInput = document.getElementById('fecha-inicio');
        
        if (saldoInput) {
            systemConfig.initialBalance = parseInt(saldoInput.value) || 0;
        }
        if (nombreInput) {
            systemConfig.userName = nombreInput.value || '';
        }
        if (fechaInput && fechaInput.value) {
            systemConfig.startDate = createDateWithoutTimezone(fechaInput.value);
        }
        
        updateConfigDisplay();
        updateAllCalculations();
        logMessage('‚öôÔ∏è Configuraci√≥n del sistema actualizada');
    } catch (error) {
        console.error('Error en updateSystemConfig:', error);
    }
}

function updateConfigDisplay() {
    try {
        // Actualizar displays en control diario
        const displayFecha = document.getElementById('display-fecha-inicio');
        const displayNombre = document.getElementById('display-nombre');
        const displaySaldo = document.getElementById('display-saldo');
        
        if (displayFecha && systemConfig.startDate) {
            displayFecha.textContent = systemConfig.startDate.toLocaleDateString('es-ES');
        }
        if (displayNombre) {
            displayNombre.textContent = systemConfig.userName || '[CONFIGURAR]';
        }
        if (displaySaldo) {
            displaySaldo.textContent = systemConfig.initialBalance.toLocaleString();
        }
    } catch (error) {
        console.error('Error en updateConfigDisplay:', error);
    }
}

function exportConfig() {
    try {
        const configData = {
            configuracion: systemConfig,
            timestamp: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(configData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `vivabox_config_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(url);
        
        showAlert('config-alerts', 'üíæ Configuraci√≥n exportada exitosamente', 'success');
        logMessage('üíæ Configuraci√≥n exportada');
    } catch (error) {
        console.error('Error en exportConfig:', error);
        showAlert('config-alerts', 'Error al exportar configuraci√≥n', 'error');
    }
}

// =====================================================
// FUNCIONES DE CONTROL DIARIO - CORREGIDAS
// =====================================================

function updateControlDisplay() {
    try {
        updateDatesInCalendar();
        calculateAndDisplayBalances();
    } catch (error) {
        console.error('Error en updateControlDisplay:', error);
    }
}

function updateDatesInCalendar() {
    try {
        if (!systemConfig.startDate) return;
        
        for (let day = 1; day <= 30; day++) {
            const currentDate = createDateWithoutTimezone(systemConfig.startDate);
            currentDate.setDate(currentDate.getDate() + day - 1);
            
            const dateElement = document.getElementById(`date-${day}`);
            if (dateElement) {
                const formatDate = formatDateDisplay(currentDate, false);
                dateElement.textContent = formatDate;
            }
        }
    } catch (error) {
        console.error('Error en updateDatesInCalendar:', error);
    }
}

function calculateAndDisplayBalances() {
    try {
        let currentBalance = systemConfig.initialBalance;
        
        for (let day = 1; day <= 30; day++) {
            let dayEarnings = 0;
            let dayExpenses = 0;
            let operations = [];
            
            // MODIFICACI√ìN: Calcular ganancias de TODAS las cajas (sin restricci√≥n de d√≠a actual)
            boxes.forEach(box => {
                // Eliminar verificaci√≥n de status y d√≠a actual - procesar TODAS las cajas
                if (day >= box.purchaseDay && day <= box.expiryDay) {
                    dayEarnings += box.dailyEarning;
                }
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                    operations.push(`üì¶ ${box.name.substring(0, 8)}...`);
                }
            });
            
            // Calcular movimientos adicionales del d√≠a
            const dayMovements = additionalMovements.filter(m => m.day === day);
            dayMovements.forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                    operations.push(`üí∞ +${movement.amount}`);
                } else {
                    dayExpenses += movement.amount;
                    operations.push(`üí∏ -${movement.amount}`);
                }
            });
            
            // Aplicar ediciones de d√≠as si existen
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
                operations.push(`‚úèÔ∏è Editado`);
            }
            
            // Generar operaciones para mostrar
            if (day === 1) {
                operations.unshift(`Inicial: $${currentBalance.toLocaleString()}`);
            } else {
                operations.unshift(`Anterior: $${currentBalance.toLocaleString()}`);
            }
            
            if (dayEarnings > 0) {
                operations.push(`+$${dayEarnings.toLocaleString()}`);
            }
            if (dayExpenses > 0) {
                operations.push(`-$${dayExpenses.toLocaleString()}`);
            }
            
            // Calcular nuevo balance
            currentBalance = currentBalance + dayEarnings - dayExpenses;
            
            // Actualizar elementos del DOM
            const totalElement = document.getElementById(`total-${day}`);
            const opsElement = document.getElementById(`ops-${day}`);
            
            if (totalElement) {
                totalElement.textContent = `$${currentBalance.toLocaleString()}`;
                // Aplicar color seg√∫n el balance
                if (currentBalance >= 0) {
                    totalElement.style.color = '#1976D2';
                } else {
                    totalElement.style.color = '#d32f2f';
                }
            }
            
            if (opsElement) {
                if (operations.length > 2) {
                    opsElement.textContent = operations.slice(1, 3).join(' ');
                } else {
                    opsElement.textContent = operations.slice(1).join(' ') || 'Sin operaciones';
                }
            }
            
            // MODIFICACI√ìN: Aplicar alertas para vencimientos SIN restricci√≥n de d√≠a actual
            const calcElement = document.getElementById(`calc-${day}`);
            const hasExpiry = boxes.some(box => box.expiryDay === day);
            if (calcElement) {
                if (hasExpiry) {
                    calcElement.classList.add('alert');
                    if (opsElement) {
                        opsElement.textContent = '‚ö†Ô∏è VENCE CAJA';
                        opsElement.style.color = '#c62828';
                    }
                } else {
                    calcElement.classList.remove('alert');
                }
            }
            
            // Guardar balance diario para referencia
            dailyBalances[day] = currentBalance;
        }
    } catch (error) {
        console.error('Error en calculateAndDisplayBalances:', error);
    }
}

function recalculateControl() {
    try {
        updateControlDisplay();
        showAlert('control-alerts', 'üîÑ Control diario recalculado', 'success');
        logMessage('üîÑ Control diario recalculado');
    } catch (error) {
        console.error('Error en recalculateControl:', error);
    }
}

function printControl() {
    try {
        generarImpresionProfesional();
        logMessage('üñ®Ô∏è Generando impresi√≥n profesional del calendario');
    } catch (error) {
        console.error('Error en printControl:', error);
    }
}

function generarImpresionProfesional() {
    try {
        // Crear ventana de impresi√≥n con timestamp √∫nico
        const timestamp = Date.now();
        const ventanaImpresion = window.open('', `vivabox_print_${timestamp}`, 'width=1200,height=800');
        
        // Generar contenido HTML para impresi√≥n
        const contenidoHTML = generarHTMLImpresion();
        
        // Escribir contenido en la nueva ventana
        ventanaImpresion.document.write(contenidoHTML);
        ventanaImpresion.document.close();
        
        // Esperar a que cargue y luego imprimir
        ventanaImpresion.onload = function() {
            ventanaImpresion.print();
            ventanaImpresion.close();
        };
        
    } catch (error) {
        console.error('Error en generarImpresionProfesional:', error);
        alert('Error al generar la impresi√≥n profesional');
    }
}

function generarHTMLImpresion() {
    try {
        // Informaci√≥n del encabezado
        const fechaImpresion = new Date().toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const fechaInicio = systemConfig.startDate ? 
            formatDateDisplay(systemConfig.startDate, true) : 'No establecida';
        
        const usuario = systemConfig.userName || 'No especificado';
        const saldoInicial = systemConfig.initialBalance || 0;
        const balanceActual = calculateCurrentBalance();
        const cajasActivas = boxes.filter(box => box.status === 'active').length;
        const gananciasDiarias = boxes.filter(box => box.status === 'active')
            .reduce((sum, box) => sum + box.dailyEarning, 0);
        
        const timestamp = Date.now();
        let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Control de Inversi√≥n VIVABOX - ${timestamp}</title>
    <style>
        /* Version ${timestamp} - Forzar actualizaci√≥n */
        @page { 
            size: landscape; 
            margin: 10mm; 
        }
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            font-size: 9px;
            color: #000;
        }
        .page { 
            page-break-after: always; 
            width: 100%; 
            height: 95vh;
        }
        .page:last-child { 
            page-break-after: avoid; 
        }
        .header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }
        .header h1 {
            margin: 0 0 3px 0;
            font-size: 14px;
            font-weight: bold;
        }
        .header-info {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 8px;
        }
        .range-title {
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
            padding: 3px;
            background-color: #f0f0f0;
            border: 1px solid #000;
        }
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
            font-size: 7px;
        }
        .calendar-table td {
            border: 1px solid #000;
            padding: 2px;
            text-align: center;
            vertical-align: top;
            width: 16.66%;
        }
        .day-header {
    background-color: #e0e0e0;
    font-weight: bold;
    font-size: 14px;
    height: 35px;
    padding: 2px;
}
.date-cell {
    background-color: #f5f5f5;
    font-size: 12px;
    font-weight: bold;
    height: 20px;
    padding: 2px;
}
.calc-cell {
    font-size: 10px !important;
    line-height: 1.2 !important;
    height: 80px !important;
    padding: 3px !important;
    min-height: 80px !important;
}
        .calc-cell.alert {
            background-color: #d0d0d0;
            font-weight: bold;
        }
        .footer {
            margin-top: 8px;
            padding-top: 4px;
            border-top: 1px solid #000;
            font-size: 7px;
            display: flex;
            justify-content: space-between;
        }
        .summary-box {
            border: 1px solid #000;
            padding: 3px;
            margin: 2px 0;
            background-color: #f9f9f9;
            font-size: 6px;
        }
    </style>
</head>
<body>`;

        // Generar las 3 p√°ginas
        for (let rango = 1; rango <= 3; rango++) {
            const startDay = (rango - 1) * 30 + 1;
            const endDay = Math.min(rango * 30, 90);
            
            html += `
    <div class="page">
        <div class="header">
            <h1>CONTROL DE INVERSI√ìN EN CAJAS - VIVABOX</h1>
            <div class="header-info">
                <span><strong>USUARIO:</strong> ${usuario}</span>
                <span><strong>FECHA INICIO:</strong> ${fechaInicio}</span>
                <span><strong>SALDO INICIAL:</strong> $${saldoInicial.toLocaleString()}</span>
                <span><strong>IMPRESO:</strong> ${fechaImpresion}</span>
            </div>
        </div>
        
        <div class="range-title">D√çAS ${startDay} - ${endDay}</div>
        
        ${generarTablaRango(startDay, endDay)}
        
        <div class="footer">
            <div class="summary-box">
                <strong>RESUMEN AL D√çA ${endDay}:</strong><br>
                Balance Actual: $${balanceActual.toLocaleString()}<br>
                Cajas Activas: ${cajasActivas}<br>
                Ganancias Diarias: $${gananciasDiarias.toLocaleString()}
            </div>
            <div class="summary-box">
                <strong>P√ÅGINA ${rango} DE 3</strong><br>
                Sistema VIVABOX v1.0<br>
                Generado autom√°ticamente
            </div>
        </div>
    </div>`;
        }

        html += `
</body>
</html>`;

        return html;
        
    } catch (error) {
        console.error('Error en generarHTMLImpresion:', error);
        return '<html><body><h1>Error al generar impresi√≥n</h1></body></html>';
    }
}

function generarTablaRango(startDay, endDay) {
    try {
        let runningBalance = systemConfig.initialBalance;
        
        // Calcular balance hasta el d√≠a de inicio
        for (let day = 1; day < startDay; day++) {
            let dayEarnings = 0;
            let dayExpenses = 0;
            
            boxes.forEach(box => {
                if (day >= box.purchaseDay && day <= box.expiryDay) {
                    dayEarnings += box.dailyEarning;
                }
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                }
            });
            
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                } else {
                    dayExpenses += movement.amount;
                }
            });
            
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
            }
            
            runningBalance += dayEarnings - dayExpenses;
        }
        
        let tabla = '<table class="calendar-table">';
        
        // Generar tabla en filas de 6 d√≠as
        for (let fila = 0; fila < 5; fila++) {
            const primeraColumna = startDay + fila * 6;
            const ultimaColumna = Math.min(primeraColumna + 5, endDay);
            
            if (primeraColumna > endDay) break;
            
            // Fila de headers
            tabla += '<tr>';
            for (let col = primeraColumna; col <= ultimaColumna; col++) {
                tabla += `<td class="day-header">D√çA ${col}</td>`;
            }
            tabla += '</tr>';
            
            // Fila de fechas
            tabla += '<tr>';
            for (let col = primeraColumna; col <= ultimaColumna; col++) {
                const currentDate = createDateWithoutTimezone(systemConfig.startDate);
                currentDate.setDate(currentDate.getDate() + col - 1);
                const fechaFormato = formatDateDisplay(currentDate, false);
                tabla += `<td class="date-cell">${fechaFormato}</td>`;
            }
            tabla += '</tr>';
            
            // Fila de c√°lculos
            tabla += '<tr>';
            for (let col = primeraColumna; col <= ultimaColumna; col++) {
                let dayEarnings = 0;
                let dayExpenses = 0;
                let operations = [];
                
                boxes.forEach(box => {
                    if (col >= box.purchaseDay && col <= box.expiryDay) {
                        dayEarnings += box.dailyEarning;
                    }
                    if (col === box.purchaseDay) {
                        dayExpenses += box.pricePaid;
                        operations.push(`Caja: ${box.name.substring(0, 10)}`);
                    }
                });
                
                additionalMovements.filter(m => m.day === col).forEach(movement => {
                    if (movement.type === 'income') {
                        dayEarnings += movement.amount;
                        operations.push(`+$${movement.amount}`);
                    } else {
                        dayExpenses += movement.amount;
                        operations.push(`-$${movement.amount}`);
                    }
                });
                
                const dayEdit = dayEditions.find(e => e.day === col);
                if (dayEdit) {
                    dayEarnings = dayEdit.finalEarnings || dayEarnings;
                    operations.push('Editado');
                }
                
                runningBalance += dayEarnings - dayExpenses;
                
                const hasExpiry = boxes.some(box => box.expiryDay === col);
                const cellClass = hasExpiry ? 'calc-cell alert' : 'calc-cell';
                
                const operationsText = hasExpiry ? 'VENCE CAJA' : 
                    (operations.length > 0 ? operations.slice(0, 2).join(' ') : 'Normal');
                
                tabla += `<td style="border: 1px solid #000; padding: 2px; text-align: center; vertical-align: top; width: 16.66%; height: 50px; min-height: 50px; background-color: ${hasExpiry ? '#d0d0d0' : 'white'}; font-size: 6px; line-height: 1.1;">
                    <div style="font-weight: bold; font-size: 16px; margin: 3px 0;">$${runningBalance.toLocaleString()}</div>
<div style="font-size: 12px; margin: 2px 0;">${operationsText}</div>
                </td>`;
            }
            tabla += '</tr>';
        }
        
        tabla += '</table>';
        return tabla;
        
    } catch (error) {
        console.error('Error en generarTablaRango:', error);
        return '<p>Error al generar tabla</p>';
    }
}

// =====================================================
// FUNCIONES DE ACTUALIZACI√ìN DE PESTA√ëAS - CORREGIDAS
// =====================================================

function initializeMovementSubtabs() {
    try {
        logMessage('üîß Inicializando sub-pesta√±as de movimientos...');
        
        // 1. LIMPIAR todos los estilos inline primero
        const adicionalesTab = document.getElementById('adicionales-subtab');
        const edicionTab = document.getElementById('edicion-subtab');
        
        if (adicionalesTab) {
            adicionalesTab.removeAttribute('style'); // ELIMINAR estilos inline
            adicionalesTab.classList.add('active');
            logMessage('‚úÖ Sub-pesta√±a adicionales activada (sin estilos inline)');
        }
        
        if (edicionTab) {
            edicionTab.removeAttribute('style'); // ELIMINAR estilos inline
            edicionTab.classList.remove('active');
            logMessage('‚úÖ Sub-pesta√±a edicion desactivada (sin estilos inline)');
        }
        
        // 2. Configurar botones (estos S√ç pueden usar estilos inline)
        const btnAdicionales = document.getElementById('btn-adicionales');
        const btnEdicion = document.getElementById('btn-edicion');
        
        if (btnAdicionales) {
            btnAdicionales.classList.add('active');
            btnAdicionales.style.backgroundColor = '#667eea';
            btnAdicionales.style.color = 'white';
            btnAdicionales.style.fontWeight = 'bold';
        }
        
        if (btnEdicion) {
            btnEdicion.classList.remove('active');
            btnEdicion.style.backgroundColor = 'transparent';
            btnEdicion.style.color = '#6c757d';
            btnEdicion.style.fontWeight = 'bold';
        }
        
        logMessage('‚úÖ Sub-pesta√±as de movimientos inicializadas correctamente sin estilos inline');
        
    } catch (error) {
        console.error('Error en initializeMovementSubtabs:', error);
    }
}

// FUNCI√ìN ACTUALIZADA updateTabData (REEMPLAZAR LA EXISTENTE)
function updateTabData(tabName) {
    try {
        switch(tabName) {
            case 'configuracion':
                updateConfigDisplay();
                break;
            case 'control':
                updateControlDisplay();
                break;
            case 'registro':
                updateRegistroDisplay();
                break;
            case 'automatizacion':
                updateAutomatizacionDisplay();
                setTimeout(() => forceUpdateAutomation(), 500);
                break;
            case 'movimientos':
    updateMovimientosDisplay();
    setTimeout(() => {
        initializeMovementSubtabs();
        forceSetupEditListeners(); // AGREGAR esta l√≠nea
    }, 200);
    break;
            default:
                console.warn(`Pesta√±a no reconocida: ${tabName}`);
        }
    } catch (error) {
        console.error(`Error en updateTabData para ${tabName}:`, error);
    }
}

// =====================================================
// FUNCIONES AUXILIARES - CORREGIDAS
// =====================================================

function logMessage(message) {
    try {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`[${timestamp}] ${message}`);
        
    } catch (error) {
        console.error('Error en logMessage:', error);
    }
}

function showAlert(containerId, message, type = 'info') {
    try {
        const container = document.getElementById(containerId);
        if (!container) {
            console.warn(`Container ${containerId} no encontrado`);
            return;
        }
        
        const alertClass = `alert-${type}`;
        container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        
        setTimeout(() => {
            if (container) {
                container.innerHTML = '';
            }
        }, 5000);
    } catch (error) {
        console.error('Error en showAlert:', error);
    }
}

function updateAllCalculations() {
    try {
        updateConfigDisplay();
        updateControlDisplay();
        updateRegistroDisplay();
        updateAutomatizacionDisplay();
        updateMovimientosDisplay();
        // CORRECCI√ìN: Forzar rec√°lculo de balances diarios si est√°n vac√≠os
if (dailyBalances.length === 0) {
    recalculateDailyBalances();
}

logMessage('üîÑ Todos los c√°lculos actualizados');
    } catch (error) {
        console.error('Error en updateAllCalculations:', error);
    }
}

// NUEVA FUNCI√ìN: Recalcular balances diarios
function recalculateDailyBalances() {
    try {
        dailyBalances = [];
        let runningBalance = systemConfig.initialBalance;
        
        for (let day = 1; day <= 90; day++) {
            let dayEarnings = 0;
            let dayExpenses = 0;
            
            // Procesar todas las cajas
            boxes.forEach(box => {
                if (day >= box.purchaseDay && day <= box.expiryDay) {
                    dayEarnings += box.dailyEarning;
                }
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                }
            });
            
            // Procesar movimientos adicionales
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                } else {
                    dayExpenses += movement.amount;
                }
            });
            
            // Aplicar ediciones
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
            }
            
            runningBalance = runningBalance + dayEarnings - dayExpenses;
            dailyBalances[day] = Math.round(runningBalance);
        }
        
        logMessage('üìä Balances diarios recalculados exitosamente');
    } catch (error) {
        console.error('Error en recalculateDailyBalances:', error);
    }
}

// =====================================================
// FUNCIONES PLACEHOLDER - SE COMPLETAR√ÅN EN PARTE 7
// =====================================================

// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7A
// FUNCIONES DE REGISTRO DE CAJAS - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// FUNCIONES DE MANEJO DE PRECIOS Y FORMULARIO
// =====================================================

function updateBoxPrices() {
    try {
        const select = document.getElementById('reg-tipo-caja');
        if (!select) return;
        
        const selectedValue = select.value;
        
        // Si selecciona "Caja Especial", abrir modal
        if (selectedValue === 'especial') {
            mostrarModalCajaEspecial();
            return;
        }
        
        const option = select.selectedOptions[0];
        
        if (option && option.dataset.precio) {
            const precio = parseInt(option.dataset.precio);
            document.getElementById('reg-precio-original').textContent = `$${precio.toLocaleString()}`;
            calculateBoxFinalPrice();
        } else {
            document.getElementById('reg-precio-original').textContent = '$0';
            document.getElementById('reg-descuento-monto').textContent = '$0';
            document.getElementById('reg-precio-final').textContent = '$0';
        }
    } catch (error) {
        console.error('Error en updateBoxPrices:', error);
    }
}

// Funciones b√°sicas para el modal
function mostrarModalCajaEspecial() {
    const modal = document.getElementById('modal-caja-especial');
    if (modal) {
        modal.style.display = 'flex';
    }
}

function cerrarModalCajaEspecial() {
    const modal = document.getElementById('modal-caja-especial');
    if (modal) {
        modal.style.display = 'none';
        // Resetear el dropdown
        document.getElementById('reg-tipo-caja').value = '';
        updateBoxPrices();
    }
}

// Funci√≥n para actualizar vista previa en tiempo real
function actualizarVistaPreviaCajaEspecial() {
    try {
        const precio = parseFloat(document.getElementById('especial-precio').value) || 0;
        const ganancia = parseFloat(document.getElementById('especial-ganancia').value) || 0;
        const duracion = parseInt(document.getElementById('especial-duracion').value) || 0;
        const diaCompra = parseInt(document.getElementById('especial-dia-compra').value) || 0;
        const descuento = parseFloat(document.getElementById('especial-descuento').value) || 0;
        
        // Calcular precio final
        const precioFinal = precio * (1 - descuento / 100);
        
        // Calcular ROI diario
        const roiDiario = precio > 0 ? ((ganancia / precio) * 100).toFixed(2) : 0;
        
        // Calcular d√≠a de vencimiento
        const diaVencimiento = diaCompra > 0 && duracion > 0 ? diaCompra + duracion - 1 : '--';
        
        // Actualizar vista previa
        document.getElementById('especial-preview-precio').textContent = `$${precioFinal.toLocaleString()}`;
        document.getElementById('especial-preview-roi').textContent = `${roiDiario}%`;
        document.getElementById('especial-preview-vencimiento').textContent = diaVencimiento > 90 ? 'Excede 90 d√≠as' : `D√≠a ${diaVencimiento}`;
        
        // Cambiar color si excede 90 d√≠as
        const vencimientoElement = document.getElementById('especial-preview-vencimiento');
        if (diaVencimiento > 90) {
            vencimientoElement.style.color = '#dc3545';
            vencimientoElement.style.fontWeight = 'bold';
        } else {
            vencimientoElement.style.color = '#495057';
            vencimientoElement.style.fontWeight = 'normal';
        }
        
    } catch (error) {
        console.error('Error en actualizarVistaPreviaCajaEspecial:', error);
    }
}

// Funci√≥n principal para crear la caja especial
function crearCajaEspecial() {
    try {
        // Obtener valores del formulario
        const nombre = document.getElementById('especial-nombre').value.trim();
        const precio = parseFloat(document.getElementById('especial-precio').value);
        const ganancia = parseFloat(document.getElementById('especial-ganancia').value);
        const duracion = parseInt(document.getElementById('especial-duracion').value);
        const diaCompra = parseInt(document.getElementById('especial-dia-compra').value);
        const descuento = parseFloat(document.getElementById('especial-descuento').value) || 0;
        
        // Validaciones
        if (!nombre || nombre.length < 3) {
            mostrarAlertaEspecial('‚ùå El nombre debe tener al menos 3 caracteres', 'error');
            return;
        }
        
        if (!precio || precio <= 0) {
            mostrarAlertaEspecial('‚ùå El precio debe ser mayor a 0', 'error');
            return;
        }
        
        if (!ganancia || ganancia < 0) {
            mostrarAlertaEspecial('‚ùå La ganancia diaria debe ser 0 o mayor', 'error');
            return;
        }
        
        if (!duracion || duracion < 1) {
            mostrarAlertaEspecial('‚ùå La duraci√≥n debe ser al menos 1 d√≠a', 'error');
            return;
        }
        
        if (!diaCompra || diaCompra < 1 || diaCompra > 90) {
            mostrarAlertaEspecial('‚ùå El d√≠a de compra debe estar entre 1 y 90', 'error');
            return;
        }
        
        if (descuento < 0 || descuento > 100) {
            mostrarAlertaEspecial('‚ùå El descuento debe estar entre 0% y 100%', 'error');
            return;
        }
        
        // Validar que no exceda 90 d√≠as
        const diaVencimiento = diaCompra + duracion - 1;
        if (diaVencimiento > 90) {
            const maxDuracion = 90 - diaCompra + 1;
            mostrarAlertaEspecial(`‚ùå La duraci√≥n excede el l√≠mite del sistema (D√≠a 90). Duraci√≥n m√°xima: ${maxDuracion} d√≠as`, 'error');
            return;
        }
        
        // Crear la caja especial
        const precioFinal = Math.round(precio * (1 - descuento / 100));
        
        const nuevaCajaEspecial = {
            id: Date.now() + Math.random(),
            type: 'especial',
            name: nombre,
            purchaseDay: diaCompra,
            duration: duracion,
            pricePaid: precioFinal,
            originalPrice: precio,
            discountPercent: descuento,
            discountAmount: precio - precioFinal,
            dailyEarning: ganancia,
            expiryDay: diaVencimiento,
            status: 'active',
            dateCreated: new Date().toISOString(),
            totalEarningsPotential: ganancia * duracion,
            roi: ((ganancia * duracion) / precioFinal * 100).toFixed(2),
            isSpecial: true // Marca para identificar cajas especiales
        };
        
        // Agregar al sistema
        boxes.push(nuevaCajaEspecial);
        
        // Actualizar displays
        updateRegistroDisplay();
        updateAllCalculations();
        
        // Mostrar confirmaci√≥n
        mostrarAlertaEspecial(
            `‚úÖ <strong>¬°Caja especial creada exitosamente!</strong><br>` +
            `üì¶ ${nombre}<br>` +
            `üí∞ Inversi√≥n: $${precioFinal.toLocaleString()}<br>` +
            `üìà Ganancia diaria: $${ganancia.toLocaleString()}<br>` +
            `üìÖ Per√≠odo: D√≠a ${diaCompra} - ${diaVencimiento}`, 'success');
        
        // Cerrar modal despu√©s de 2 segundos
        setTimeout(() => {
            cerrarModalCajaEspecial();
            limpiarFormularioCajaEspecial();
        }, 2000);
        
        logMessage(`‚≠ê Caja especial creada: ${nombre} - $${precioFinal} - D√≠as ${diaCompra}-${diaVencimiento}`);
        
    } catch (error) {
        console.error('Error en crearCajaEspecial:', error);
        mostrarAlertaEspecial('‚ùå Error interno al crear la caja especial', 'error');
    }
}

// Funci√≥n para mostrar alertas en el modal
function mostrarAlertaEspecial(mensaje, tipo) {
    const container = document.getElementById('especial-alerts');
    if (!container) return;
    
    const alertClass = `alert-${tipo}`;
    container.innerHTML = `<div class="alert ${alertClass}" style="margin-top: 10px;">${mensaje}</div>`;
    
    // Auto-limpiar despu√©s de 5 segundos (excepto para success)
    if (tipo !== 'success') {
        setTimeout(() => {
            container.innerHTML = '';
        }, 5000);
    }
}

// Funci√≥n para limpiar el formulario
function limpiarFormularioCajaEspecial() {
    const campos = ['especial-nombre', 'especial-precio', 'especial-ganancia', 
                   'especial-duracion', 'especial-dia-compra', 'especial-descuento'];
    
    campos.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (elemento) elemento.value = '';
    });
    
    // Limpiar vista previa
    document.getElementById('especial-preview-precio').textContent = '$0';
    document.getElementById('especial-preview-roi').textContent = '0%';
    document.getElementById('especial-preview-vencimiento').textContent = 'D√≠a --';
    
    // Limpiar alertas
    document.getElementById('especial-alerts').innerHTML = '';
}

function calculateBoxFinalPrice() {
    try {
        const precioOriginalText = document.getElementById('reg-precio-original').textContent;
        const precioOriginal = parseInt(precioOriginalText.replace(/[$,]/g, '')) || 0;
        const descuentoPct = parseFloat(document.getElementById('reg-descuento-pct').value) || 0;
        
        const descuentoMonto = Math.round(precioOriginal * descuentoPct / 100);
        const precioFinal = precioOriginal - descuentoMonto;
        
        document.getElementById('reg-descuento-monto').textContent = `$${descuentoMonto.toLocaleString()}`;
        document.getElementById('reg-precio-final').textContent = `$${precioFinal.toLocaleString()}`;
    } catch (error) {
        console.error('Error en calculateBoxFinalPrice:', error);
    }
}

function clearBoxForm() {
    try {
        const elements = ['reg-tipo-caja', 'reg-dia-compra', 'reg-duracion-dias', 'reg-descuento-pct'];
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        updateBoxPrices();
        logMessage('üîÑ Formulario de caja limpiado');
    } catch (error) {
        console.error('Error en clearBoxForm:', error);
    }
}

// =====================================================
// FUNCI√ìN PRINCIPAL - AGREGAR NUEVA CAJA
// =====================================================

function addNewBox() {
    try {
        const tipoCaja = document.getElementById('reg-tipo-caja').value;
        const diaCompra = parseInt(document.getElementById('reg-dia-compra').value);
        const duracion = parseInt(document.getElementById('reg-duracion-dias').value);
        const descuento = parseFloat(document.getElementById('reg-descuento-pct').value) || 0;
        
        // Validaciones exhaustivas
        if (!tipoCaja) {
            showAlert('reg-alerts', '‚ùå Debe seleccionar un tipo de caja', 'error');
            return;
        }
        
        if (!diaCompra || diaCompra < 1 || diaCompra > 90) {
            showAlert('reg-alerts', '‚ùå El d√≠a de compra debe estar entre 1 y 90', 'error');
            return;
        }
        
        if (!duracion || duracion < 1 || duracion > 365) {
            showAlert('reg-alerts', '‚ùå La duraci√≥n debe estar entre 1 y 365 d√≠as', 'error');
            return;
        }
        
        if (descuento < 0 || descuento > 100) {
            showAlert('reg-alerts', '‚ùå El descuento debe estar entre 0% y 100%', 'error');
            return;
        }
        
        // CORRECCI√ìN: Definir variables necesarias ANTES de usarlas
        const catalog = boxCatalog[tipoCaja];
        if (!catalog) {
            showAlert('reg-alerts', '‚ùå Tipo de caja no v√°lido', 'error');
            return;
        }
        
        const precioFinal = Math.round(catalog.price * (1 - descuento / 100));
        const expiryDay = diaCompra + duracion - 1;
        
        // Validar que el d√≠a de vencimiento no exceda los l√≠mites
        if (expiryDay > 90) {
            const maxDuration = 90 - diaCompra + 1;
            showAlert('reg-alerts', 
                `‚ùå La duraci√≥n excede el l√≠mite del sistema (D√≠a 90). ` +
                `Duraci√≥n m√°xima permitida: ${maxDuration} d√≠as`, 'error');
            return;
        }
        
        // MODIFICACI√ìN: Verificar si ya existe una caja del mismo tipo (activa o que vencer√° despu√©s del d√≠a de compra)
        const existingBox = boxes.find(box => 
            box.type === tipoCaja && 
            (box.status === 'active' || box.status === 'simulated') && 
            box.expiryDay >= diaCompra - 1  // Permitir extensi√≥n si vence el d√≠a anterior o despu√©s
        );

        if (existingBox) {
            // L√ìGICA MEJORADA: Determinar el tipo de extensi√≥n
            let extensionMessage = '';
            let newExpiryDay = 0;
            let totalDuration = 0;
            
            if (diaCompra <= existingBox.expiryDay) {
                // Caso 1: Compra durante la vigencia de la caja existente
                newExpiryDay = existingBox.expiryDay + duracion;
                totalDuration = existingBox.duration + duracion;
                extensionMessage = `La caja est√° activa hasta el d√≠a ${existingBox.expiryDay}.\n` +
                                  `Se extender√° por ${duracion} d√≠as adicionales.\n` +
                                  `Nueva duraci√≥n total: ${totalDuration} d√≠as (hasta el d√≠a ${newExpiryDay})`;
            } else if (diaCompra === existingBox.expiryDay + 1) {
                // Caso 2: Compra el d√≠a siguiente al vencimiento (renovaci√≥n inmediata)
                newExpiryDay = diaCompra + duracion - 1;
                totalDuration = existingBox.duration + duracion;
                extensionMessage = `La caja vence el d√≠a ${existingBox.expiryDay}.\n` +
                                  `Se renovar√° inmediatamente por ${duracion} d√≠as m√°s.\n` +
                                  `Nueva duraci√≥n total: ${totalDuration} d√≠as (hasta el d√≠a ${newExpiryDay})`;
            }
            
            const extendConfirm = confirm(
                `üîÑ EXTENSI√ìN AUTOM√ÅTICA DE CAJA\n\n` +
                `${catalog.name} existente detectada:\n` +
                `‚Ä¢ Comprada el d√≠a: ${existingBox.purchaseDay}\n` +
                `‚Ä¢ Vence el d√≠a: ${existingBox.expiryDay}\n` +
                `‚Ä¢ Duraci√≥n actual: ${existingBox.duration} d√≠as\n\n` +
                `Nueva compra el d√≠a ${diaCompra} por ${duracion} d√≠as:\n` +
                `${extensionMessage}\n\n` +
                `üí∞ Costo adicional: $${precioFinal.toLocaleString()}\n` +
                `üìà Ganancia diaria: $${catalog.earning.toLocaleString()} (sin cambios)\n\n` +
                `¬øConfirmar extensi√≥n autom√°tica?`
            );
            
            if (extendConfirm) {
    // APLICAR LA EXTENSI√ìN
    const previousDuration = existingBox.duration;
    const previousExpiryDay = existingBox.expiryDay;
    
    // SOLUCI√ìN: Crear una caja de extensi√≥n para registrar la nueva compra
    const extensionBox = {
        id: Date.now() + Math.random(), // ID √∫nico para la extensi√≥n
        type: tipoCaja,
        name: catalog.name + ' (Extensi√≥n)',
        purchaseDay: diaCompra,
        duration: duracion, // Solo los d√≠as de la extensi√≥n
        pricePaid: precioFinal,
        originalPrice: catalog.price,
        discountPercent: descuento,
        discountAmount: catalog.price - precioFinal,
        dailyEarning: 0, // La ganancia ya la genera la caja original
        expiryDay: diaCompra + duracion - 1, // Solo para referencia
        status: 'extension',
        dateCreated: new Date().toISOString(),
        isExtensionOf: existingBox.id, // Referencia a la caja original
        totalEarningsPotential: 0,
        roi: 0,
        extensionNote: `Extensi√≥n de ${duracion} d√≠as para ${existingBox.name}`
    };
    
    // Agregar la caja de extensi√≥n al sistema (para registrar el gasto)
    boxes.push(extensionBox);
    
    // Actualizar la caja original con la nueva duraci√≥n
    existingBox.duration = totalDuration;
    existingBox.expiryDay = newExpiryDay;
    
    // Actualizar costos acumulados en la caja original
    existingBox.totalInvestment = (existingBox.totalInvestment || existingBox.pricePaid) + precioFinal;
    existingBox.averageCostPerDay = existingBox.totalInvestment / existingBox.duration;
                
                // Registrar la extensi√≥n en el historial de la caja
                if (!existingBox.extensionHistory) {
                    existingBox.extensionHistory = [];
                }
                
                existingBox.extensionHistory.push({
                    date: new Date().toISOString(),
                    purchaseDay: diaCompra,
                    addedDays: duracion,
                    addedCost: precioFinal,
                    previousDuration: previousDuration,
                    newDuration: totalDuration,
                    previousExpiryDay: previousExpiryDay,
                    newExpiryDay: newExpiryDay
                });
                
                // Actualizar displays y rec√°lculos
                updateRegistroDisplay();
                updateAllCalculations();
                clearBoxForm();
                
                showAlert('reg-alerts', 
                    `üîÑ <strong>Caja extendida exitosamente</strong><br>` +
                    `üì¶ ${catalog.name}<br>` +
                    `‚è±Ô∏è Duraci√≥n: ${previousDuration} ‚Üí ${totalDuration} d√≠as (+${duracion})<br>` +
                    `üìÖ Vencimiento: D√≠a ${previousExpiryDay} ‚Üí ${newExpiryDay}<br>` +
                    `üí∞ Inversi√≥n adicional: $${precioFinal.toLocaleString()}<br>` +
                    `üíµ Inversi√≥n total acumulada: $${existingBox.totalInvestment.toLocaleString()}`, 'success');
                
                logMessage(`üîÑ Caja extendida: ${catalog.name} - ${previousDuration}‚Üí${totalDuration} d√≠as, inversi√≥n +$${precioFinal}`);
                
                return; // Salir de la funci√≥n sin crear caja nueva
            } else {
                // Si el usuario cancela, preguntar si quiere crear una caja nueva de todos modos
                const createNew = confirm(
                    `‚ùå Extensi√≥n cancelada.\n\n` +
                    `¬øQuieres crear una nueva ${catalog.name} por separado?\n\n` +
                    `‚ö†Ô∏è ADVERTENCIA: Esto significa que tendr√°s DOS cajas del mismo tipo\n` +
                    `generando ganancias simult√°neamente, lo cual puede no ser realista.\n\n` +
                    `¬øContinuar creando caja nueva?`
                );
                
                if (!createNew) {
                    showAlert('reg-alerts', '‚ö†Ô∏è Operaci√≥n cancelada por el usuario', 'warning');
                    return; // Salir sin hacer nada
                }
                // Si confirma crear nueva, contin√∫a con el flujo normal
            }
        }
        
        // Crear nueva caja (flujo normal cuando no hay extensi√≥n)
        // NOTA: Las variables catalog, precioFinal y expiryDay ya est√°n definidas arriba
        
        const newBox = {
            id: Date.now(),
            type: tipoCaja,
            name: catalog.name,
            purchaseDay: diaCompra,
            duration: duracion,
            pricePaid: precioFinal,
            originalPrice: catalog.price,
            discountPercent: descuento,
            discountAmount: catalog.price - precioFinal,
            dailyEarning: catalog.earning,
            expiryDay: expiryDay,
            status: 'active',
            dateCreated: new Date().toISOString(),
            totalEarningsPotential: catalog.earning * duracion,
            roi: ((catalog.earning * duracion) / precioFinal * 100).toFixed(2)
        };
        
        boxes.push(newBox);
        
        showAlert('reg-alerts', 
            `‚úÖ ${catalog.name} agregada exitosamente!\n` +
            `üìÖ Compra: D√≠a ${diaCompra} | Vencimiento: D√≠a ${expiryDay}\n` +
            `üí∞ Inversi√≥n: $${precioFinal.toLocaleString()} | Ganancia diaria: $${catalog.earning.toLocaleString()}`, 
            'success');
        
        updateRegistroDisplay();
        updateAllCalculations();
        clearBoxForm();
        
        logMessage(`üì¶ Nueva caja creada: ${catalog.name} - D√≠as ${diaCompra}-${expiryDay} - $${precioFinal}`);
        
    } catch (error) {
        console.error('Error en addNewBox:', error);
        showAlert('reg-alerts', '‚ùå Error interno al agregar la caja. Revisa la consola.', 'error');
    }
}

// =====================================================
// FUNCIONES DE ACTUALIZACI√ìN DE DISPLAYS
// =====================================================

function updateRegistroDisplay() {
    try {
        updateBoxesTable();
        updateRegistroSummary();
        updateExpiryAlerts();
        logMessage('üì¶ Display de registro actualizado completamente');
    } catch (error) {
        console.error('Error en updateRegistroDisplay:', error);
    }
}

function updateBoxesTable() {
    try {
        const tbody = document.getElementById('reg-boxes-tbody');
        if (!tbody) {
            console.warn('Tabla de cajas no encontrada');
            return;
        }
        
        tbody.innerHTML = '';
        
        // CORRECCI√ìN: Definir currentDay para evitar errores
        const currentDay = systemConfig.currentDay || 1;
        
        if (boxes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 30px; color: #6c757d; font-style: italic;">
                        üì¶ No hay cajas registradas<br>
                        <small>Agrega tu primera caja usando el formulario de arriba</small>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Ordenar cajas por d√≠a de compra
        const sortedBoxes = [...boxes].sort((a, b) => a.purchaseDay - b.purchaseDay);
        
        sortedBoxes.forEach(box => {
            const row = document.createElement('tr');
            
            // MODIFICACI√ìN: Determinar estado de la caja SIN concepto de "d√≠a actual"
let statusClass = 'success';
let statusText = 'SIMULADA';
let statusIcon = 'üéØ';

// Verificar si es una extensi√≥n
if (box.status === 'extension') {
    statusClass = 'warning';
    statusText = 'EXTENSI√ìN';
    statusIcon = 'üîó';
} else if (box.duration <= 0 || box.expiryDay < box.purchaseDay) {
    statusClass = 'danger';
    statusText = 'ERROR CONFIG';
    statusIcon = '‚ùå';
    box.status = 'error';
} else {
    // Todas las cajas est√°n en simulaci√≥n activa
    statusClass = 'info';
    statusText = 'EN SIMULACI√ìN';
    statusIcon = 'üéØ';
    box.status = 'simulated';
}
            
            if (box.expiryDay < currentDay) {
                statusClass = 'danger';
                statusText = 'VENCIDA';
                statusIcon = '‚ùå';
                box.status = 'expired';
            } else if (box.expiryDay - currentDay <= 3) {
                statusClass = 'warning';
                statusText = 'POR VENCER';
                statusIcon = '‚ö†Ô∏è';
            } else if (box.purchaseDay > currentDay) {
                statusClass = 'info';
                statusText = 'FUTURA';
                statusIcon = '‚è≥';
            }
            
            // Calcular d√≠as restantes
            const daysRemaining = Math.max(0, box.expiryDay - currentDay + 1);
            const progressPercent = box.duration > 0 ? 
                Math.max(0, Math.min(100, ((currentDay - box.purchaseDay) / box.duration) * 100)) : 0;
            
            row.innerHTML = `
                <td>
                    <strong>${box.name}</strong>
                    ${box.discountPercent > 0 ? `<br><small style="color: #28a745;">Descuento: ${box.discountPercent}%</small>` : ''}
                </td>
                <td><strong>${box.purchaseDay}</strong></td>
                <td><strong>${box.duration} d√≠as</strong></td>
                <td>
                    <strong>$${box.pricePaid.toLocaleString()}</strong>
                    ${box.originalPrice !== box.pricePaid ? 
                        `<br><small style="color: #dc3545; text-decoration: line-through;">$${box.originalPrice.toLocaleString()}</small>` : ''}
                </td>
                <td><strong style="color: #28a745;">$${box.dailyEarning.toLocaleString()}</strong></td>
                <td><strong>${box.expiryDay}</strong></td>
                <td>
                    <div style="display: flex; gap: 2px; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="editBox(${box.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Editar caja">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-danger" onclick="deleteBox(${box.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Eliminar caja">
                            üóëÔ∏è
                        </button>
                        <button class="btn btn-info" onclick="viewBoxDetails(${box.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Ver detalles">
                            üëÅÔ∏è
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Aplicar estilos din√°micos a los badges
        setTimeout(() => {
            document.querySelectorAll('.status-badge').forEach(badge => {
                const classList = badge.className;
                badge.style.padding = '4px 8px';
                badge.style.borderRadius = '4px';
                badge.style.fontWeight = 'bold';
                badge.style.fontSize = '10px';
                badge.style.display = 'inline-block';
                
                if (classList.includes('status-success')) {
                    badge.style.backgroundColor = '#d4edda';
                    badge.style.color = '#155724';
                } else if (classList.includes('status-warning')) {
                    badge.style.backgroundColor = '#fff3cd';
                    badge.style.color = '#856404';
                } else if (classList.includes('status-danger')) {
                    badge.style.backgroundColor = '#f8d7da';
                    badge.style.color = '#721c24';
                } else if (classList.includes('status-info')) {
                    badge.style.backgroundColor = '#d1ecf1';
                    badge.style.color = '#0c5460';
                }
            });
        }, 50);
        
    } catch (error) {
        console.error('Error en updateBoxesTable:', error);
    }
}

function updateRegistroSummary() {
    try {
        // Funci√≥n simplificada - solo para evitar errores
        logMessage('üìä Resumen de registro actualizado (simplificado)');
    } catch (error) {
        console.error('Error en updateRegistroSummary:', error);
    }
}

function updateExpiryAlerts() {
    try {
        // Funci√≥n simplificada - solo para evitar errores
        logMessage('‚ö†Ô∏è Alertas de vencimiento actualizadas (simplificadas)');
    } catch (error) {
        console.error('Error en updateExpiryAlerts:', error);
    }
}

function updateRegistroSummary() {
    try {
        // MODIFICACI√ìN: Considerar TODAS las cajas como activas en simulaci√≥n
        const simulatedBoxes = boxes; // Todas las cajas est√°n en simulaci√≥n
        const totalInvestment = simulatedBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const dailyEarnings = simulatedBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const totalBoxes = boxes.length;
        
        // Calcular ROI promedio ponderado
        const averageROI = simulatedBoxes.length > 0 ? 
            (simulatedBoxes.reduce((sum, box) => {
                const boxROI = (box.dailyEarning / (box.pricePaid || 1)) * 100;
                return sum + boxROI;
            }, 0) / simulatedBoxes.length).toFixed(1) : 0;
        
        const elements = {
            totalInvested: document.getElementById('reg-total-invested'),
            dailyEarnings: document.getElementById('reg-daily-earnings'),
            activeBoxes: document.getElementById('reg-active-boxes'),
            averageROI: document.getElementById('reg-average-roi')
        };
        
        if (elements.totalInvested) {
            elements.totalInvested.textContent = `$${totalInvestment.toLocaleString()}`;
        }
        if (elements.dailyEarnings) {
            elements.dailyEarnings.textContent = `$${dailyEarnings.toLocaleString()}`;
        }
        if (elements.activeBoxes) {
            elements.activeBoxes.textContent = `${simulatedBoxes.length}/${totalBoxes}`;
        }
        if (elements.averageROI) {
            elements.averageROI.textContent = `${averageROI}%`;
        }
        
        logMessage(`üìä Resumen actualizado: ${simulatedBoxes.length} cajas en simulaci√≥n, $${totalInvestment.toLocaleString()} invertido`);
        
    } catch (error) {
        console.error('Error en updateRegistroSummary:', error);
    }
}

function updateExpiryAlerts() {
    try {
        const expiryContainer = document.getElementById('reg-expiry-alerts');
        if (!expiryContainer) return;
        
        const currentDay = systemConfig.currentDay || 1;
        const alertDays = 5; // Alertar 5 d√≠as antes
        
        const expiringBoxes = boxes.filter(box => 
            box.status === 'active' && 
            box.expiryDay >= currentDay && 
            box.expiryDay - currentDay <= alertDays
        ).sort((a, b) => a.expiryDay - b.expiryDay);
        
        if (expiringBoxes.length === 0) {
            expiryContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #28a745; background-color: #d4edda; border-radius: 8px;">
                    ‚úÖ <strong>Sin vencimientos pr√≥ximos</strong><br>
                    <small>No hay cajas que venzan en los pr√≥ximos ${alertDays} d√≠as</small>
                </div>
            `;
            return;
        }
        
        let alertsHTML = '<div style="margin-bottom: 10px;"><strong>‚ö†Ô∏è PR√ìXIMOS VENCIMIENTOS:</strong></div>';
        
        expiringBoxes.forEach(box => {
            const daysToExpiry = box.expiryDay - currentDay + 1;
            let alertClass = 'alert-warning';
            let urgency = '‚ö†Ô∏è ADVERTENCIA';
            let urgencyColor = '#856404';
            
            if (daysToExpiry <= 1) {
                alertClass = 'alert-danger';
                urgency = 'üö® CR√çTICO';
                urgencyColor = '#721c24';
            } else if (daysToExpiry <= 2) {
                alertClass = 'alert-warning';
                urgency = '‚ö° URGENTE';
                urgencyColor = '#856404';
            }
            
            const potentialLoss = box.dailyEarning * daysToExpiry;
            
            alertsHTML += `
                <div class="alert ${alertClass}" style="margin-bottom: 10px; border-left: 4px solid ${urgencyColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: ${urgencyColor};">${urgency}</strong>: 
                            <strong>${box.name}</strong> vence en <strong>${daysToExpiry} d√≠a${daysToExpiry !== 1 ? 's' : ''}</strong> (D√≠a ${box.expiryDay})
                        </div>
                        <button onclick="renewBox(${box.id})" class="btn btn-primary" 
                                style="padding: 4px 12px; font-size: 12px;">
                            üîÑ Renovar
                        </button>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        üí∞ Ganancia diaria: $${box.dailyEarning.toLocaleString()} | 
                        üí∏ P√©rdida potencial: $${potentialLoss.toLocaleString()} | 
                        üìä ROI: ${((box.dailyEarning / box.pricePaid) * 100).toFixed(1)}%
                    </div>
                </div>
            `;
        });
        
        expiryContainer.innerHTML = alertsHTML;
        
    } catch (error) {
        console.error('Error en updateExpiryAlerts:', error);
    }
}

// =====================================================
// FUNCIONES DE GESTI√ìN DE CAJAS
// =====================================================

function editBox(id) {
    try {
        const box = boxes.find(b => b.id === id);
        if (!box) {
            showAlert('reg-alerts', '‚ùå Caja no encontrada', 'error');
            return;
        }
        
        // Cargar datos en el formulario
        document.getElementById('reg-tipo-caja').value = box.type;
        document.getElementById('reg-dia-compra').value = box.purchaseDay;
        document.getElementById('reg-duracion-dias').value = box.duration;
        document.getElementById('reg-descuento-pct').value = box.discountPercent || 0;
        
        updateBoxPrices();
        
        // Eliminar la caja original para permitir edici√≥n
        deleteBox(id, false);
        
        showAlert('reg-alerts', 
            `üìù Datos de <strong>${box.name}</strong> cargados para edici√≥n.<br>` +
            `Modifica los valores necesarios y presiona "Agregar Caja" para confirmar los cambios.`, 'info');
        
        logMessage(`‚úèÔ∏è Editando caja: ${box.name} (ID: ${id})`);
        
        // Scroll al formulario
        document.getElementById('reg-tipo-caja').scrollIntoView({ behavior: 'smooth', block: 'center' });
        
    } catch (error) {
        console.error('Error en editBox:', error);
        showAlert('reg-alerts', '‚ùå Error al editar la caja', 'error');
    }
}

function deleteBox(id, showConfirm = true) {
    try {
        const box = boxes.find(b => b.id === id);
        if (!box) {
            showAlert('reg-alerts', '‚ùå Caja no encontrada', 'error');
            return;
        }
        
        if (showConfirm) {
            const confirmMessage = 
                `‚ö†Ô∏è ¬øEst√°s seguro de eliminar esta caja?\n\n` +
                `üì¶ Caja: ${box.name}\n` +
                `üìÖ D√≠as: ${box.purchaseDay} - ${box.expiryDay}\n` +
                `üí∞ Inversi√≥n: $${box.pricePaid.toLocaleString()}\n` +
                `üí∏ Ganancia diaria: $${box.dailyEarning.toLocaleString()}\n\n` +
                `Esta acci√≥n NO se puede deshacer.`;
                
            if (!confirm(confirmMessage)) {
                return;
            }
        }
        
        const boxIndex = boxes.findIndex(b => b.id === id);
        if (boxIndex >= 0) {
            const deletedBox = boxes.splice(boxIndex, 1)[0];
            
            updateRegistroDisplay();
            updateAllCalculations();
            
            if (showConfirm) {
                showAlert('reg-alerts', 
                    `üóëÔ∏è <strong>${deletedBox.name}</strong> eliminada exitosamente.<br>` +
                    `Se liber√≥ la inversi√≥n de $${deletedBox.pricePaid.toLocaleString()}`, 'warning');
            }
            
            logMessage(`üóëÔ∏è Caja eliminada: ${deletedBox.name} (ID: ${id}) - $${deletedBox.pricePaid}`);
        }
    } catch (error) {
        console.error('Error en deleteBox:', error);
        showAlert('reg-alerts', '‚ùå Error al eliminar la caja', 'error');
    }
}

function viewBoxDetails(id) {
    try {
        const box = boxes.find(b => b.id === id);
        if (!box) {
            alert('‚ùå Caja no encontrada');
            return;
        }
        
        const currentDay = systemConfig.currentDay || 1;
        const daysActive = Math.max(0, Math.min(currentDay - box.purchaseDay + 1, box.duration));
        const totalEarningsToDate = box.dailyEarning * daysActive;
        const daysRemaining = Math.max(0, box.expiryDay - currentDay + 1);
        const potentialEarnings = box.dailyEarning * daysRemaining;
        const totalROI = box.pricePaid > 0 ? ((box.dailyEarning * box.duration) / box.pricePaid * 100).toFixed(2) : 0;
        
        const details = 
            `üì¶ DETALLES DE LA CAJA\n\n` +
            `Nombre: ${box.name}\n` +
            `Tipo: ${box.type}\n` +
            `Estado: ${box.status}\n\n` +
            `üìÖ CRONOLOG√çA:\n` +
            `D√≠a de compra: ${box.purchaseDay}\n` +
            `Duraci√≥n total: ${box.duration} d√≠as\n` +
            `D√≠a de vencimiento: ${box.expiryDay}\n` +
            `D√≠as transcurridos: ${daysActive}\n` +
            `D√≠as restantes: ${daysRemaining}\n\n` +
            `üí∞ FINANCIERO:\n` +
            `Precio original: $${box.originalPrice.toLocaleString()}\n` +
            `Descuento aplicado: ${box.discountPercent}% ($${(box.originalPrice - box.pricePaid).toLocaleString()})\n` +
            `Precio pagado: $${box.pricePaid.toLocaleString()}\n` +
            `Ganancia diaria: $${box.dailyEarning.toLocaleString()}\n\n` +
            `üìä RENDIMIENTO:\n` +
            `Ganancias generadas: $${totalEarningsToDate.toLocaleString()}\n` +
            `Ganancias potenciales: $${potentialEarnings.toLocaleString()}\n` +
            `ROI total proyectado: ${totalROI}%\n` +
            `ROI diario: ${((box.dailyEarning / box.pricePaid) * 100).toFixed(2)}%\n\n` +
            `üìù METADATA:\n` +
            `ID interno: ${box.id}\n` +
            `Fecha de creaci√≥n: ${new Date(box.dateCreated).toLocaleString('es-ES')}`;
        
        alert(details);
        logMessage(`üëÅÔ∏è Detalles consultados: ${box.name} (ID: ${id})`);
        
    } catch (error) {
        console.error('Error en viewBoxDetails:', error);
        alert('‚ùå Error al mostrar detalles');
    }
}

function renewBox(id) {
    try {
        const box = boxes.find(b => b.id === id);
        if (!box) {
            showAlert('reg-alerts', '‚ùå Caja no encontrada', 'error');
            return;
        }
        
        // Cargar datos para renovaci√≥n
        document.getElementById('reg-tipo-caja').value = box.type;
        document.getElementById('reg-dia-compra').value = box.expiryDay + 1; // Comenzar el d√≠a siguiente
        document.getElementById('reg-duracion-dias').value = box.duration; // Misma duraci√≥n
        document.getElementById('reg-descuento-pct').value = ''; // Sin descuento por defecto
        
        updateBoxPrices();
        
        showAlert('reg-alerts', 
            `üîÑ Formulario preparado para renovar <strong>${box.name}</strong>.<br>` +
            `La nueva caja comenzar√° el d√≠a ${box.expiryDay + 1}. Ajusta los valores si es necesario y presiona "Agregar Caja".`, 'info');
        
        logMessage(`üîÑ Preparando renovaci√≥n: ${box.name} (ID: ${id})`);
        
        // Scroll al formulario
        document.getElementById('reg-tipo-caja').scrollIntoView({ behavior: 'smooth', block: 'center' });
        
    } catch (error) {
        console.error('Error en renewBox:', error);
        showAlert('reg-alerts', '‚ùå Error al preparar la renovaci√≥n', 'error');
    }
}

// =====================================================
// FIN DEL M√ìDULO 7A - REGISTRO DE CAJAS
// =====================================================

// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7B1
// FUNCIONES PRINCIPALES DE AUTOMATIZACI√ìN
// =====================================================

// =====================================================
// FUNCI√ìN PRINCIPAL DE ACTUALIZACI√ìN DE AUTOMATIZACI√ìN
// =====================================================

function updateAutomatizacionDisplay() {
    try {
        updateAutomationStatus();
        updateAutomationPreview();
        updateCalculationLog();
        logMessage('üîß Display de automatizaci√≥n actualizado completamente');
    } catch (error) {
        console.error('Error en updateAutomatizacionDisplay:', error);
        showAlert('auto-alerts', '‚ùå Error al actualizar la automatizaci√≥n', 'error');
    }
}

// =====================================================
// ACTUALIZACI√ìN DEL ESTADO DEL SISTEMA
// =====================================================
function calculateMetricsByDate(selectedDay) {
    try {
        const metrics = {
            cajasActivas: 0,
            totalInvertido: systemConfig.initialBalance, // Comenzar con saldo inicial
            gananciaDiaria: 0,
            saldoActual: 0,
            porVencer: 0,
            proyeccion90: 0
        };
        
        // 1. CAJAS ACTIVAS en la fecha seleccionada
const activeBoxesAtDate = boxes.filter(box => 
    selectedDay >= box.purchaseDay && selectedDay <= box.expiryDay && 
    (box.status === 'active' || box.status === 'simulated')
);
metrics.cajasActivas = activeBoxesAtDate.length;
metrics.cajasActivasNombres = activeBoxesAtDate.map(box => box.name);
        
        // 2. TOTAL INVERTIDO = saldo inicial + recargas hasta fecha seleccionada
        const recargasHastaFecha = additionalMovements.filter(m => 
            m.day <= selectedDay && 
            m.type === 'income' && 
            m.category === 'recarga'
        );
        const totalRecargas = recargasHastaFecha.reduce((sum, m) => sum + m.amount, 0);
        metrics.totalInvertido = systemConfig.initialBalance + totalRecargas;
        
        // 3. GANANCIA DIARIA en la fecha seleccionada
        metrics.gananciaDiaria = activeBoxesAtDate.reduce((sum, box) => sum + box.dailyEarning, 0);
        
        // 4. SALDO ACTUAL hasta la fecha seleccionada (c√°lculo completo acumulativo)
metrics.saldoActual = calculateCompleteBalanceToDate(selectedDay);
        
        // 5. POR VENCER - Sistema de colores por proximidad
const expiringBoxesData = [];

// Buscar cajas que vencen en los pr√≥ximos 3 d√≠as + el d√≠a actual
for (let daysAhead = 0; daysAhead <= 3; daysAhead++) {
    const targetDay = selectedDay + daysAhead;
    const boxesExpiringThatDay = boxes.filter(box => 
        box.expiryDay === targetDay && 
        (box.status === 'active' || box.status === 'simulated')
    );
    
    if (boxesExpiringThatDay.length > 0) {
        let color;
        let urgencia;
        
        if (daysAhead === 0) {
            color = '#d32f2f'; // Rojo - Vence HOY
            urgencia = 'HOY';
        } else if (daysAhead === 1) {
            color = '#ff9800'; // Naranja - Vence ma√±ana
            urgencia = '1 d√≠a';
        } else if (daysAhead === 2) {
            color = '#ffc107'; // Amarillo - Vence en 2 d√≠as
            urgencia = '2 d√≠as';
        } else if (daysAhead === 3) {
            color = '#4caf50'; // Verde - Vence en 3 d√≠as
            urgencia = '3 d√≠as';
        }
        
        boxesExpiringThatDay.forEach(box => {
            expiringBoxesData.push({
                valor: box.pricePaid,
                color: color,
                urgencia: urgencia,
                daysAhead: daysAhead,
                expiryDay: box.expiryDay
            });
        });
    }
}

metrics.porVencer = expiringBoxesData.length;
metrics.porVencerData = expiringBoxesData;
        
        // 6. PROYECCI√ìN 90 D√çAS (balance final del d√≠a 90)
        metrics.proyeccion90 = calculateProjection(90);
        
        return metrics;
    } catch (error) {
        console.error('Error en calculateMetricsByDate:', error);
        return {
            cajasActivas: 0,
            totalInvertido: systemConfig.initialBalance,
            gananciaDiaria: 0,
            saldoActual: systemConfig.initialBalance,
            porVencer: 0,
            proyeccion90: systemConfig.initialBalance
        };
    }
}

function calculateCompleteBalanceToDate(targetDay) {
    try {
        let runningBalance = systemConfig.initialBalance;
        
        for (let day = 1; day <= targetDay; day++) {
            let dayEarnings = 0;
            let dayExpenses = 0;
            
            // Ganancias de cajas activas en este d√≠a
            boxes.forEach(box => {
                if (day >= box.purchaseDay && day <= box.expiryDay && 
                    (box.status === 'active' || box.status === 'simulated')) {
                    dayEarnings += box.dailyEarning;
                }
                // Gastos por compra de cajas en este d√≠a
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                }
            });
            
            // Movimientos adicionales del d√≠a
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                } else {
                    dayExpenses += movement.amount;
                }
            });
            
            // Aplicar ediciones de d√≠as si existen
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
            }
            
            // Actualizar balance acumulativo
            runningBalance = runningBalance + dayEarnings - dayExpenses;
        }
        
        return Math.round(runningBalance);
    } catch (error) {
        console.error('Error en calculateCompleteBalanceToDate:', error);
        return systemConfig.initialBalance;
    }
}


function updateMetricsBySelectedDate() {
    try {
        const selectedDay = parseInt(document.getElementById('analysis-day-selector').value) || 1;
        
        // Actualizar fecha real mostrada
        if (systemConfig.startDate) {
            const realDate = createDateWithoutTimezone(systemConfig.startDate);
            realDate.setDate(realDate.getDate() + selectedDay - 1);
            const dateElement = document.getElementById('analysis-real-date');
            if (dateElement) {
                dateElement.textContent = `Fecha real: ${formatDateDisplay(realDate, true)}`;
            }
        }
        
        // Calcular m√©tricas para la fecha seleccionada
        const metrics = calculateMetricsByDate(selectedDay);
        
        // Actualizar elementos del DOM
        const elements = {
            boxes: document.getElementById('auto-status-boxes'),
            investment: document.getElementById('auto-status-investment'),
            daily: document.getElementById('auto-status-daily'),
            balance: document.getElementById('auto-status-balance'),
            expiring: document.getElementById('auto-status-expiring'),
            projection: document.getElementById('auto-status-projection')
        };
        
        if (elements.boxes) {
    if (metrics.cajasActivas > 0 && metrics.cajasActivasNombres.length > 0) {
        // Mostrar valores de cajas activas
        const activeBoxesAtDate = boxes.filter(box => 
            selectedDay >= box.purchaseDay && selectedDay <= box.expiryDay && 
            (box.status === 'active' || box.status === 'simulated')
        );
        const valoresCajas = activeBoxesAtDate.map(box => box.pricePaid.toLocaleString());
        elements.boxes.textContent = '$' + valoresCajas.join(', $');
        elements.boxes.style.fontSize = '12px'; // Texto m√°s peque√±o para que quepa
    } else {
        elements.boxes.textContent = 'Sin cajas activas';
        elements.boxes.style.fontSize = '14px';
    }
    elements.boxes.style.color = metrics.cajasActivas > 0 ? '#2e7d32' : '#d32f2f';
}
        
        if (elements.investment) {
            elements.investment.textContent = `$${metrics.totalInvertido.toLocaleString()}`;
            elements.investment.style.color = metrics.totalInvertido > 0 ? '#2e7d32' : '#666';
        }
        
        if (elements.daily) {
            elements.daily.textContent = `$${metrics.gananciaDiaria.toLocaleString()}`;
            elements.daily.style.color = metrics.gananciaDiaria > 0 ? '#2e7d32' : '#666';
        }
        
        if (elements.balance) {
            elements.balance.textContent = `$${metrics.saldoActual.toLocaleString()}`;
            elements.balance.style.color = metrics.saldoActual >= systemConfig.initialBalance ? '#2e7d32' : '#d32f2f';
        }
        
        if (elements.expiring) {
    if (metrics.porVencer > 0 && metrics.porVencerData.length > 0) {
        // Agrupar por urgencia para mejor visualizaci√≥n
        const grouped = {};
        metrics.porVencerData.forEach(item => {
            if (!grouped[item.urgencia]) {
                grouped[item.urgencia] = [];
            }
            grouped[item.urgencia].push(item);
        });
        
        // Crear texto con colores (usaremos el color m√°s urgente como principal)
        const mostUrgent = metrics.porVencerData.reduce((most, current) => 
            current.daysAhead < most.daysAhead ? current : most
        );
        
        // Mostrar valores agrupados por urgencia
        const displayParts = [];
        ['HOY', '1 d√≠a', '2 d√≠as', '3 d√≠as'].forEach(urgencia => {
            if (grouped[urgencia]) {
                const valores = grouped[urgencia].map(item => 
                    '$' + item.valor.toLocaleString()
                ).join(', ');
                displayParts.push(`${valores} (${urgencia})`);
            }
        });
        
        elements.expiring.innerHTML = displayParts.join('<br>');
        elements.expiring.style.color = mostUrgent.color;
        elements.expiring.style.fontSize = '11px';
        elements.expiring.style.lineHeight = '1.3';
        elements.expiring.style.fontWeight = 'bold';
    } else {
        elements.expiring.textContent = 'Sin vencimientos';
        elements.expiring.style.color = '#2e7d32';
        elements.expiring.style.fontSize = '14px';
        elements.expiring.style.lineHeight = '1';
        elements.expiring.style.fontWeight = 'normal';
    }
}
        
        if (elements.projection) {
            elements.projection.textContent = `$${metrics.proyeccion90.toLocaleString()}`;
            elements.projection.style.color = metrics.proyeccion90 > metrics.saldoActual ? '#2e7d32' : '#ff9800';
        }
        
        logMessage(`üìÖ M√©tricas actualizadas para d√≠a ${selectedDay}: ${metrics.cajasActivas} cajas activas, balance: $${metrics.saldoActual.toLocaleString()}`);
        
    } catch (error) {
        console.error('Error en updateMetricsBySelectedDate:', error);
    }
}


function updateAutomationStatus() {
    try {
        // Usar la nueva funci√≥n de c√°lculo por fecha
        const selectedDay = parseInt(document.getElementById('analysis-day-selector')?.value) || 1;
        updateMetricsBySelectedDate();
        
        logMessage(`üìä Estado de automatizaci√≥n actualizado para d√≠a ${selectedDay}`);
        
    } catch (error) {
        console.error('Error en updateAutomationStatus:', error);
    }
}

// =====================================================
// C√ÅLCULO DE PROYECCIONES
// =====================================================

function calculateProjection(days) {
    try {
        let projectedBalance = systemConfig.initialBalance;
        
        // MODIFICACI√ìN: Procesar TODOS los d√≠as sin restricci√≥n de "d√≠a actual"
        for (let day = 1; day <= days; day++) {
            let dayEarnings = 0;
            let dayExpenses = 0;
            
            // Procesar TODAS las cajas sin verificar estado o d√≠a actual
            boxes.forEach(box => {
                if (day >= box.purchaseDay && day <= box.expiryDay) {
                    dayEarnings += box.dailyEarning;
                }
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                }
            });
            
            // Procesar movimientos adicionales
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                } else {
                    dayExpenses += movement.amount;
                }
            });
            
            // Aplicar ediciones
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
            }
            
            projectedBalance = projectedBalance + dayEarnings - dayExpenses;
        }
        
        return Math.round(projectedBalance);
    } catch (error) {
        console.error('Error en calculateProjection:', error);
        return 0;
    }
}

// =====================================================
// VISTA PREVIA DEL CALENDARIO AUTOMATIZADO
// =====================================================
function updateAutomationPreview() {
    try {
        if (!systemConfig.startDate) {
            logMessage('‚ö†Ô∏è Fecha de inicio no configurada para vista previa');
            return;
        }
        
        // Obtener rango de d√≠as a mostrar (por defecto 1-30)
        const currentRange = window.automationRange || 1;
        const startDay = (currentRange - 1) * 30 + 1;
        const endDay = Math.min(currentRange * 30, 90);
        
        let runningBalance = systemConfig.initialBalance;
        
        // Calcular balance hasta el d√≠a de inicio del rango
        if (startDay > 1) {
            for (let day = 1; day < startDay; day++) {
                let dayEarnings = 0;
                let dayExpenses = 0;
                
                boxes.forEach(box => {
                    if (day >= box.purchaseDay && day <= box.expiryDay && box.dailyEarning > 0) {
                        dayEarnings += box.dailyEarning;
                    }
                    if (day === box.purchaseDay) {
                        dayExpenses += box.pricePaid;
                    }
                });
                
                additionalMovements.filter(m => m.day === day).forEach(movement => {
                    if (movement.type === 'income') {
                        dayEarnings += movement.amount;
                    } else {
                        dayExpenses += movement.amount;
                    }
                });
                
                const dayEdit = dayEditions.find(e => e.day === day);
                if (dayEdit) {
                    dayEarnings = dayEdit.finalEarnings || dayEarnings;
                }
                
                runningBalance += dayEarnings - dayExpenses;
            }
        }
        
        // Mostrar el rango actual (hasta 30 d√≠as)
        for (let day = startDay; day <= endDay; day++) {
            const displayIndex = day - startDay + 1;
            
            // Solo procesar hasta d√≠a 30 de la vista
            if (displayIndex > 30) break;
            
            // Actualizar fecha
            const currentDate = createDateWithoutTimezone(systemConfig.startDate);
            currentDate.setDate(currentDate.getDate() + day - 1);
            
            const dateElement = document.getElementById(`auto-date-${displayIndex}`);
            if (dateElement) {
                const formatDate = formatDateDisplay(currentDate, false);
                dateElement.textContent = formatDate;
            } else {
                console.warn(`‚ùå Elemento auto-date-${displayIndex} no encontrado`);
            }
            
            // Calcular operaciones del d√≠a
            let dayEarnings = 0;
            let dayExpenses = 0;
            let operations = [];
            
            boxes.forEach(box => {
                if (day >= box.purchaseDay && day <= box.expiryDay && box.dailyEarning > 0) {
                    dayEarnings += box.dailyEarning;
                }
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                    operations.push(`üì¶ ${box.name.substring(0, 8)}...`);
                }
            });
            
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                    operations.push(`üí∞ +${movement.amount}`);
                } else {
                    dayExpenses += movement.amount;
                    operations.push(`üí∏ -${movement.amount}`);
                }
            });
            
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
                operations.push(`‚úèÔ∏è Editado`);
            }
            
            const netChange = dayEarnings - dayExpenses;
            runningBalance += netChange;
            
            // Actualizar elementos del DOM
            const totalElement = document.getElementById(`auto-total-${displayIndex}`);
            const opsElement = document.getElementById(`auto-ops-${displayIndex}`);
            
            if (totalElement) {
                totalElement.textContent = `$${runningBalance.toLocaleString()}`;
                totalElement.style.color = runningBalance >= 0 ? '#1976D2' : '#d32f2f';
            } else {
                console.warn(`‚ùå Elemento auto-total-${displayIndex} no encontrado`);
            }
            
            if (opsElement) {
                if (operations.length > 0) {
                    opsElement.textContent = operations.slice(0, 2).join(' ');
                } else if (netChange > 0) {
                    opsElement.textContent = `+$${netChange.toLocaleString()}`;
                } else if (netChange < 0) {
                    opsElement.textContent = `-$${Math.abs(netChange).toLocaleString()}`;
                } else {
                    opsElement.textContent = 'Sin cambios';
                }
                opsElement.style.color = netChange >= 0 ? '#2e7d32' : '#d32f2f';
            } else {
                console.warn(`‚ùå Elemento auto-ops-${displayIndex} no encontrado`);
            }
            
            // Aplicar alertas de vencimiento
            const calcElement = document.getElementById(`auto-calc-${displayIndex}`);
            const hasExpiry = boxes.some(box => box.expiryDay === day && box.dailyEarning > 0);
            if (calcElement) {
                if (hasExpiry) {
                    calcElement.style.backgroundColor = '#ffcdd2';
                    if (opsElement) {
                        opsElement.textContent = '‚ö†Ô∏è VENCE CAJA';
                        opsElement.style.color = '#c62828';
                    }
                } else {
                    calcElement.style.backgroundColor = '#ffffff';
                }
            }
        }
        
        logMessage(`üìÖ Vista previa actualizada: D√≠as ${startDay}-${endDay} (Rango ${currentRange})`);
        
    } catch (error) {
        console.error('Error en updateAutomationPreview:', error);
    }
}function updateAutomationPreview() {
    try {
        if (!systemConfig.startDate) {
            logMessage('‚ö†Ô∏è Fecha de inicio no configurada para vista previa');
            return;
        }
        
        // Obtener rango de d√≠as a mostrar (por defecto 1-30)
        const currentRange = window.automationRange || 1;
        const startDay = (currentRange - 1) * 30 + 1;
        const endDay = Math.min(currentRange * 30, 90);
        
        let runningBalance = systemConfig.initialBalance;
        
        // Calcular balance hasta el d√≠a de inicio del rango
        if (startDay > 1) {
            for (let day = 1; day < startDay; day++) {
                let dayEarnings = 0;
                let dayExpenses = 0;
                
                boxes.forEach(box => {
                    if (day >= box.purchaseDay && day <= box.expiryDay && box.dailyEarning > 0) {
                        dayEarnings += box.dailyEarning;
                    }
                    if (day === box.purchaseDay) {
                        dayExpenses += box.pricePaid;
                    }
                });
                
                additionalMovements.filter(m => m.day === day).forEach(movement => {
                    if (movement.type === 'income') {
                        dayEarnings += movement.amount;
                    } else {
                        dayExpenses += movement.amount;
                    }
                });
                
                const dayEdit = dayEditions.find(e => e.day === day);
                if (dayEdit) {
                    dayEarnings = dayEdit.finalEarnings || dayEarnings;
                }
                
                runningBalance += dayEarnings - dayExpenses;
            }
        }
        
        // Mostrar el rango actual (hasta 30 d√≠as)
        for (let day = startDay; day <= endDay; day++) {
            const displayIndex = day - startDay + 1;
            
            // Solo procesar hasta d√≠a 30 de la vista
            if (displayIndex > 30) break;
            
            // Actualizar fecha
            const currentDate = createDateWithoutTimezone(systemConfig.startDate);
            currentDate.setDate(currentDate.getDate() + day - 1);
            
            const dateElement = document.getElementById(`auto-date-${displayIndex}`);
            if (dateElement) {
                const formatDate = formatDateDisplay(currentDate, false);
                dateElement.textContent = formatDate;
            } else {
                console.warn(`‚ùå Elemento auto-date-${displayIndex} no encontrado`);
            }
            
            // Calcular operaciones del d√≠a
            let dayEarnings = 0;
            let dayExpenses = 0;
            let operations = [];
            
            boxes.forEach(box => {
                if (day >= box.purchaseDay && day <= box.expiryDay && box.dailyEarning > 0) {
                    dayEarnings += box.dailyEarning;
                }
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                    operations.push(`üì¶ ${box.name.substring(0, 8)}...`);
                }
            });
            
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                    operations.push(`üí∞ +${movement.amount}`);
                } else {
                    dayExpenses += movement.amount;
                    operations.push(`üí∏ -${movement.amount}`);
                }
            });
            
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
                operations.push(`‚úèÔ∏è Editado`);
            }
            
            const netChange = dayEarnings - dayExpenses;
            runningBalance += netChange;
            
            // Actualizar elementos del DOM
            const totalElement = document.getElementById(`auto-total-${displayIndex}`);
            const opsElement = document.getElementById(`auto-ops-${displayIndex}`);
            
            if (totalElement) {
                totalElement.textContent = `$${runningBalance.toLocaleString()}`;
                totalElement.style.color = runningBalance >= 0 ? '#1976D2' : '#d32f2f';
            } else {
                console.warn(`‚ùå Elemento auto-total-${displayIndex} no encontrado`);
            }
            
            if (opsElement) {
                if (operations.length > 0) {
                    opsElement.textContent = operations.slice(0, 2).join(' ');
                } else if (netChange > 0) {
                    opsElement.textContent = `+$${netChange.toLocaleString()}`;
                } else if (netChange < 0) {
                    opsElement.textContent = `-$${Math.abs(netChange).toLocaleString()}`;
                } else {
                    opsElement.textContent = 'Sin cambios';
                }
                opsElement.style.color = netChange >= 0 ? '#2e7d32' : '#d32f2f';
            } else {
                console.warn(`‚ùå Elemento auto-ops-${displayIndex} no encontrado`);
            }
            
            // Aplicar alertas de vencimiento
            const calcElement = document.getElementById(`auto-calc-${displayIndex}`);
            const hasExpiry = boxes.some(box => box.expiryDay === day && box.dailyEarning > 0);
            if (calcElement) {
                if (hasExpiry) {
                    calcElement.style.backgroundColor = '#ffcdd2';
                    if (opsElement) {
                        opsElement.textContent = '‚ö†Ô∏è VENCE CAJA';
                        opsElement.style.color = '#c62828';
                    }
                } else {
                    calcElement.style.backgroundColor = '#ffffff';
                }
            }
        }
        
        logMessage(`üìÖ Vista previa actualizada: D√≠as ${startDay}-${endDay} (Rango ${currentRange})`);
        
    } catch (error) {
        console.error('Error en updateAutomationPreview:', error);
    }
}

// Llamar despu√©s de que se genere la tabla
setTimeout(() => {
    updateAutomationPreview();
}, 500);

// =====================================================
// LOG DE C√ÅLCULOS AUTOM√ÅTICOS
// =====================================================

function updateCalculationLog() {
    // Funci√≥n desactivada - Log eliminado para interfaz m√°s limpia
    return;
}

// =====================================================
// FUNCIONES DE CONTROL DEL SISTEMA
// =====================================================

function recalculateAllSystem() {
    try {
        logMessage('üîÑ Iniciando rec√°lculo completo del sistema...');
        
        // Limpiar balances diarios
        dailyBalances = [];
        
        // Actualizar configuraci√≥n
        updateConfigDisplay();
        
        // Recalcular controles
        updateControlDisplay();
        
        // Actualizar todos los m√≥dulos
        updateRegistroDisplay();
        updateAutomatizacionDisplay();
        updateMovimientosDisplay();
        
        // Verificar consistencia de datos
        validateSystemConsistency();
        
        showAlert('auto-alerts', '‚úÖ Sistema completo recalculado exitosamente', 'success');
        logMessage('‚úÖ Rec√°lculo completo del sistema finalizado');
        
    } catch (error) {
        console.error('Error en recalculateAllSystem:', error);
        showAlert('auto-alerts', '‚ùå Error durante el rec√°lculo del sistema', 'error');
    }
}

function updateAllDates() {
    try {
        logMessage('üìÖ Actualizando todas las fechas del sistema...');
        
        // Actualizar fechas en control diario
        updateDatesInCalendar();
        
        // Actualizar fechas en automatizaci√≥n
        updateAutomationPreview();
        
        // Recalcular todo basado en las nuevas fechas
        updateAllCalculations();
        
        showAlert('auto-alerts', '‚úÖ Todas las fechas han sido actualizadas', 'success');
        logMessage('‚úÖ Actualizaci√≥n de fechas completada');
        
    } catch (error) {
        console.error('Error en updateAllDates:', error);
        showAlert('auto-alerts', '‚ùå Error al actualizar las fechas', 'error');
    }
}

function validateSystemConsistency() {
    try {
        const issues = [];
        
        // Validar cajas
        boxes.forEach((box, index) => {
            if (!box.id || !box.name || !box.type) {
                issues.push(`Caja ${index + 1}: Datos b√°sicos incompletos`);
            }
            if (box.purchaseDay > box.expiryDay) {
                issues.push(`${box.name}: D√≠a de compra posterior al vencimiento`);
            }
            if (box.pricePaid < 0 || box.dailyEarning < 0) {
                issues.push(`${box.name}: Valores financieros negativos`);
            }
        });
        
        // Validar movimientos
        additionalMovements.forEach((movement, index) => {
            if (!movement.day || !movement.type || !movement.amount) {
                issues.push(`Movimiento ${index + 1}: Datos incompletos`);
            }
            if (movement.day < 1 || movement.day > 90) {
                issues.push(`Movimiento ${index + 1}: D√≠a fuera de rango`);
            }
        });
        
        // Validar configuraci√≥n
        if (!systemConfig.startDate) {
            issues.push('Configuraci√≥n: Fecha de inicio no establecida');
        }
        if (systemConfig.initialBalance < 0) {
            issues.push('Configuraci√≥n: Saldo inicial negativo');
        }
        
        if (issues.length > 0) {
            console.warn('‚ö†Ô∏è Inconsistencias detectadas en el sistema:', issues);
            logMessage(`‚ö†Ô∏è Se detectaron ${issues.length} inconsistencias en los datos`);
        } else {
            logMessage('‚úÖ Validaci√≥n de consistencia: Sistema correcto');
        }
        
        return issues;
    } catch (error) {
        console.error('Error en validateSystemConsistency:', error);
        return ['Error durante la validaci√≥n'];
    }
}

// =====================================================
// FUNCIONES DE AN√ÅLISIS AVANZADO
// =====================================================

function analyzePortfolioPerformance() {
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        if (activeBoxes.length === 0) {
            return {
                message: 'No hay cajas activas para analizar',
                performance: null
            };
        }
        
        // Calcular m√©tricas de rendimiento
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const averageROI = (dailyEarnings / totalInvestment) * 100;
        
        // An√°lisis por tipo de caja
        const typeAnalysis = {};
        activeBoxes.forEach(box => {
            if (!typeAnalysis[box.type]) {
                typeAnalysis[box.type] = {
                    count: 0,
                    investment: 0,
                    dailyEarnings: 0,
                    roi: 0
                };
            }
            typeAnalysis[box.type].count++;
            typeAnalysis[box.type].investment += box.pricePaid;
            typeAnalysis[box.type].dailyEarnings += box.dailyEarning;
        });
        
        // Calcular ROI por tipo
        Object.keys(typeAnalysis).forEach(type => {
            const analysis = typeAnalysis[type];
            analysis.roi = (analysis.dailyEarnings / analysis.investment) * 100;
        });
        
        // Encontrar mejor y peor rendimiento
        const sortedTypes = Object.entries(typeAnalysis)
            .sort(([,a], [,b]) => b.roi - a.roi);
        
        const bestPerformer = sortedTypes[0];
        const worstPerformer = sortedTypes[sortedTypes.length - 1];
        
        return {
            totalBoxes: activeBoxes.length,
            totalInvestment,
            dailyEarnings,
            averageROI: averageROI.toFixed(2),
            typeAnalysis,
            bestPerformer: bestPerformer ? {
                type: bestPerformer[0],
                roi: bestPerformer[1].roi.toFixed(2)
            } : null,
            worstPerformer: worstPerformer ? {
                type: worstPerformer[0],
                roi: worstPerformer[1].roi.toFixed(2)
            } : null,
            diversificationScore: Object.keys(typeAnalysis).length / Object.keys(boxCatalog).length * 100
        };
    } catch (error) {
        console.error('Error en analyzePortfolioPerformance:', error);
        return { error: 'Error al analizar el portafolio' };
    }
}

function calculateRiskMetrics() {
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const currentDay = systemConfig.currentDay || 1;
        
        if (activeBoxes.length === 0) {
            return {
                riskLevel: 'Sin datos',
                expirationRisk: 0,
                concentrationRisk: 0,
                liquidityRisk: 0
            };
        }
        
        // Riesgo de vencimiento (cajas que vencen pronto)
        const expiringBoxes = activeBoxes.filter(box => 
            box.expiryDay - currentDay <= 7
        );
        const expirationRisk = (expiringBoxes.length / activeBoxes.length) * 100;
        
        // Riesgo de concentraci√≥n (diversificaci√≥n)
        const typeDistribution = {};
        activeBoxes.forEach(box => {
            typeDistribution[box.type] = (typeDistribution[box.type] || 0) + box.pricePaid;
        });
        
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const maxConcentration = Math.max(...Object.values(typeDistribution)) / totalInvestment * 100;
        const concentrationRisk = maxConcentration > 50 ? maxConcentration : 0;
        
        // Riesgo de liquidez (porcentaje del capital total invertido)
        const liquidityRisk = (totalInvestment / systemConfig.initialBalance) * 100;
        
        // Nivel de riesgo general
        let riskLevel = 'Bajo';
        if (expirationRisk > 30 || concentrationRisk > 60 || liquidityRisk > 80) {
            riskLevel = 'Alto';
        } else if (expirationRisk > 15 || concentrationRisk > 40 || liquidityRisk > 60) {
            riskLevel = 'Medio';
        }
        
        return {
            riskLevel,
            expirationRisk: expirationRisk.toFixed(1),
            concentrationRisk: concentrationRisk.toFixed(1),
            liquidityRisk: liquidityRisk.toFixed(1),
            recommendations: generateRiskRecommendations(expirationRisk, concentrationRisk, liquidityRisk)
        };
    } catch (error) {
        console.error('Error en calculateRiskMetrics:', error);
        return { error: 'Error al calcular m√©tricas de riesgo' };
    }
}

function generateRiskRecommendations(expiration, concentration, liquidity) {
    const recommendations = [];
    
    if (expiration > 30) {
        recommendations.push('‚ö†Ô∏è Alto riesgo de vencimiento: Planifica renovaciones inmediatas');
    }
    if (concentration > 60) {
        recommendations.push('üìä Alta concentraci√≥n: Diversifica en diferentes tipos de cajas');
    }
    if (liquidity > 80) {
        recommendations.push('üí∞ Baja liquidez: Mant√©n m√°s reservas disponibles');
    }
    if (recommendations.length === 0) {
        recommendations.push('‚úÖ Perfil de riesgo saludable');
    }
    
    return recommendations;
}

// =====================================================
// FIN DEL M√ìDULO 7B1 - FUNCIONES PRINCIPALES
// =====================================================


// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7B2A
// REPORTES Y AN√ÅLISIS - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// GENERACI√ìN DE REPORTES COMPLETOS
// =====================================================

function generateSystemReport() {
    try {
        logMessage('üìä Generando reporte completo del sistema...');
        
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const expiredBoxes = boxes.filter(box => box.status === 'expired');
        const totalInvestment = boxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const activeInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const currentDay = systemConfig.currentDay || 1;
        
        // Calcular ROI ponderado
        const weightedROI = activeBoxes.length > 0 ? 
            (activeBoxes.reduce((sum, box) => {
                const boxROI = (box.dailyEarning / (box.pricePaid || 1)) * 100;
                return sum + (boxROI * box.pricePaid);
            }, 0) / activeInvestment).toFixed(2) : 0;
        
        // Proyecciones
        const projection7Days = calculateProjection(7);
        const projection30Days = calculateProjection(30);
        const projection60Days = calculateProjection(60);
        
        // An√°lisis de movimientos
        const totalIncome = additionalMovements
            .filter(m => m.type === 'income')
            .reduce((sum, m) => sum + m.amount, 0);
        const totalExpenses = additionalMovements
            .filter(m => m.type === 'expense')
            .reduce((sum, m) => sum + m.amount, 0);
        
        // An√°lisis de rendimiento por tipo de caja
        const performanceByType = analyzePerformanceByType();
        
        // Calcular balance actual
        const currentBalance = calculateCurrentBalance();
        
        const report = {
            // Informaci√≥n general
            metadata: {
                fechaReporte: new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                usuario: systemConfig.userName || 'No especificado',
                diaActual: currentDay,
                fechaInicio: systemConfig.startDate ? systemConfig.startDate.toLocaleDateString('es-ES') : 'No establecida',
                sistemaVersion: '1.0'
            },
            
            // Configuraci√≥n financiera
            configuracion: {
                saldoInicial: systemConfig.initialBalance,
                balanceActual: currentBalance,
                diferenciaSaldoInicial: currentBalance - systemConfig.initialBalance,
                porcentajeCrecimiento: systemConfig.initialBalance > 0 ? 
                    (((currentBalance - systemConfig.initialBalance) / systemConfig.initialBalance) * 100).toFixed(2) + '%' : '0%'
            },
            
            // Estad√≠sticas de cajas
            estadisticasCajas: {
                total: boxes.length,
                activas: activeBoxes.length,
                vencidas: expiredBoxes.length,
                porcentajeActivas: boxes.length > 0 ? ((activeBoxes.length / boxes.length) * 100).toFixed(1) + '%' : '0%',
                proximasAVencer: activeBoxes.filter(box => box.expiryDay - currentDay <= 7).length
            },
            
            // Datos financieros principales
            inversion: {
                totalHistorica: totalInvestment,
                activaActual: activeInvestment,
                porcentajeActiva: totalInvestment > 0 ? ((activeInvestment / totalInvestment) * 100).toFixed(1) + '%' : '0%',
                promedioPorCaja: activeBoxes.length > 0 ? Math.round(activeInvestment / activeBoxes.length) : 0
            },
            
            ganancias: {
                diariasActuales: dailyEarnings,
                semanalesProyectadas: dailyEarnings * 7,
                mensualesProyectadas: dailyEarnings * 30,
                anualesProyectadas: dailyEarnings * 365
            },
            
            rendimiento: {
                roiDiarioPromedio: weightedROI + '%',
                roiSemanualProyectado: (weightedROI * 7).toFixed(2) + '%',
                roiMensualProyectado: (weightedROI * 30).toFixed(2) + '%',
                roiAnualProyectado: (weightedROI * 365).toFixed(2) + '%',
                tiempoRecuperacionInversion: activeInvestment > 0 && dailyEarnings > 0 ? 
                    Math.ceil(activeInvestment / dailyEarnings) + ' d√≠as' : 'No calculable'
            },
            
            // Proyecciones de balance
            proyecciones: {
                balance7Dias: projection7Days,
                balance30Dias: projection30Days,
                balance60Dias: projection60Days,
                crecimiento7Dias: projection7Days - currentBalance,
                crecimiento30Dias: projection30Days - currentBalance,
                crecimiento60Dias: projection60Days - currentBalance,
                rentabilidad7Dias: currentBalance > 0 ? (((projection7Days - currentBalance) / currentBalance) * 100).toFixed(2) + '%' : '0%',
                rentabilidad30Dias: currentBalance > 0 ? (((projection30Days - currentBalance) / currentBalance) * 100).toFixed(2) + '%' : '0%',
                rentabilidad60Dias: currentBalance > 0 ? (((projection60Days - currentBalance) / currentBalance) * 100).toFixed(2) + '%' : '0%'
            },
            
            // Movimientos adicionales
            movimientosAdicionales: {
                totalIngresos: totalIncome,
                totalEgresos: totalExpenses,
                balanceNeto: totalIncome - totalExpenses,
                cantidad: additionalMovements.length,
                impactoEnBalance: totalIncome - totalExpenses,
                porcentajeImpacto: systemConfig.initialBalance > 0 ? 
                    (((totalIncome - totalExpenses) / systemConfig.initialBalance) * 100).toFixed(2) + '%' : '0%'
            },
            
            // An√°lisis por tipo de caja
            rendimientoPorTipo: performanceByType,
            
            // Detalles de cajas activas
            detallesCajasActivas: generateBoxDetails(activeBoxes, currentDay),
            
            // Alertas y recomendaciones
            alertas: generateReportAlerts(activeBoxes, currentDay),
            recomendaciones: generateRecommendations(activeBoxes, currentDay, currentBalance),
            
            // M√©tricas de riesgo
            analisisRiesgo: calculateRiskMetrics(),
            
            // Resumen ejecutivo
            resumenEjecutivo: generateExecutiveSummary(activeBoxes, currentBalance, dailyEarnings, projection30Days)
        };
        
        // Mostrar reporte en consola de forma organizada
        displayFormattedReport(report);
        
        showAlert('auto-alerts', 
            `üìä <strong>Reporte completo generado exitosamente</strong><br>` +
            `Revisa la <strong>consola del navegador (F12)</strong> para ver todos los detalles.<br>` +
            `<small>Cajas activas: ${activeBoxes.length} | Balance actual: $${currentBalance.toLocaleString()}</small>`, 'success');
        
        logMessage('üìä Reporte completo generado y mostrado en consola');
        
        return report;
    } catch (error) {
        console.error('Error en generateSystemReport:', error);
        showAlert('auto-alerts', '‚ùå Error al generar el reporte', 'error');
        return null;
    }
}

function displayFormattedReport(report) {
    console.group('üìä REPORTE COMPLETO DEL SISTEMA VIVABOX');
    
    console.log('üéØ RESUMEN EJECUTIVO');
    console.log(report.resumenEjecutivo);
    console.log('');
    
    console.log('üìã INFORMACI√ìN GENERAL');
    console.table(report.metadata);
    
    console.log('üí∞ CONFIGURACI√ìN FINANCIERA');
    console.table(report.configuracion);
    
    console.log('üì¶ ESTAD√çSTICAS DE CAJAS');
    console.table(report.estadisticasCajas);
    
    console.log('üíµ DATOS DE INVERSI√ìN');
    console.table(report.inversion);
    
    console.log('üìà GANANCIAS Y PROYECCIONES');
    console.table(report.ganancias);
    
    console.log('üìä RENDIMIENTO');
    console.table(report.rendimiento);
    
    console.log('üîÆ PROYECCIONES DE BALANCE');
    console.table(report.proyecciones);
    
    console.log('üí∏ MOVIMIENTOS ADICIONALES');
    console.table(report.movimientosAdicionales);
    
    if (Object.keys(report.rendimientoPorTipo).length > 0) {
        console.log('üè∑Ô∏è RENDIMIENTO POR TIPO DE CAJA');
        console.table(report.rendimientoPorTipo);
    }
    
    if (report.detallesCajasActivas.length > 0) {
        console.log('üìã DETALLES DE CAJAS ACTIVAS');
        console.table(report.detallesCajasActivas);
    }
    
    console.log('‚ö†Ô∏è AN√ÅLISIS DE RIESGO');
    console.table(report.analisisRiesgo);
    
    if (report.alertas.length > 0) {
        console.log('üö® ALERTAS');
        report.alertas.forEach(alert => console.warn('‚ö†Ô∏è ' + alert));
    }
    
    if (report.recomendaciones.length > 0) {
        console.log('üí° RECOMENDACIONES');
        report.recomendaciones.forEach(rec => console.info('üí° ' + rec));
    }
    
    console.groupEnd();
}

// =====================================================
// FUNCIONES DE AN√ÅLISIS AUXILIARES
// =====================================================

function analyzePerformanceByType() {
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const typeAnalysis = {};
        
        activeBoxes.forEach(box => {
            if (!typeAnalysis[box.type]) {
                typeAnalysis[box.type] = {
                    nombre: boxCatalog[box.type]?.name || box.type,
                    cantidad: 0,
                    inversionTotal: 0,
                    gananciasDiarias: 0,
                    roiPromedio: 0,
                    precioPromedio: 0
                };
            }
            
            const analysis = typeAnalysis[box.type];
            analysis.cantidad++;
            analysis.inversionTotal += box.pricePaid;
            analysis.gananciasDiarias += box.dailyEarning;
        });
        
        // Calcular promedios y ROI
        Object.keys(typeAnalysis).forEach(type => {
            const analysis = typeAnalysis[type];
            analysis.precioPromedio = Math.round(analysis.inversionTotal / analysis.cantidad);
            analysis.roiPromedio = ((analysis.gananciasDiarias / analysis.inversionTotal) * 100).toFixed(2) + '%';
            analysis.participacion = ((analysis.inversionTotal / activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0)) * 100).toFixed(1) + '%';
        });
        
        return typeAnalysis;
    } catch (error) {
        console.error('Error en analyzePerformanceByType:', error);
        return {};
    }
}

function calculateCurrentBalance() {
    try {
        const currentDay = systemConfig.currentDay || 1;
        let balance = systemConfig.initialBalance;
        
        for (let day = 1; day <= currentDay; day++) {
            let dayEarnings = 0;
            let dayExpenses = 0;
            
            // CORRECCI√ìN: Procesar TODAS las cajas sin filtrar por status
            boxes.forEach(box => {
                // Ganancias: si el d√≠a est√° en el rango de la caja
                if (day >= box.purchaseDay && day <= box.expiryDay) {
                    dayEarnings += box.dailyEarning;
                }
                // Gastos: si es el d√≠a de compra
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                }
            });
            
            // Movimientos adicionales
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                } else {
                    dayExpenses += movement.amount;
                }
            });
            
            // Aplicar ediciones
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
            }
            
            balance = balance + dayEarnings - dayExpenses;
        }
        
        return Math.round(balance);
    } catch (error) {
        console.error('Error en calculateCurrentBalance:', error);
        return systemConfig.initialBalance;
    }
}

function generateBoxDetails(activeBoxes, currentDay) {
    return activeBoxes.map(box => {
        const daysActive = Math.max(0, Math.min(currentDay - box.purchaseDay + 1, box.duration));
        const daysRemaining = Math.max(0, box.expiryDay - currentDay + 1);
        const earningsToDate = box.dailyEarning * daysActive;
        const potentialEarnings = box.dailyEarning * daysRemaining;
        
        return {
            nombre: box.name,
            tipo: box.type,
            diaCompra: box.purchaseDay,
            diaVencimiento: box.expiryDay,
            duracionTotal: box.duration,
            diasTranscurridos: daysActive,
            diasRestantes: daysRemaining,
            progreso: box.duration > 0 ? ((daysActive / box.duration) * 100).toFixed(1) + '%' : '0%',
            inversion: box.pricePaid,
            precioOriginal: box.originalPrice,
            descuentoAplicado: box.discountPercent || 0,
            gananciaDiaria: box.dailyEarning,
            gananciasGeneradas: earningsToDate,
            gananciasRestantes: potentialEarnings,
            roiDiario: ((box.dailyEarning / box.pricePaid) * 100).toFixed(2) + '%',
            roiAcumulado: box.pricePaid > 0 ? ((earningsToDate / box.pricePaid) * 100).toFixed(2) + '%' : '0%',
            roiTotal: ((box.dailyEarning * box.duration / box.pricePaid) * 100).toFixed(2) + '%',
            eficiencia: box.originalPrice > 0 ? ((box.dailyEarning / box.originalPrice) * 100).toFixed(3) + '%' : '0%'
        };
    });
}

function generateReportAlerts(activeBoxes, currentDay) {
    const alerts = [];
    
    try {
        // Alertas de vencimiento inmediato
        const expiringToday = activeBoxes.filter(box => box.expiryDay === currentDay);
        if (expiringToday.length > 0) {
            alerts.push(`${expiringToday.length} caja(s) vencen HOY - Acci√≥n inmediata requerida`);
        }
        
        // Alertas de vencimiento pr√≥ximo
        const expiringBoxes = activeBoxes.filter(box => 
            box.expiryDay > currentDay && box.expiryDay - currentDay <= 3
        );
        if (expiringBoxes.length > 0) {
            alerts.push(`${expiringBoxes.length} caja(s) vencen en los pr√≥ximos 3 d√≠as`);
        }
        
        // Alertas de rendimiento
        const lowROIBoxes = activeBoxes.filter(box => 
            (box.dailyEarning / box.pricePaid) * 100 < 3
        );
        if (lowROIBoxes.length > 0) {
            alerts.push(`${lowROIBoxes.length} caja(s) tienen ROI menor al 3% diario`);
        }
        
        // Alertas de concentraci√≥n
        const typeDistribution = {};
        let maxTypeInvestment = 0;
        let dominantType = '';
        
        activeBoxes.forEach(box => {
            typeDistribution[box.type] = (typeDistribution[box.type] || 0) + box.pricePaid;
            if (typeDistribution[box.type] > maxTypeInvestment) {
                maxTypeInvestment = typeDistribution[box.type];
                dominantType = box.type;
            }
        });
        
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        if (totalInvestment > 0) {
            const concentrationPercent = (maxTypeInvestment / totalInvestment) * 100;
            
            if (concentrationPercent > 60) {
                alerts.push(`Alta concentraci√≥n en ${boxCatalog[dominantType]?.name || dominantType} (${concentrationPercent.toFixed(1)}%)`);
            }
        }
        
        // Alertas de liquidez
        if (totalInvestment > systemConfig.initialBalance * 0.9) {
            alerts.push('Muy baja liquidez - M√°s del 90% del capital est√° invertido');
        }
        
        return alerts;
    } catch (error) {
        console.error('Error en generateReportAlerts:', error);
        return ['Error al generar alertas'];
    }
}

function generateRecommendations(activeBoxes, currentDay, currentBalance) {
    const recommendations = [];
    
    try {
        // Recomendaciones de diversificaci√≥n
        const uniqueTypes = [...new Set(activeBoxes.map(box => box.type))];
        const totalTypes = Object.keys(boxCatalog).length;
        
        if (uniqueTypes.length < totalTypes / 2) {
            recommendations.push('Considera diversificar en m√°s tipos de cajas para reducir riesgo');
        }
        
        // Recomendaciones de renovaci√≥n
        const expiringBoxes = activeBoxes.filter(box => 
            box.expiryDay - currentDay <= 7 && box.expiryDay >= currentDay
        );
        if (expiringBoxes.length > 0) {
            recommendations.push(`Planifica la renovaci√≥n de ${expiringBoxes.length} caja(s) que vencen pronto`);
        }
        
        // Recomendaciones de optimizaci√≥n
        const lowROIBoxes = activeBoxes.filter(box => 
            (box.dailyEarning / box.pricePaid) * 100 < 4
        );
        if (lowROIBoxes.length > 0) {
            recommendations.push('Eval√∫a reemplazar cajas con ROI menor al 4% por opciones m√°s rentables');
        }
        
        // Recomendaciones de crecimiento
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        if (currentBalance > systemConfig.initialBalance * 1.5 && dailyEarnings > 0) {
            recommendations.push('Considera reinvertir parte de las ganancias para acelerar el crecimiento');
        }
        
        // Recomendaciones de balance
        if (currentBalance < systemConfig.initialBalance * 0.2) {
            recommendations.push('Mant√©n al menos 20% del capital inicial como reserva de emergencia');
        }
        
        // Recomendaciones espec√≠ficas por rendimiento
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const avgROI = totalInvestment > 0 ? (dailyEarnings / totalInvestment) * 100 : 0;
        
        if (avgROI < 4) {
            recommendations.push('ROI promedio bajo del 4% - Considera cajas Premium o VIP para mayor rentabilidad');
        } else if (avgROI > 6) {
            recommendations.push('Excelente ROI promedio - Mant√©n esta estrategia y considera expandir la inversi√≥n');
        }
        
        if (recommendations.length === 0) {
            recommendations.push('Estrategia de inversi√≥n bien balanceada - Contin√∫a con el plan actual');
        }
        
        return recommendations;
    } catch (error) {
        console.error('Error en generateRecommendations:', error);
        return ['Error al generar recomendaciones'];
    }
}

function generateExecutiveSummary(activeBoxes, currentBalance, dailyEarnings, projection30Days) {
    try {
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const roi = totalInvestment > 0 ? ((dailyEarnings / totalInvestment) * 100).toFixed(2) : 0;
        const growth = systemConfig.initialBalance > 0 ? 
            (((currentBalance - systemConfig.initialBalance) / systemConfig.initialBalance) * 100).toFixed(1) : 0;
        
        const status = activeBoxes.length > 0 ? 'ACTIVO' : 'INACTIVO';
        const trend = currentBalance > systemConfig.initialBalance ? 'üìà CRECIENDO' : 
                     currentBalance === systemConfig.initialBalance ? 'üìä ESTABLE' : 'üìâ DECRECIENDO';
        
        return `
üéØ RESUMEN EJECUTIVO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Estado del sistema: ${status} ${trend}
‚Ä¢ Cajas operativas: ${activeBoxes.length} activas generando $${dailyEarnings.toLocaleString()}/d√≠a
‚Ä¢ Balance actual: $${currentBalance.toLocaleString()} (${growth}% vs saldo inicial)
‚Ä¢ ROI promedio: ${roi}% diario
‚Ä¢ Proyecci√≥n 30 d√≠as: $${projection30Days.toLocaleString()}
‚Ä¢ Capital en operaci√≥n: $${totalInvestment.toLocaleString()}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
        `.trim();
    } catch (error) {
        return 'Error al generar resumen ejecutivo';
    }
}

// =====================================================
// AN√ÅLISIS COMPARATIVO TEMPORAL
// =====================================================

function generateTemporalAnalysis() {
    try {
        const currentDay = systemConfig.currentDay || 1;
        const analysis = {
            semana1: { days: [1, 7], earnings: 0, expenses: 0, balance: systemConfig.initialBalance },
            semana2: { days: [8, 14], earnings: 0, expenses: 0, balance: 0 },
            semana3: { days: [15, 21], earnings: 0, expenses: 0, balance: 0 },
            semana4: { days: [22, 28], earnings: 0, expenses: 0, balance: 0 }
        };
        
        let runningBalance = systemConfig.initialBalance;
        
        // Calcular por semanas
        for (let week = 1; week <= 4; week++) {
            const weekKey = `semana${week}`;
            const [startDay, endDay] = analysis[weekKey].days;
            
            for (let day = startDay; day <= Math.min(endDay, currentDay); day++) {
                let dayEarnings = 0;
                let dayExpenses = 0;
                
                // Cajas
                boxes.forEach(box => {
                    if (box.status === 'active' && day >= box.purchaseDay && day <= box.expiryDay) {
                        dayEarnings += box.dailyEarning;
                    }
                    if (day === box.purchaseDay) {
                        dayExpenses += box.pricePaid;
                    }
                });
                
                // Movimientos
                additionalMovements.filter(m => m.day === day).forEach(movement => {
                    if (movement.type === 'income') {
                        dayEarnings += movement.amount;
                    } else {
                        dayExpenses += movement.amount;
                    }
                });
                
                analysis[weekKey].earnings += dayEarnings;
                analysis[weekKey].expenses += dayExpenses;
                runningBalance = runningBalance + dayEarnings - dayExpenses;
            }
            
            analysis[weekKey].balance = runningBalance;
            analysis[weekKey].netChange = analysis[weekKey].earnings - analysis[weekKey].expenses;
            analysis[weekKey].roi = analysis[weekKey].expenses > 0 ? 
                ((analysis[weekKey].earnings / analysis[weekKey].expenses) * 100).toFixed(2) + '%' : 'N/A';
        }
        
        return analysis;
    } catch (error) {
        console.error('Error en generateTemporalAnalysis:', error);
        return null;
    }
}

// =====================================================
// FIN DEL M√ìDULO 7B2A - REPORTES Y AN√ÅLISIS
// =====================================================

// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7B2B-1
// EXPORTACI√ìN COMPLETA - IMPLEMENTACI√ìN
// =====================================================

// =====================================================
// EXPORTACI√ìN COMPLETA DE DATOS
// =====================================================

function exportSystemData() {
    try {
        logMessage('üíæ Preparando exportaci√≥n completa de datos del sistema...');
        
        const exportData = {
            // Metadata de exportaci√≥n
            metadata: {
                version: '1.0',
                aplicacion: 'VIVABOX Sistema de Control de Cajas',
                fechaExportacion: new Date().toISOString(),
                fechaExportacionLegible: new Date().toLocaleString('es-ES'),
                usuario: systemConfig.userName || 'Usuario no especificado',
                descripcion: 'Exportaci√≥n completa del sistema VIVABOX con todos los datos y configuraciones',
                totalRegistros: boxes.length + additionalMovements.length + dayEditions.length,
                sistemaOperativo: navigator.platform || 'Desconocido',
                navegador: navigator.userAgent.split(' ').pop() || 'Desconocido'
            },
            
            // Configuraci√≥n del sistema con datos enriquecidos
            configuracion: {
                ...systemConfig,
                startDate: systemConfig.startDate ? systemConfig.startDate.toISOString() : null,
                startDateLegible: systemConfig.startDate ? systemConfig.startDate.toLocaleDateString('es-ES') : null,
                currentDayAtExport: systemConfig.currentDay || 1,
                balanceActualCalculado: calculateCurrentBalance(),
                diasTranscurridos: systemConfig.startDate ? 
                    Math.ceil((new Date() - systemConfig.startDate) / (1000 * 60 * 60 * 24)) : 0
            },
            
            // Datos principales con metadata enriquecida
            cajas: boxes.map(box => ({
                ...box,
                dateCreated: box.dateCreated || new Date().toISOString(),
                dateCreatedLegible: box.dateCreated ? new Date(box.dateCreated).toLocaleString('es-ES') : 'No disponible',
                catalogData: boxCatalog[box.type] ? {
                    ...boxCatalog[box.type],
                    precioActualCatalogo: boxCatalog[box.type].price,
                    gananciaActualCatalogo: boxCatalog[box.type].earning
                } : null,
                calculatedMetrics: {
                    roiDiario: box.pricePaid > 0 ? ((box.dailyEarning / box.pricePaid) * 100).toFixed(2) : 0,
                    roiTotal: box.pricePaid > 0 ? ((box.dailyEarning * box.duration / box.pricePaid) * 100).toFixed(2) : 0,
                    gananciaTotal: box.dailyEarning * box.duration,
                    ahorro: box.originalPrice ? box.originalPrice - box.pricePaid : 0,
                    eficiencia: box.originalPrice > 0 ? ((box.dailyEarning / box.originalPrice) * 100).toFixed(3) : 0,
                    diasRestantes: Math.max(0, box.expiryDay - (systemConfig.currentDay || 1) + 1),
                    progreso: box.duration > 0 ? 
                        (Math.min(((systemConfig.currentDay || 1) - box.purchaseDay + 1) / box.duration, 1) * 100).toFixed(1) : 0
                },
                statusAtExport: {
                    estado: box.status,
                    activa: box.status === 'active',
                    vencida: box.status === 'expired',
                    proximaAVencer: box.status === 'active' && 
                        box.expiryDay - (systemConfig.currentDay || 1) <= 5
                }
            })),
            
            // Movimientos con categor√≠as expandidas
            movimientos: additionalMovements.map(movement => ({
                ...movement,
                date: movement.date || new Date().toISOString(),
                dateLegible: movement.date ? new Date(movement.date).toLocaleString('es-ES') : 'No disponible',
                categoryName: movementCategories[movement.type]?.[movement.category] || movement.category,
                typeDescription: movement.type === 'income' ? 'Ingreso' : 'Egreso',
                impactDescription: movement.type === 'income' ? 
                    `+$${movement.amount.toLocaleString()}` : `-$${movement.amount.toLocaleString()}`,
                dayDate: systemConfig.startDate ? 
                    new Date(systemConfig.startDate.getTime() + (movement.day - 1) * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES') : 
                    'Fecha no calculable'
            })),
            
            // Ediciones con contexto adicional
            ediciones: dayEditions.map(edition => ({
                ...edition,
                date: edition.date || new Date().toISOString(),
                dateLegible: edition.date ? new Date(edition.date).toLocaleString('es-ES') : 'No disponible',
                impacto: (edition.finalEarnings || 0) - (edition.originalEarnings || 0),
                tipoEdicion: edition.reason || 'No especificado',
                dayDate: systemConfig.startDate ? 
                    new Date(systemConfig.startDate.getTime() + (edition.day - 1) * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES') : 
                    'Fecha no calculable'
            })),
            
            // Estad√≠sticas completas al momento de exportaci√≥n
            estadisticas: generateExportStatistics(),
            
            // Balances diarios si est√°n disponibles
            balancesDiarios: dailyBalances.length > 0 ? dailyBalances.map((balance, index) => ({
                dia: index + 1,
                balance: balance,
                fecha: systemConfig.startDate ? 
                    new Date(systemConfig.startDate.getTime() + index * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES') : 
                    'Fecha no calculable'
            })) : null,
            
            // Configuraciones de referencia
            catalogoReferencia: {
                tipos: boxCatalog,
                categorias: movementCategories,
                descripcion: 'Cat√°logos de referencia del sistema al momento de la exportaci√≥n'
            },
            
            // An√°lisis de rendimiento incluido
            analisisRendimiento: analyzePortfolioPerformance(),
            
            // M√©tricas de riesgo
            metricsRiesgo: calculateRiskMetrics(),
            
            // Proyecciones calculadas
            proyecciones: {
                dias7: calculateProjection(7),
                dias30: calculateProjection(30),
                dias60: calculateProjection(60),
                descripcion: 'Proyecciones de balance futuro basadas en cajas activas'
            }
        };
        
        // Generar reporte incluido en la exportaci√≥n
        try {
            const systemReport = generateSystemReport();
            if (systemReport) {
                exportData.reporteCompleto = {
                    ...systemReport,
                    descripcion: 'Reporte completo generado al momento de la exportaci√≥n'
                };
            }
        } catch (reportError) {
            console.warn('No se pudo incluir el reporte en la exportaci√≥n:', reportError);
            exportData.reporteCompleto = { error: 'No se pudo generar el reporte' };
        }
        
        // Convertir a JSON con formato legible
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        // Crear nombre de archivo detallado
        const now = new Date();
        const timestamp = now.toISOString().split('T')[0];
        const timeString = now.toTimeString().split(' ')[0].replace(/:/g, '-');
        const userPart = systemConfig.userName ? 
            `_${systemConfig.userName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20)}` : '';
        const filename = `vivabox_completo_${timestamp}_${timeString}${userPart}.json`;
        
        // Crear y descargar archivo
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Limpiar URL despu√©s de un momento
        setTimeout(() => URL.revokeObjectURL(url), 2000);
        
        // Mostrar informaci√≥n detallada de la exportaci√≥n
        const fileSizeKB = (dataStr.length / 1024).toFixed(1);
        const recordCount = exportData.metadata.totalRegistros;
        
        showAlert('auto-alerts', 
            `üíæ <strong>Exportaci√≥n completada exitosamente</strong><br>` +
            `üìÅ Archivo: <code>${filename}</code><br>` +
            `üìä Datos: ${recordCount} registros (${fileSizeKB} KB)<br>` +
            `üì¶ Cajas: ${exportData.cajas.length} | üí∞ Movimientos: ${exportData.movimientos.length}<br>` +
            `<small>El archivo incluye configuraci√≥n, datos, estad√≠sticas y reporte completo</small>`, 'success');
        
        logMessage(`üíæ Exportaci√≥n completa exitosa: ${filename} (${recordCount} registros, ${fileSizeKB} KB)`);
        
        return {
            success: true,
            filename: filename,
            recordCount: recordCount,
            fileSize: dataStr.length,
            fileSizeKB: fileSizeKB,
            exportData: exportData
        };
        
    } catch (error) {
        console.error('Error en exportSystemData:', error);
        showAlert('auto-alerts', '‚ùå Error al exportar los datos del sistema', 'error');
        return {
            success: false,
            error: error.message
        };
    }
}

// =====================================================
// GENERACI√ìN DE ESTAD√çSTICAS PARA EXPORTACI√ìN
// =====================================================

function generateExportStatistics() {
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const expiredBoxes = boxes.filter(box => box.status === 'expired');
        const totalInvestment = boxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const activeInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const currentBalance = calculateCurrentBalance();
        
        // An√°lisis de movimientos
        const incomeMovements = additionalMovements.filter(m => m.type === 'income');
        const expenseMovements = additionalMovements.filter(m => m.type === 'expense');
        const totalIncome = incomeMovements.reduce((sum, m) => sum + m.amount, 0);
        const totalExpenses = expenseMovements.reduce((sum, m) => sum + m.amount, 0);
        
        // An√°lisis temporal
        const currentDay = systemConfig.currentDay || 1;
        const expiringBoxes = activeBoxes.filter(box => 
            box.expiryDay - currentDay <= 7 && box.expiryDay >= currentDay
        );
        
        return {
            resumenGeneral: {
                fechaAnalisis: new Date().toLocaleDateString('es-ES'),
                diaActualSistema: currentDay,
                balanceActual: currentBalance,
                crecimientoAbsoluto: currentBalance - systemConfig.initialBalance,
                crecimientoRelativo: systemConfig.initialBalance > 0 ? 
                    (((currentBalance - systemConfig.initialBalance) / systemConfig.initialBalance) * 100).toFixed(2) + '%' : '0%'
            },
            
            cajas: {
                total: boxes.length,
                activas: activeBoxes.length,
                vencidas: expiredBoxes.length,
                proximasAVencer: expiringBoxes.length,
                porcentajeActivas: boxes.length > 0 ? ((activeBoxes.length / boxes.length) * 100).toFixed(1) + '%' : '0%',
                tiposUtilizados: [...new Set(boxes.map(box => box.type))].length,
                tiposDisponibles: Object.keys(boxCatalog).length
            },
            
            inversion: {
                totalHistorica: totalInvestment,
                activaActual: activeInvestment,
                promedioPorCaja: boxes.length > 0 ? Math.round(totalInvestment / boxes.length) : 0,
                promedioActivaPorCaja: activeBoxes.length > 0 ? Math.round(activeInvestment / activeBoxes.length) : 0,
                porcentajeCapitalInvertido: systemConfig.initialBalance > 0 ? 
                    ((totalInvestment / systemConfig.initialBalance) * 100).toFixed(1) + '%' : '0%'
            },
            
            ganancias: {
                diariasActuales: dailyEarnings,
                semanalesProyectadas: dailyEarnings * 7,
                mensualesProyectadas: dailyEarnings * 30,
                roiPromedioActivo: activeInvestment > 0 ? ((dailyEarnings / activeInvestment) * 100).toFixed(2) + '%' : '0%',
                tiempoRecuperacion: activeInvestment > 0 && dailyEarnings > 0 ? 
                    Math.ceil(activeInvestment / dailyEarnings) + ' d√≠as' : 'No calculable'
            },
            
            movimientos: {
                total: additionalMovements.length,
                ingresos: incomeMovements.length,
                egresos: expenseMovements.length,
                montoTotalIngresos: totalIncome,
                montoTotalEgresos: totalExpenses,
                balanceNeto: totalIncome - totalExpenses,
                promedioIngreso: incomeMovements.length > 0 ? Math.round(totalIncome / incomeMovements.length) : 0,
                promedioEgreso: expenseMovements.length > 0 ? Math.round(totalExpenses / expenseMovements.length) : 0
            },
            
            ediciones: {
                total: dayEditions.length,
                impactoTotal: dayEditions.reduce((sum, edit) => 
                    sum + ((edit.finalEarnings || 0) - (edit.originalEarnings || 0)), 0),
                diasEditados: [...new Set(dayEditions.map(edit => edit.day))].length
            },
            
            rendimiento: {
                mejorCaja: activeBoxes.length > 0 ? 
                    activeBoxes.reduce((best, box) => 
                        (box.dailyEarning / box.pricePaid) > (best.dailyEarning / best.pricePaid) ? box : best
                    ).name : 'N/A',
                peorCaja: activeBoxes.length > 0 ? 
                    activeBoxes.reduce((worst, box) => 
                        (box.dailyEarning / box.pricePaid) < (worst.dailyEarning / worst.pricePaid) ? box : worst
                    ).name : 'N/A',
                diversificacion: activeBoxes.length > 0 ? 
                    ([...new Set(activeBoxes.map(box => box.type))].length / Object.keys(boxCatalog).length * 100).toFixed(1) + '%' : '0%'
            },
            
            // An√°lisis adicional por tipo de caja
            analisisPorTipo: generateTypeAnalysisForExport(activeBoxes),
            
            // M√©tricas de eficiencia
            metricsEficiencia: generateEfficiencyMetrics(activeBoxes, currentDay),
            
            // An√°lisis de tendencias
            tendencias: generateTrendAnalysis(currentDay)
        };
    } catch (error) {
        console.error('Error en generateExportStatistics:', error);
        return { error: 'Error al generar estad√≠sticas de exportaci√≥n' };
    }
}

function generateTypeAnalysisForExport(activeBoxes) {
    try {
        const typeStats = {};
        
        activeBoxes.forEach(box => {
            if (!typeStats[box.type]) {
                typeStats[box.type] = {
                    nombre: boxCatalog[box.type]?.name || box.type,
                    cantidad: 0,
                    inversionTotal: 0,
                    gananciasDiarias: 0,
                    roiPromedio: 0,
                    precioPromedio: 0,
                    diasPromedioRestantes: 0
                };
            }
            
            const stats = typeStats[box.type];
            stats.cantidad++;
            stats.inversionTotal += box.pricePaid;
            stats.gananciasDiarias += box.dailyEarning;
            stats.diasPromedioRestantes += Math.max(0, box.expiryDay - (systemConfig.currentDay || 1) + 1);
        });
        
        // Calcular promedios
        Object.keys(typeStats).forEach(type => {
            const stats = typeStats[type];
            stats.precioPromedio = Math.round(stats.inversionTotal / stats.cantidad);
            stats.roiPromedio = ((stats.gananciasDiarias / stats.inversionTotal) * 100).toFixed(2);
            stats.diasPromedioRestantes = Math.round(stats.diasPromedioRestantes / stats.cantidad);
        });
        
        return typeStats;
    } catch (error) {
        console.error('Error en generateTypeAnalysisForExport:', error);
        return {};
    }
}

function generateEfficiencyMetrics(activeBoxes, currentDay) {
    try {
        if (activeBoxes.length === 0) {
            return {
                mensaje: 'No hay cajas activas para analizar eficiencia'
            };
        }
        
        // Calcular m√©tricas de eficiencia
        const rois = activeBoxes.map(box => (box.dailyEarning / box.pricePaid) * 100);
        const avgROI = rois.reduce((sum, roi) => sum + roi, 0) / rois.length;
        const maxROI = Math.max(...rois);
        const minROI = Math.min(...rois);
        
        // An√°lisis de vencimientos
        const daysToExpiry = activeBoxes.map(box => box.expiryDay - currentDay + 1);
        const avgDaysToExpiry = daysToExpiry.reduce((sum, days) => sum + days, 0) / daysToExpiry.length;
        
        // An√°lisis de concentraci√≥n
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const typeConcentration = {};
        activeBoxes.forEach(box => {
            typeConcentration[box.type] = (typeConcentration[box.type] || 0) + box.pricePaid;
        });
        
        const maxConcentration = Math.max(...Object.values(typeConcentration));
        const concentrationRatio = (maxConcentration / totalInvestment) * 100;
        
        return {
            rendimiento: {
                roiPromedio: avgROI.toFixed(2) + '%',
                roiMaximo: maxROI.toFixed(2) + '%',
                roiMinimo: minROI.toFixed(2) + '%',
                desviacionROI: Math.sqrt(rois.reduce((sum, roi) => sum + Math.pow(roi - avgROI, 2), 0) / rois.length).toFixed(2) + '%'
            },
            vencimientos: {
                diasPromedioVencimiento: Math.round(avgDaysToExpiry),
                cajasVencenEn7Dias: daysToExpiry.filter(days => days <= 7).length,
                cajasVencenEn30Dias: daysToExpiry.filter(days => days <= 30).length
            },
            concentracion: {
                ratioConcentracion: concentrationRatio.toFixed(1) + '%',
                tipoMasConcentrado: Object.keys(typeConcentration).reduce((max, type) => 
                    typeConcentration[type] > typeConcentration[max] ? type : max),
                nivelDiversificacion: Object.keys(typeConcentration).length > 1 ? 'Diversificado' : 'Concentrado'
            },
            eficienciaGeneral: {
                puntuacion: Math.min(100, Math.max(0, (avgROI * 10 + (100 - concentrationRatio) * 0.5))).toFixed(1),
                categoria: avgROI > 5 ? 'Excelente' : avgROI > 3 ? 'Buena' : 'Regular'
            }
        };
    } catch (error) {
        console.error('Error en generateEfficiencyMetrics:', error);
        return { error: 'Error al calcular m√©tricas de eficiencia' };
    }
}

function generateTrendAnalysis(currentDay) {
    try {
        const trends = {
            crecimiento: 'estable',
            velocidad: 'normal',
            riesgo: 'bajo',
            recomendacion: 'mantener'
        };
        
        // An√°lisis simple de tendencias basado en datos actuales
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const totalEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        
        if (totalEarnings > totalInvestment * 0.06) {
            trends.crecimiento = 'acelerado';
            trends.velocidad = 'alta';
        } else if (totalEarnings < totalInvestment * 0.03) {
            trends.crecimiento = 'lento';
            trends.velocidad = 'baja';
            trends.riesgo = 'medio';
            trends.recomendacion = 'optimizar';
        }
        
        // An√°lisis de vencimientos pr√≥ximos
        const expiringBoxes = activeBoxes.filter(box => 
            box.expiryDay - currentDay <= 7
        );
        
        if (expiringBoxes.length > activeBoxes.length * 0.3) {
            trends.riesgo = 'alto';
            trends.recomendacion = 'renovar urgente';
        }
        
        return {
            ...trends,
            analisisDetallado: {
                cajasActivas: activeBoxes.length,
                gananciasDiarias: totalEarnings,
                inversionActiva: totalInvestment,
                cajasVencenProximamente: expiringBoxes.length,
                porcentajeRiesgoVencimiento: activeBoxes.length > 0 ? 
                    ((expiringBoxes.length / activeBoxes.length) * 100).toFixed(1) + '%' : '0%'
            }
        };
    } catch (error) {
        console.error('Error en generateTrendAnalysis:', error);
        return { error: 'Error al generar an√°lisis de tendencias' };
    }
}

// =====================================================
// FUNCIONES DE EXPORTACI√ìN ESPEC√çFICA
// =====================================================

function exportQuickReport() {
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const currentBalance = calculateCurrentBalance();
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        
        const quickReport = {
            fecha: new Date().toLocaleDateString('es-ES'),
            usuario: systemConfig.userName || 'No especificado',
            resumen: {
                balanceActual: currentBalance,
                saldoInicial: systemConfig.initialBalance,
                crecimiento: currentBalance - systemConfig.initialBalance,
                cajasActivas: activeBoxes.length,
                gananciasDiarias: dailyEarnings,
                proyeccion7Dias: calculateProjection(7),
                proyeccion30Dias: calculateProjection(30)
            },
            cajas: activeBoxes.map(box => ({
                nombre: box.name,
                inversion: box.pricePaid,
                gananciaDiaria: box.dailyEarning,
                diasRestantes: Math.max(0, box.expiryDay - (systemConfig.currentDay || 1) + 1),
                roi: ((box.dailyEarning / box.pricePaid) * 100).toFixed(2) + '%'
            }))
        };
        
        const dataStr = JSON.stringify(quickReport, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const filename = `vivabox_reporte_rapido_${new Date().toISOString().split('T')[0]}.json`;
        
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        
        showAlert('auto-alerts', `üìä Reporte r√°pido exportado: ${filename}`, 'success');
        logMessage(`üìä Reporte r√°pido exportado: ${filename}`);
        
        return { success: true, filename };
    } catch (error) {
        console.error('Error en exportQuickReport:', error);
        showAlert('auto-alerts', '‚ùå Error al exportar reporte r√°pido', 'error');
        return { success: false, error: error.message };
    }
}

// =====================================================
// FIN DEL M√ìDULO 7B2B-1 - EXPORTACI√ìN COMPLETA
// =====================================================


// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7B2B-2A
// IMPORTACI√ìN B√ÅSICA - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// IMPORTACI√ìN COMPLETA DE DATOS
// =====================================================

function importSystemData(fileContent) {
    try {
        logMessage('üì• Iniciando proceso de importaci√≥n de datos...');
        
        let importedData;
        try {
            importedData = JSON.parse(fileContent);
        } catch (parseError) {
            throw new Error('El archivo no contiene JSON v√°lido: ' + parseError.message);
        }
        
        // Validar estructura b√°sica
        if (!importedData.configuracion || !Array.isArray(importedData.cajas)) {
            throw new Error('Archivo de importaci√≥n no v√°lido - Estructura de datos incorrecta');
        }
        
        // Validar versi√≥n y compatibilidad
        if (importedData.metadata && importedData.metadata.version && importedData.metadata.version !== '1.0') {
            const confirmVersion = confirm(
                `‚ö†Ô∏è COMPATIBILIDAD DE VERSI√ìN\n\n` +
                `Versi√≥n del archivo: ${importedData.metadata.version}\n` +
                `Versi√≥n actual del sistema: 1.0\n\n` +
                `Puede haber incompatibilidades. ¬øContinuar de todas formas?`
            );
            if (!confirmVersion) {
                logMessage('üì• Importaci√≥n cancelada - Incompatibilidad de versi√≥n');
                return false;
            }
        }
        
        // Mostrar informaci√≥n del archivo y confirmar importaci√≥n
        const fileInfo = generateFileInfo(importedData);
        
        const confirmMessage = 
            `üì• CONFIRMACI√ìN DE IMPORTACI√ìN\n\n` +
            `üìÅ DATOS DEL ARCHIVO:\n` +
            `üë§ Usuario: ${fileInfo.usuario}\n` +
            `üìÖ Exportado el: ${fileInfo.fechaExportacion}\n` +
            `üì¶ Cajas: ${fileInfo.cajas}\n` +
            `üí∞ Movimientos: ${fileInfo.movimientos}\n` +
            `‚úèÔ∏è Ediciones: ${fileInfo.ediciones}\n` +
            `üíµ Saldo inicial: $${fileInfo.saldoInicial.toLocaleString()}\n` +
            `üìÖ Fecha inicio: ${fileInfo.fechaInicio}\n` +
            `üìä Balance exportado: $${fileInfo.balanceExportado.toLocaleString()}\n\n` +
            `‚ö†Ô∏è IMPORTANTE:\n` +
            `‚Ä¢ Todos los datos actuales ser√°n REEMPLAZADOS\n` +
            `‚Ä¢ Esta acci√≥n NO se puede deshacer\n` +
            `‚Ä¢ Se recomienda exportar el estado actual primero\n\n` +
            `¬øConfirmas la importaci√≥n?`;
        
        if (!confirm(confirmMessage)) {
            logMessage('üì• Importaci√≥n cancelada por el usuario');
            showAlert('auto-alerts', 'üì• Importaci√≥n cancelada por el usuario', 'warning');
            return false;
        }
        
        // Realizar backup de datos actuales (temporal)
        const backupData = createSystemBackup();
        
        try {
            // Ejecutar importaci√≥n
            const importResult = executeImport(importedData);
            
            if (!importResult.success) {
                throw new Error(importResult.error);
            }
            
            // Actualizar configuraci√≥n en el DOM
            updateDOMAfterImport();
            
            // Actualizar todo el sistema
            updateAllCalculations();
            
            // Validar datos importados
            const validationResults = validateImportedData();
            
            // Mostrar resultado exitoso
            showImportSuccessAlert(importResult, validationResults);
            
            logMessage(`üì• Importaci√≥n completada exitosamente: ${boxes.length} cajas, ${additionalMovements.length} movimientos, ${dayEditions.length} ediciones`);
            
            return {
                success: true,
                stats: importResult.stats,
                warnings: validationResults.warnings
            };
            
        } catch (importError) {
            // Restaurar backup en caso de error
            restoreSystemBackup(backupData);
            throw new Error('Error durante la importaci√≥n: ' + importError.message);
        }
        
    } catch (error) {
        console.error('Error en importSystemData:', error);
        showAlert('auto-alerts', 
            `‚ùå <strong>Error al importar datos</strong><br>` +
            `${error.message}<br>` +
            `<small>Los datos del sistema no han sido modificados</small>`, 'error');
        return {
            success: false,
            error: error.message
        };
    }
}

function generateFileInfo(importedData) {
    return {
        usuario: importedData.configuracion.userName || 'No especificado',
        fechaExportacion: importedData.metadata?.fechaExportacionLegible || 'No disponible',
        cajas: importedData.cajas?.length || 0,
        movimientos: importedData.movimientos?.length || 0,
        ediciones: importedData.ediciones?.length || 0,
        saldoInicial: importedData.configuracion.initialBalance || 0,
        fechaInicio: importedData.configuracion.startDateLegible || 'No disponible',
        balanceExportado: importedData.configuracion.balanceActualCalculado || 0,
        version: importedData.metadata?.version || 'Desconocida',
        totalRegistros: (importedData.cajas?.length || 0) + (importedData.movimientos?.length || 0) + (importedData.ediciones?.length || 0)
    };
}

function createSystemBackup() {
    return {
        configuracion: { ...systemConfig },
        cajas: [...boxes],
        movimientos: [...additionalMovements],
        ediciones: [...dayEditions],
        balances: [...dailyBalances],
        timestamp: new Date().toISOString()
    };
}

function executeImport(importedData) {
    try {
        // Importar configuraci√≥n
        systemConfig = {
            initialBalance: importedData.configuracion.initialBalance || 0,
            userName: importedData.configuracion.userName || '',
            currentDay: importedData.configuracion.currentDay || 1,
            startDate: importedData.configuracion.startDate ? 
                new Date(importedData.configuracion.startDate) : new Date()
        };
        
        // Importar cajas (limpiar metadata de exportaci√≥n)
        boxes = (importedData.cajas || []).map(box => ({
            id: box.id || Date.now() + Math.random(),
            type: box.type,
            name: box.name,
            purchaseDay: box.purchaseDay,
            duration: box.duration,
            pricePaid: box.pricePaid,
            originalPrice: box.originalPrice || box.pricePaid,
            discountPercent: box.discountPercent || 0,
            discountAmount: box.discountAmount || 0,
            dailyEarning: box.dailyEarning,
            expiryDay: box.expiryDay,
            status: box.status || 'active',
            dateCreated: box.dateCreated || new Date().toISOString(),
            totalEarningsPotential: box.totalEarningsPotential || (box.dailyEarning * box.duration),
            roi: box.roi || ((box.dailyEarning * box.duration / box.pricePaid) * 100).toFixed(2)
        }));

        // CORRECCI√ìN: Actualizar estados de cajas despu√©s de importaci√≥n
boxes.forEach(box => {
    const currentDay = systemConfig.currentDay || 1;
    
    // Corregir status seg√∫n el d√≠a actual
    if (currentDay < box.purchaseDay) {
        box.status = 'future';
    } else if (currentDay >= box.purchaseDay && currentDay <= box.expiryDay) {
        box.status = 'active';
    } else if (currentDay > box.expiryDay) {
        box.status = 'expired';
    }
    
    // Asegurar que todos los campos requeridos existen
    if (!box.id) box.id = Date.now() + Math.random();
    if (!box.dateCreated) box.dateCreated = new Date().toISOString();
});
        
        // Importar movimientos
        additionalMovements = (importedData.movimientos || []).map(movement => ({
            id: movement.id || Date.now() + Math.random(),
            day: movement.day,
            type: movement.type,
            amount: movement.amount,
            category: movement.category,
            description: movement.description,
            date: movement.date || new Date().toISOString(),
            impact: movement.impact || (movement.type === 'income' ? movement.amount : -movement.amount)
        }));
        
        // Importar ediciones
        dayEditions = (importedData.ediciones || []).map(edition => ({
            id: edition.id || Date.now() + Math.random(),
            day: edition.day,
            originalEarnings: edition.originalEarnings,
            finalEarnings: edition.finalEarnings,
            reason: edition.reason,
            notes: edition.notes,
            date: edition.date || new Date().toISOString()
        }));
        
        // Importar balances diarios si est√°n disponibles - CORREGIDO
if (importedData.balancesDiarios && Array.isArray(importedData.balancesDiarios)) {
    dailyBalances = importedData.balancesDiarios.map(balance => {
        if (balance === null || balance === undefined) {
            return null; // Mantener null para procesamiento posterior
        }
        return typeof balance === 'object' ? balance.balance : balance;
    }).filter(balance => balance !== null); // Filtrar valores null
} else {
    dailyBalances = [];
}
        
        return {
            success: true,
            stats: {
                cajas: boxes.length,
                movimientos: additionalMovements.length,
                ediciones: dayEditions.length,
                balances: dailyBalances.length
            }
        };
    } catch (error) {
        return {
            success: false,
            error: error.message
        };
    }
}

function updateDOMAfterImport() {
    try {
        const inputs = {
            saldoInicial: document.getElementById('saldo-inicial'),
            nombreUsuario: document.getElementById('nombre-usuario'),
            fechaInicio: document.getElementById('fecha-inicio')
        };
        
        if (inputs.saldoInicial) inputs.saldoInicial.value = systemConfig.initialBalance;
        if (inputs.nombreUsuario) inputs.nombreUsuario.value = systemConfig.userName;
        if (inputs.fechaInicio) inputs.fechaInicio.value = systemConfig.startDate.toISOString().split('T')[0];
        
        logMessage('üîß DOM actualizado despu√©s de la importaci√≥n');
    } catch (error) {
        console.error('Error al actualizar DOM despu√©s de importaci√≥n:', error);
    }
}

function restoreSystemBackup(backupData) {
    try {
        systemConfig = backupData.configuracion;
        boxes = backupData.cajas;
        additionalMovements = backupData.movimientos;
        dayEditions = backupData.ediciones;
        dailyBalances = backupData.balances;
        
        logMessage('üîÑ Sistema restaurado desde backup debido a error en importaci√≥n');
    } catch (error) {
        console.error('Error cr√≠tico al restaurar backup:', error);
    }
}

function showImportSuccessAlert(importResult, validationResults) {
    const warningsText = validationResults.warnings.length > 0 ? 
        `<br>‚ö†Ô∏è ${validationResults.warnings.length} advertencias detectadas (revisar consola)` : '';
    
    showAlert('auto-alerts', 
        `üì• <strong>Importaci√≥n completada exitosamente</strong><br>` +
        `üì¶ Cajas importadas: ${importResult.stats.cajas}<br>` +
        `üí∞ Movimientos importados: ${importResult.stats.movimientos}<br>` +
        `‚úèÔ∏è Ediciones importadas: ${importResult.stats.ediciones}<br>` +
        `üìä Balances importados: ${importResult.stats.balances}${warningsText}<br>` +
        `<small>El sistema se ha actualizado completamente con los nuevos datos</small>`, 'success');
    
    if (validationResults.warnings.length > 0) {
        console.group('‚ö†Ô∏è ADVERTENCIAS DE IMPORTACI√ìN');
        validationResults.warnings.forEach(warning => console.warn(warning));
        console.groupEnd();
    }
}

// =====================================================
// VALIDACI√ìN DE DATOS IMPORTADOS
// =====================================================

function validateImportedData() {
    const warnings = [];
    const errors = [];
    
    try {
        // Validar cajas
        boxes.forEach((box, index) => {
            if (!box.id || !box.name || !box.type) {
                warnings.push(`Caja ${index + 1}: Datos b√°sicos incompletos`);
            }
            if (box.purchaseDay > box.expiryDay) {
                warnings.push(`${box.name}: D√≠a de compra posterior al vencimiento`);
            }
            if (box.pricePaid < 0 || box.dailyEarning < 0) {
                warnings.push(`${box.name}: Valores financieros negativos`);
            }
            if (!boxCatalog[box.type]) {
                warnings.push(`${box.name}: Tipo de caja no reconocido (${box.type})`);
            }
            if (box.purchaseDay < 1 || box.purchaseDay > 90) {
                warnings.push(`${box.name}: D√≠a de compra fuera de rango (${box.purchaseDay})`);
            }
            if (box.expiryDay < 1 || box.expiryDay > 90) {
                warnings.push(`${box.name}: D√≠a de vencimiento fuera de rango (${box.expiryDay})`);
            }
        });
        
        // Validar movimientos
        additionalMovements.forEach((movement, index) => {
            if (!movement.day || !movement.type || movement.amount === undefined) {
                warnings.push(`Movimiento ${index + 1}: Datos incompletos`);
            }
            if (movement.day < 1 || movement.day > 90) {
                warnings.push(`Movimiento ${index + 1}: D√≠a fuera de rango (${movement.day})`);
            }
            if (!movementCategories[movement.type]) {
                warnings.push(`Movimiento ${index + 1}: Tipo no reconocido (${movement.type})`);
            } else if (movement.category && !movementCategories[movement.type][movement.category]) {
                warnings.push(`Movimiento ${index + 1}: Categor√≠a no reconocida (${movement.category})`);
            }
            if (movement.amount < 0) {
                warnings.push(`Movimiento ${index + 1}: Monto negativo (${movement.amount})`);
            }
        });
        
        // Validar ediciones
        dayEditions.forEach((edition, index) => {
            if (!edition.day || edition.finalEarnings === undefined) {
                warnings.push(`Edici√≥n ${index + 1}: Datos incompletos`);
            }
            if (edition.day < 1 || edition.day > 90) {
                warnings.push(`Edici√≥n ${index + 1}: D√≠a fuera de rango (${edition.day})`);
            }
            if (edition.finalEarnings < 0) {
                warnings.push(`Edici√≥n ${index + 1}: Ganancia final negativa`);
            }
        });
        
        // Validar configuraci√≥n
        if (!systemConfig.startDate || isNaN(systemConfig.startDate.getTime())) {
            warnings.push('Fecha de inicio no v√°lida, se usar√° la fecha actual');
            systemConfig.startDate = new Date();
        }
        // CORRECCI√ìN: Validar y regenerar balances diarios si es necesario
if (dailyBalances.length === 0 || dailyBalances.some(b => b === null || isNaN(b))) {
    warnings.push('Balances diarios incompletos - se recalcular√°n autom√°ticamente');
    dailyBalances = []; // Limpiar para forzar rec√°lculo
}

// Validar consistencia de balance actual
const calculatedBalance = calculateCurrentBalance();
if (Math.abs(calculatedBalance - (systemConfig.balanceActualCalculado || 0)) > 1) {
    warnings.push(`Balance calculado (${calculatedBalance}) difiere del balance exportado (${systemConfig.balanceActualCalculado || 0})`);
}
        if (systemConfig.initialBalance < 0) {
            warnings.push('Saldo inicial negativo detectado');
        }
        if (systemConfig.currentDay < 1 || systemConfig.currentDay > 90) {
            warnings.push('D√≠a actual fuera de rango, se establecer√° en 1');
            systemConfig.currentDay = 1;
        }
        
        // Validar consistencia entre datos
        const duplicateBoxIds = boxes.map(box => box.id).filter((id, index, arr) => arr.indexOf(id) !== index);
        if (duplicateBoxIds.length > 0) {
            warnings.push(`Se encontraron ${duplicateBoxIds.length} IDs de cajas duplicados`);
        }
        
        const duplicateMovementIds = additionalMovements.map(mov => mov.id).filter((id, index, arr) => arr.indexOf(id) !== index);
        if (duplicateMovementIds.length > 0) {
            warnings.push(`Se encontraron ${duplicateMovementIds.length} IDs de movimientos duplicados`);
        }
        
        // Verificar integridad de datos relacionados
        const movementDays = additionalMovements.map(m => m.day);
        const editionDays = dayEditions.map(e => e.day);
        const overlappingDays = movementDays.filter(day => editionDays.includes(day));
        if (overlappingDays.length > 0) {
            warnings.push(`${overlappingDays.length} d√≠as tienen tanto movimientos como ediciones`);
        }
        
        // Verificar coherencia de fechas
        const boxDays = boxes.map(box => ({ purchase: box.purchaseDay, expiry: box.expiryDay }));
        const inconsistentBoxes = boxDays.filter(box => box.purchase >= box.expiry);
        if (inconsistentBoxes.length > 0) {
            warnings.push(`${inconsistentBoxes.length} cajas con fechas inconsistentes`);
        }
        
        logMessage(`‚úÖ Validaci√≥n completada: ${warnings.length} advertencias, ${errors.length} errores`);
        
        return {
            warnings: warnings,
            errors: errors,
            isValid: errors.length === 0
        };
    } catch (error) {
        console.error('Error en validateImportedData:', error);
        return {
            warnings: ['Error durante la validaci√≥n'],
            errors: ['Error cr√≠tico en validaci√≥n'],
            isValid: false
        };
    }
}

// =====================================================
// FUNCIONES DE UTILIDAD PARA IMPORTACI√ìN
// =====================================================

function createFileInputForImport() {
    try {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.json')) {
                showAlert('auto-alerts', '‚ùå Por favor selecciona un archivo JSON v√°lido', 'error');
                return;
            }
            
            // Verificar tama√±o del archivo (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showAlert('auto-alerts', '‚ùå El archivo es demasiado grande (m√°ximo 10MB)', 'error');
                return;
            }
            
            logMessage(`üìÅ Archivo seleccionado: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    logMessage('üìñ Leyendo contenido del archivo...');
                    importSystemData(e.target.result);
                } catch (error) {
                    showAlert('auto-alerts', '‚ùå Error al procesar el archivo: ' + error.message, 'error');
                }
            };
            reader.onerror = function() {
                showAlert('auto-alerts', '‚ùå Error al leer el archivo seleccionado', 'error');
            };
            
            // Mostrar progreso de lectura
            showAlert('auto-alerts', 'üìñ Leyendo archivo...', 'info');
            reader.readAsText(file);
        });
        
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
        
    } catch (error) {
        console.error('Error en createFileInputForImport:', error);
        showAlert('auto-alerts', '‚ùå Error al crear el selector de archivos', 'error');
    }
}

function promptImportData() {
    const confirmImport = confirm(
        'üì• IMPORTAR DATOS DEL SISTEMA\n\n' +
        '¬øQu√© deseas hacer?\n\n' +
        '‚úÖ OK = Seleccionar archivo para importar\n' +
        '‚ùå Cancelar = Volver al sistema\n\n' +
        '‚ö†Ô∏è ADVERTENCIA IMPORTANTE:\n' +
        '‚Ä¢ La importaci√≥n reemplazar√° TODOS los datos actuales\n' +
        '‚Ä¢ Esta acci√≥n NO se puede deshacer\n' +
        '‚Ä¢ Se recomienda exportar primero tus datos actuales\n' +
        '‚Ä¢ Solo archivos JSON de VIVABOX son compatibles'
    );
    
    if (confirmImport) {
        // Ofrecer exportar primero
        const exportFirst = confirm(
            'üíæ ¬øQuieres exportar tus datos actuales primero como respaldo?\n\n' +
            '‚úÖ OK = Exportar primero, luego importar\n' +
            '‚ùå Cancelar = Continuar solo con importaci√≥n'
        );
        
        if (exportFirst) {
            const exportResult = exportSystemData();
            if (exportResult.success) {
                setTimeout(() => {
                    createFileInputForImport();
                }, 1000);
            }
        } else {
            createFileInputForImport();
        }
    }
}

// =====================================================
// FUNCIONES DE RECUPERACI√ìN Y RESPALDO
// =====================================================

function createEmergencyBackup() {
    try {
        const backupData = {
            metadata: {
                tipo: 'Respaldo de Emergencia VIVABOX',
                fechaCreacion: new Date().toISOString(),
                fechaLegible: new Date().toLocaleString('es-ES'),
                usuario: systemConfig.userName || 'No especificado',
                proposito: 'Respaldo autom√°tico de emergencia',
                version: '1.0'
            },
            sistema: createSystemBackup(),
            checksum: generateDataChecksum()
        };
        
        // Guardar en localStorage como respaldo adicional
        try {
            localStorage.setItem('vivabox_emergency_backup', JSON.stringify(backupData));
            logMessage('üíæ Respaldo de emergencia guardado en localStorage');
        } catch (storageError) {
            console.warn('No se pudo guardar en localStorage:', storageError);
        }
        
        return backupData;
    } catch (error) {
        console.error('Error al crear respaldo de emergencia:', error);
        return null;
    }
}

function generateDataChecksum() {
    try {
        const dataString = JSON.stringify({
            cajas: boxes.length,
            movimientos: additionalMovements.length,
            ediciones: dayEditions.length,
            saldo: systemConfig.initialBalance,
            usuario: systemConfig.userName
        });
        
        // Simple checksum usando charCodeAt
        let checksum = 0;
        for (let i = 0; i < dataString.length; i++) {
            checksum += dataString.charCodeAt(i);
        }
        
        return checksum.toString(16);
    } catch (error) {
        return 'error';
    }
}

function recoverFromEmergencyBackup() {
    try {
        const backupData = localStorage.getItem('vivabox_emergency_backup');
        if (!backupData) {
            showAlert('auto-alerts', '‚ùå No se encontr√≥ respaldo de emergencia', 'error');
            return false;
        }
        
        const confirmRecover = confirm(
            'üö® RECUPERAR DESDE RESPALDO DE EMERGENCIA\n\n' +
            '¬øEst√°s seguro de que quieres restaurar desde el respaldo de emergencia?\n' +
            'Esto reemplazar√° todos los datos actuales.\n\n' +
            '‚úÖ OK = Restaurar respaldo\n' +
            '‚ùå Cancelar = Mantener datos actuales'
        );
        
        if (!confirmRecover) return false;
        
        const parsed = JSON.parse(backupData);
        if (parsed.sistema) {
            restoreSystemBackup(parsed.sistema);
            updateAllCalculations();
            
            showAlert('auto-alerts', 
                'üö® <strong>Sistema restaurado desde respaldo de emergencia</strong><br>' +
                'Los datos han sido recuperados exitosamente.<br>' +
                '<small>Verifica que toda la informaci√≥n est√© correcta</small>', 'warning');
            
            logMessage('üö® Sistema restaurado desde respaldo de emergencia');
            return true;
        }
        
        return false;
    } catch (error) {
        console.error('Error al recuperar respaldo de emergencia:', error);
        showAlert('auto-alerts', '‚ùå Error al recuperar respaldo de emergencia', 'error');
        return false;
    }
}

// Funci√≥n espec√≠fica para bot√≥n de importaci√≥n
function startImportProcess() {
    try {
        logMessage('üì• Iniciando proceso de importaci√≥n desde bot√≥n...');
        
        // Crear input file de forma m√°s simple
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.style.display = 'none';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) {
                logMessage('üì• No se seleccion√≥ archivo');
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                alert('‚ùå Solo se permiten archivos JSON');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    importSystemData(event.target.result);
                } catch (error) {
                    alert('‚ùå Error al procesar archivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        
        // Trigger del input
        document.body.appendChild(input);
        input.click();
        document.body.removeChild(input);
        
    } catch (error) {
        console.error('Error en startImportProcess:', error);
        alert('‚ùå Error al iniciar importaci√≥n: ' + error.message);
    }
}

// =====================================================
// FIN DEL M√ìDULO 7B2B-2A - IMPORTACI√ìN B√ÅSICA
// =====================================================


// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7B2B-2B
// UTILIDADES Y DIAGN√ìSTICO - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// FUNCIONES DE DIAGN√ìSTICO DEL SISTEMA
// =====================================================

function runSystemDiagnostics() {
    try {
        logMessage('üîç Ejecutando diagn√≥stico completo del sistema...');
        
        const diagnostics = {
            fecha: new Date().toLocaleString('es-ES'),
            configuracion: validateSystemConfig(),
            datos: validateSystemData(),
            integridad: checkDataIntegrity(),
            rendimiento: analyzeSystemPerformance(),
            recomendaciones: generateSystemRecommendations()
        };
        
        console.group('üîç DIAGN√ìSTICO COMPLETO DEL SISTEMA VIVABOX');
        console.log('üìÖ Fecha del diagn√≥stico:', diagnostics.fecha);
        console.log('‚öôÔ∏è Estado de configuraci√≥n:', diagnostics.configuracion);
        console.log('üìä Validaci√≥n de datos:', diagnostics.datos);
        console.log('üîó Integridad del sistema:', diagnostics.integridad);
        console.log('‚ö° An√°lisis de rendimiento:', diagnostics.rendimiento);
        console.log('üí° Recomendaciones:', diagnostics.recomendaciones);
        console.groupEnd();
        
        const issuesCount = (diagnostics.configuracion.issues || []).length + 
                           (diagnostics.datos.issues || []).length + 
                           (diagnostics.integridad.issues || []).length;
        
        showAlert('auto-alerts', 
            `üîç <strong>Diagn√≥stico completado</strong><br>` +
            `${issuesCount === 0 ? '‚úÖ Sistema en perfecto estado' : `‚ö†Ô∏è ${issuesCount} problemas detectados`}<br>` +
            `<small>Revisa la consola (F12) para ver el informe completo</small>`, 
            issuesCount === 0 ? 'success' : 'warning');
        
        logMessage(`üîç Diagn√≥stico completado: ${issuesCount} problemas detectados`);
        
        return diagnostics;
    } catch (error) {
        console.error('Error en runSystemDiagnostics:', error);
        showAlert('auto-alerts', '‚ùå Error durante el diagn√≥stico del sistema', 'error');
        return null;
    }
}

function validateSystemConfig() {
    const issues = [];
    
    if (!systemConfig.startDate || isNaN(systemConfig.startDate.getTime())) {
        issues.push('Fecha de inicio no v√°lida');
    }
    if (systemConfig.initialBalance < 0) {
        issues.push('Saldo inicial negativo');
    }
    if (!systemConfig.userName || systemConfig.userName.trim() === '') {
        issues.push('Nombre de usuario no establecido');
    }
    if (systemConfig.currentDay < 1 || systemConfig.currentDay > 90) {
        issues.push('D√≠a actual fuera de rango v√°lido');
    }
    
    return {
        valid: issues.length === 0,
        issues: issues,
        status: issues.length === 0 ? 'OK' : 'PROBLEMAS DETECTADOS'
    };
}

function validateSystemData() {
    const issues = [];
    
    // Validar duplicados
    const boxIds = boxes.map(box => box.id);
    const duplicateBoxIds = boxIds.filter((id, index) => boxIds.indexOf(id) !== index);
    if (duplicateBoxIds.length > 0) {
        issues.push(`${duplicateBoxIds.length} IDs de cajas duplicados`);
    }
    
    const movementIds = additionalMovements.map(mov => mov.id);
    const duplicateMovIds = movementIds.filter((id, index) => movementIds.indexOf(id) !== index);
    if (duplicateMovIds.length > 0) {
        issues.push(`${duplicateMovIds.length} IDs de movimientos duplicados`);
    }
    
    // Validar rangos
    const invalidBoxDays = boxes.filter(box => 
        box.purchaseDay < 1 || box.purchaseDay > 90 || 
        box.expiryDay < 1 || box.expiryDay > 90
    );
    if (invalidBoxDays.length > 0) {
        issues.push(`${invalidBoxDays.length} cajas con d√≠as fuera de rango`);
    }
    
    const invalidMovDays = additionalMovements.filter(mov => 
        mov.day < 1 || mov.day > 90
    );
    if (invalidMovDays.length > 0) {
        issues.push(`${invalidMovDays.length} movimientos con d√≠as fuera de rango`);
    }
    
    return {
        valid: issues.length === 0,
        issues: issues,
        status: issues.length === 0 ? 'OK' : 'PROBLEMAS DETECTADOS',
        totalCajas: boxes.length,
        totalMovimientos: additionalMovements.length,
        totalEdiciones: dayEditions.length
    };
}

function checkDataIntegrity() {
    const issues = [];
    
    try {
        // Verificar consistencia de fechas
        boxes.forEach(box => {
            if (box.purchaseDay >= box.expiryDay) {
                issues.push(`Caja ${box.name}: fecha de compra posterior al vencimiento`);
            }
        });
        
        // Verificar tipos de caja v√°lidos
        boxes.forEach(box => {
            if (!boxCatalog[box.type]) {
                issues.push(`Caja ${box.name}: tipo no reconocido (${box.type})`);
            }
        });
        
        // Verificar categor√≠as de movimientos
        additionalMovements.forEach(movement => {
            if (!movementCategories[movement.type] || !movementCategories[movement.type][movement.category]) {
                issues.push(`Movimiento d√≠a ${movement.day}: categor√≠a no v√°lida`);
            }
        });
        
        // Verificar balances calculados
        const calculatedBalance = calculateCurrentBalance();
        if (isNaN(calculatedBalance)) {
            issues.push('Error en c√°lculo de balance actual');
        }
        
        return {
            valid: issues.length === 0,
            issues: issues,
            status: issues.length === 0 ? '√çNTEGRO' : 'PROBLEMAS DE INTEGRIDAD'
        };
    } catch (error) {
        return {
            valid: false,
            issues: ['Error al verificar integridad'],
            status: 'ERROR EN VERIFICACI√ìN'
        };
    }
}

function analyzeSystemPerformance() {
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const currentBalance = calculateCurrentBalance();
        
        return {
            cajasActivas: activeBoxes.length,
            inversionTotal: totalInvestment,
            gananciasDiarias: dailyEarnings,
            balanceActual: currentBalance,
            roiPromedio: totalInvestment > 0 ? ((dailyEarnings / totalInvestment) * 100).toFixed(2) + '%' : '0%',
            crecimiento: systemConfig.initialBalance > 0 ? 
                (((currentBalance - systemConfig.initialBalance) / systemConfig.initialBalance) * 100).toFixed(2) + '%' : '0%',
            status: activeBoxes.length > 0 ? 'OPERATIVO' : 'INACTIVO'
        };
    } catch (error) {
        return {
            status: 'ERROR EN AN√ÅLISIS',
            error: error.message
        };
    }
}

function generateSystemRecommendations() {
    const recommendations = [];
    
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const currentDay = systemConfig.currentDay || 1;
        
        // Recomendaciones de configuraci√≥n
        if (!systemConfig.userName) {
            recommendations.push('Establece un nombre de usuario en Configuraci√≥n');
        }
        
        // Recomendaciones de cajas
        if (activeBoxes.length === 0) {
            recommendations.push('No tienes cajas activas - considera agregar tu primera inversi√≥n');
        } else {
            const expiringBoxes = activeBoxes.filter(box => box.expiryDay - currentDay <= 7);
            if (expiringBoxes.length > 0) {
                recommendations.push(`${expiringBoxes.length} caja(s) vencen pronto - planifica renovaciones`);
            }
            
            const uniqueTypes = [...new Set(activeBoxes.map(box => box.type))];
            if (uniqueTypes.length === 1) {
                recommendations.push('Considera diversificar en diferentes tipos de cajas');
            }
        }
        
        // Recomendaciones de rendimiento
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const avgROI = totalInvestment > 0 ? (dailyEarnings / totalInvestment) * 100 : 0;
        
        if (avgROI < 4) {
            recommendations.push('ROI promedio bajo - considera cajas de mayor rendimiento');
        }
        
        if (totalInvestment > systemConfig.initialBalance * 0.9) {
            recommendations.push('Mant√©n al menos 10% como reserva de liquidez');
        }
        
        if (recommendations.length === 0) {
            recommendations.push('Sistema optimizado - mant√©n la estrategia actual');
        }
        
        return recommendations;
    } catch (error) {
        return ['Error al generar recomendaciones'];
    }
}

// =====================================================
// FUNCIONES DE UTILIDAD AVANZADAS
// =====================================================

function resetSystemToDefaults() {
    const confirmReset = confirm(
        'üîÑ RESTABLECER SISTEMA A VALORES PREDETERMINADOS\n\n' +
        '‚ö†Ô∏è ADVERTENCIA CR√çTICA:\n' +
        '‚Ä¢ Se eliminar√°n TODAS las cajas\n' +
        '‚Ä¢ Se eliminar√°n TODOS los movimientos\n' +
        '‚Ä¢ Se eliminar√°n TODAS las ediciones\n' +
        '‚Ä¢ La configuraci√≥n volver√° a valores iniciales\n' +
        '‚Ä¢ Esta acci√≥n NO se puede deshacer\n\n' +
        '¬øEst√°s ABSOLUTAMENTE SEGURO de continuar?'
    );
    
    if (confirmReset) {
        const doubleConfirm = confirm(
            'üö® CONFIRMACI√ìN FINAL\n\n' +
            'Esta es tu √∫ltima oportunidad para cancelar.\n' +
            'Una vez confirmado, NO hay forma de recuperar los datos.\n\n' +
            '¬øContinuar con el restablecimiento completo?'
        );
        
        if (doubleConfirm) {
            try {
                // Crear respaldo de emergencia antes del reset
                createEmergencyBackup();
                
                // Restablecer todas las variables globales
                systemConfig = {
                    initialBalance: 0,
                    startDate: new Date(),
                    userName: '',
                    currentDay: 1
                };
                
                boxes = [];
                additionalMovements = [];
                dayEditions = [];
                dailyBalances = [];
                
                // Limpiar formularios en el DOM
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'number' || input.type === 'text' || input.type === 'email') {
                        input.value = '';
                    } else if (input.type === 'date') {
                        input.value = new Date().toISOString().split('T')[0];
                    } else if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0;
                    } else if (input.tagName === 'TEXTAREA') {
                        input.value = '';
                    }
                });
                
                // Actualizar todo el sistema
                updateAllCalculations();
                
                showAlert('auto-alerts', 
                    'üîÑ <strong>Sistema restablecido exitosamente</strong><br>' +
                    'Todos los datos han sido eliminados y la configuraci√≥n se ha restaurado a valores predeterminados.<br>' +
                    '<small>Se cre√≥ un respaldo de emergencia antes del restablecimiento</small>', 'warning');
                
                logMessage('üîÑ Sistema restablecido completamente a valores predeterminados');
                
                // Cambiar a pesta√±a de configuraci√≥n
                setTimeout(() => {
                    const configTab = document.querySelector('[onclick*="configuracion"]');
                    if (configTab) configTab.click();
                }, 500);
                
            } catch (error) {
                console.error('Error durante el restablecimiento:', error);
                showAlert('auto-alerts', '‚ùå Error durante el restablecimiento del sistema', 'error');
            }
        }
    }
}

function createSystemBackupForDownload() {
    try {
        const timestamp = new Date().toISOString();
        const backupData = {
            metadata: {
                tipo: 'Respaldo Manual del Sistema VIVABOX',
                fechaCreacion: timestamp,
                fechaLegible: new Date().toLocaleString('es-ES'),
                usuario: systemConfig.userName || 'No especificado',
                proposito: 'Respaldo manual solicitado por usuario',
                version: '1.0'
            },
            sistema: createSystemBackup(),
            configuracionActual: {
                ...systemConfig,
                startDate: systemConfig.startDate ? systemConfig.startDate.toISOString() : null
            },
            estadisticas: {
                totalCajas: boxes.length,
                totalMovimientos: additionalMovements.length,
                totalEdiciones: dayEditions.length,
                balanceActual: calculateCurrentBalance(),
                cajasActivas: boxes.filter(box => box.status === 'active').length
            },
            checksum: generateDataChecksum()
        };
        
        const dataStr = JSON.stringify(backupData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const filename = `vivabox_respaldo_manual_${new Date().toISOString().split('T')[0]}_${new Date().toTimeString().split(' ')[0].replace(/:/g, '-')}.json`;
        
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        
        showAlert('auto-alerts', 
            `üíæ <strong>Respaldo manual creado</strong><br>` +
            `üìÅ Archivo: ${filename}<br>` +
            `<small>Guarda este archivo en un lugar seguro</small>`, 'success');
        
        logMessage(`üíæ Respaldo manual creado: ${filename}`);
        return { success: true, filename };
    } catch (error) {
        console.error('Error al crear respaldo manual:', error);
        showAlert('auto-alerts', '‚ùå Error al crear respaldo manual', 'error');
        return { success: false, error: error.message };
    }
}

function optimizeSystemPerformance() {
    try {
        logMessage('‚ö° Optimizando rendimiento del sistema...');
        
        let optimizationsApplied = 0;
        const optimizations = [];
        
        // Limpiar IDs duplicados
        const uniqueBoxes = [];
        const seenBoxIds = new Set();
        boxes.forEach(box => {
            if (!seenBoxIds.has(box.id)) {
                seenBoxIds.add(box.id);
                uniqueBoxes.push(box);
            } else {
                optimizationsApplied++;
                optimizations.push(`Eliminado duplicado de caja: ${box.name}`);
            }
        });
        boxes = uniqueBoxes;
        
        // Limpiar movimientos duplicados
        const uniqueMovements = [];
        const seenMovIds = new Set();
        additionalMovements.forEach(movement => {
            if (!seenMovIds.has(movement.id)) {
                seenMovIds.add(movement.id);
                uniqueMovements.push(movement);
            } else {
                optimizationsApplied++;
                optimizations.push(`Eliminado movimiento duplicado del d√≠a ${movement.day}`);
            }
        });
        additionalMovements = uniqueMovements;
        
        // Actualizar estados de cajas
        const currentDay = systemConfig.currentDay || 1;
        boxes.forEach(box => {
            if (box.expiryDay < currentDay && box.status !== 'expired') {
                box.status = 'expired';
                optimizationsApplied++;
                optimizations.push(`Actualizado estado de ${box.name} a vencida`);
            }
        });
        
        // Limpiar balances diarios redundantes
        if (dailyBalances.length > 90) {
            dailyBalances = dailyBalances.slice(0, 90);
            optimizationsApplied++;
            optimizations.push('Limpiados balances diarios redundantes');
        }
        
        // Validar y corregir datos inconsistentes
        boxes.forEach(box => {
            if (box.purchaseDay > box.expiryDay) {
                box.expiryDay = box.purchaseDay + box.duration - 1;
                optimizationsApplied++;
                optimizations.push(`Corregidas fechas de ${box.name}`);
            }
        });
        
        // Recalcular todo despu√©s de optimizaciones
        if (optimizationsApplied > 0) {
            updateAllCalculations();
        }
        
        // Mostrar resultados
        if (optimizationsApplied > 0) {
            console.group('‚ö° OPTIMIZACIONES APLICADAS');
            optimizations.forEach(opt => console.log('‚úÖ ' + opt));
            console.groupEnd();
            
            showAlert('auto-alerts', 
                `‚ö° <strong>Sistema optimizado</strong><br>` +
                `‚úÖ ${optimizationsApplied} optimizaciones aplicadas<br>` +
                `<small>Revisa la consola para ver los detalles</small>`, 'success');
        } else {
            showAlert('auto-alerts', 
                `‚ö° <strong>Sistema ya optimizado</strong><br>` +
                `‚úÖ No se requieren optimizaciones<br>` +
                `<small>El sistema est√° funcionando eficientemente</small>`, 'info');
        }
        
        logMessage(`‚ö° Optimizaci√≥n completada: ${optimizationsApplied} mejoras aplicadas`);
        
        return {
            success: true,
            optimizationsApplied: optimizationsApplied,
            optimizations: optimizations
        };
    } catch (error) {
        console.error('Error en optimizeSystemPerformance:', error);
        showAlert('auto-alerts', '‚ùå Error durante la optimizaci√≥n del sistema', 'error');
        return {
            success: false,
            error: error.message
        };
    }
}

// =====================================================
// FUNCIONES DE INFORMACI√ìN DEL SISTEMA
// =====================================================

function showSystemInfo() {
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const systemInfo = {
            version: '1.0',
            fechaActual: new Date().toLocaleString('es-ES'),
            usuario: systemConfig.userName || 'No establecido',
            diaActual: systemConfig.currentDay || 1,
            fechaInicio: systemConfig.startDate ? systemConfig.startDate.toLocaleDateString('es-ES') : 'No establecida',
            
            estadisticas: {
                totalCajas: boxes.length,
                cajasActivas: activeBoxes.length,
                cajasVencidas: boxes.filter(box => box.status === 'expired').length,
                totalMovimientos: additionalMovements.length,
                totalEdiciones: dayEditions.length
            },
            
            rendimiento: {
                balanceActual: calculateCurrentBalance(),
                saldoInicial: systemConfig.initialBalance,
                inversionActiva: activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0),
                gananciasDiarias: activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0)
            },
            
            navegador: {
                userAgent: navigator.userAgent,
                plataforma: navigator.platform,
                idioma: navigator.language,
                cookiesHabilitadas: navigator.cookieEnabled
            }
        };
        
        console.group('‚ÑπÔ∏è INFORMACI√ìN DEL SISTEMA VIVABOX');
        console.log('üì¶ Versi√≥n:', systemInfo.version);
        console.log('üë§ Usuario:', systemInfo.usuario);
        console.log('üìÖ Fecha actual:', systemInfo.fechaActual);
        console.log('üéØ D√≠a del sistema:', systemInfo.diaActual);
        console.log('üìä Estad√≠sticas:', systemInfo.estadisticas);
        console.log('üí∞ Rendimiento:', systemInfo.rendimiento);
        console.log('üåê Navegador:', systemInfo.navegador);
        console.groupEnd();
        
        showAlert('auto-alerts', 
            `‚ÑπÔ∏è <strong>Informaci√≥n del sistema</strong><br>` +
            `üì¶ Versi√≥n: ${systemInfo.version}<br>` +
            `üë§ Usuario: ${systemInfo.usuario}<br>` +
            `üìä Cajas activas: ${systemInfo.estadisticas.cajasActivas}/${systemInfo.estadisticas.totalCajas}<br>` +
            `<small>Informaci√≥n completa disponible en la consola (F12)</small>`, 'info');
        
        return systemInfo;
    } catch (error) {
        console.error('Error en showSystemInfo:', error);
        showAlert('auto-alerts', '‚ùå Error al obtener informaci√≥n del sistema', 'error');
        return null;
    }
}

function checkSystemHealth() {
    try {
        const healthCheck = {
            timestamp: new Date().toISOString(),
            general: 'SALUDABLE',
            issues: [],
            warnings: [],
            score: 100
        };
        
        // Verificar configuraci√≥n
        if (!systemConfig.userName) {
            healthCheck.warnings.push('Usuario no configurado');
            healthCheck.score -= 10;
        }
        
        if (systemConfig.initialBalance <= 0) {
            healthCheck.warnings.push('Saldo inicial no establecido');
            healthCheck.score -= 15;
        }
        
        // Verificar datos
        const activeBoxes = boxes.filter(box => box.status === 'active');
        if (activeBoxes.length === 0) {
            healthCheck.warnings.push('No hay cajas activas');
            healthCheck.score -= 20;
        }
        
        // Verificar integridad
        const duplicateIds = boxes.map(box => box.id).filter((id, index, arr) => arr.indexOf(id) !== index);
        if (duplicateIds.length > 0) {
            healthCheck.issues.push('IDs duplicados detectados');
            healthCheck.score -= 25;
        }
        
        // Verificar rendimiento
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const avgROI = totalInvestment > 0 ? (dailyEarnings / totalInvestment) * 100 : 0;
        
        if (avgROI < 3) {
            healthCheck.warnings.push('ROI promedio bajo');
            healthCheck.score -= 15;
        }
        
        // Determinar estado general
        if (healthCheck.score >= 90) {
            healthCheck.general = 'EXCELENTE';
        } else if (healthCheck.score >= 70) {
            healthCheck.general = 'BUENO';
        } else if (healthCheck.score >= 50) {
            healthCheck.general = 'REGULAR';
        } else {
            healthCheck.general = 'REQUIERE ATENCI√ìN';
        }
        
        const statusColor = healthCheck.score >= 80 ? 'success' : 
                           healthCheck.score >= 60 ? 'warning' : 'error';
        
        showAlert('auto-alerts', 
            `üè• <strong>Estado de salud del sistema</strong><br>` +
            `üìä Puntuaci√≥n: ${healthCheck.score}/100<br>` +
            `üéØ Estado: ${healthCheck.general}<br>` +
            `‚ö†Ô∏è Advertencias: ${healthCheck.warnings.length}<br>` +
            `‚ùå Problemas: ${healthCheck.issues.length}`, statusColor);
        
        console.group('üè• CHEQUEO DE SALUD DEL SISTEMA');
        console.log('üìä Puntuaci√≥n general:', healthCheck.score + '/100');
        console.log('üéØ Estado:', healthCheck.general);
        if (healthCheck.warnings.length > 0) {
            console.warn('‚ö†Ô∏è Advertencias:', healthCheck.warnings);
        }
        if (healthCheck.issues.length > 0) {
            console.error('‚ùå Problemas:', healthCheck.issues);
        }
        console.groupEnd();
        
        logMessage(`üè• Chequeo de salud completado: ${healthCheck.score}/100 - ${healthCheck.general}`);
        
        return healthCheck;
    } catch (error) {
        console.error('Error en checkSystemHealth:', error);
        showAlert('auto-alerts', '‚ùå Error durante el chequeo de salud', 'error');
        return null;
    }
}

// =====================================================
// FUNCIONES DE UTILIDAD FINAL
// =====================================================

function clearSystemLogs() {
    try {
        console.clear();
        logMessage('üßπ Logs del sistema limpiados');
        showAlert('auto-alerts', 'üßπ Logs del sistema limpiados', 'info');
    } catch (error) {
        console.error('Error al limpiar logs:', error);
    }
}

function showKeyboardShortcuts() {
    const shortcuts = [
        'üîß F12 = Abrir/cerrar consola del navegador',
        'üíæ Ctrl+S = Guardar p√°gina (√∫til para respaldos)',
        'üîÑ F5 = Recargar p√°gina',
        'üîç Ctrl+F = Buscar en p√°gina',
        'üìä Ctrl+Shift+I = Herramientas de desarrollador',
        'üñ®Ô∏è Ctrl+P = Imprimir p√°gina actual'
    ];
    
    console.group('‚å®Ô∏è ATAJOS DE TECLADO √öTILES');
    shortcuts.forEach(shortcut => console.log(shortcut));
    console.groupEnd();
    
    alert('‚å®Ô∏è ATAJOS DE TECLADO √öTILES:\n\n' + shortcuts.join('\n'));
}

// =====================================================
// FIN DEL M√ìDULO 7B2B-2B - UTILIDADES Y DIAGN√ìSTICO
// =====================================================



// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7C1
// MOVIMIENTOS ADICIONALES - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// FUNCI√ìN PRINCIPAL DE ACTUALIZACI√ìN DE MOVIMIENTOS
// =====================================================

function updateMovimientosDisplay() {
    try {
        updateMovementsSummary();
        updateMovementsTable();
        updateMovementPreview();
        setupMovementPreviewListeners();
        updateEditionsTable(); // AGREGAR esta l√≠nea
        setupEditFormListeners(); // AGREGAR esta l√≠nea
        logMessage('üí∞ Display de movimientos actualizado completamente');
    } catch (error) {
        console.error('Error en updateMovimientosDisplay:', error);
        showAlert('mov-alerts', '‚ùå Error al actualizar movimientos', 'error');
    }
}

// =====================================================
// FUNCIONES DE CATEGOR√çAS Y FORMULARIOS
// =====================================================

function updateMovementCategories() {
    try {
        const type = document.getElementById('mov-type').value;
        const categorySelect = document.getElementById('mov-category');
        if (!categorySelect) return;
        
        categorySelect.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';
        
        if (type && movementCategories[type]) {
            Object.entries(movementCategories[type]).forEach(([key, value]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value;
                categorySelect.appendChild(option);
            });
        }
        
        // Actualizar vista previa al cambiar categor√≠a
        updateMovementPreview();
    } catch (error) {
        console.error('Error en updateMovementCategories:', error);
    }
}

function updateMovementPreview() {
    try {
        const day = parseInt(document.getElementById('mov-day').value) || 0;
        const type = document.getElementById('mov-type').value;
        const amount = parseFloat(document.getElementById('mov-amount').value) || 0;
        
        if (day > 0 && day <= 90 && type && amount > 0) {
            // CORRECCI√ìN: Calcular balance HASTA el d√≠a seleccionado (no el anterior)
            const balanceBefore = calculateBalanceAtDay(day);
            
            // Calcular el movimiento (positivo para ingreso, negativo para egreso)
            const movementValue = type === 'income' ? amount : -amount;
            const balanceAfter = balanceBefore + movementValue;
            
            // Actualizar elementos de vista previa (SIN impacto total)
            const elements = {
                before: document.getElementById('mov-balance-before'),
                movement: document.getElementById('mov-movement-value'),
                after: document.getElementById('mov-balance-after')
            };
            
            // Saldo Antes - Balance del d√≠a seleccionado
            if (elements.before) {
                elements.before.textContent = `$${balanceBefore.toLocaleString()}`;
                elements.before.style.color = balanceBefore >= 0 ? '#1976d2' : '#d32f2f';
            }
            
            // Movimiento - Monto con signo apropiado
            if (elements.movement) {
                elements.movement.textContent = `${type === 'income' ? '+' : '-'}$${amount.toLocaleString()}`;
                elements.movement.style.color = type === 'income' ? '#28a745' : '#dc3545';
                elements.movement.style.fontWeight = 'bold';
            }
            
            // Saldo Despu√©s - Resultado de la operaci√≥n
            if (elements.after) {
                elements.after.textContent = `$${balanceAfter.toLocaleString()}`;
                elements.after.style.color = balanceAfter >= 0 ? '#28a745' : '#dc3545';
                elements.after.style.fontWeight = 'bold';
            }
            
        } else {
            // Limpiar vista previa si no hay datos v√°lidos
            clearMovementPreview();
        }
    } catch (error) {
        console.error('Error en updateMovementPreview:', error);
    }
}

function calculateBalanceAtDay(day) {
    try {
        if (day < 1) return systemConfig.initialBalance;
        
        let balance = systemConfig.initialBalance;
        
        for (let d = 1; d <= day; d++) {
            let dayEarnings = 0;
            let dayExpenses = 0;
            
            // CORRECCI√ìN: Procesar TODAS las cajas sin filtrar por status
            boxes.forEach(box => {
                // Ganancias: si el d√≠a est√° en el rango de la caja Y la caja genera ganancias
                if (d >= box.purchaseDay && d <= box.expiryDay && box.dailyEarning > 0) {
                    dayEarnings += box.dailyEarning;
                }
                // Gastos: si es el d√≠a de compra
                if (d === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                }
            });
            
            // Movimientos adicionales del d√≠a actual
            additionalMovements.filter(m => m.day === d).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                } else {
                    dayExpenses += movement.amount;
                }
            });
            
            // Aplicar ediciones de d√≠as
            const dayEdit = dayEditions.find(e => e.day === d);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
            }
            
            balance = balance + dayEarnings - dayExpenses;
        }
        
        return Math.round(balance);
    } catch (error) {
        console.error('Error en calculateBalanceAtDay:', error);
        return systemConfig.initialBalance;
    }
}

function clearMovementPreview() {
    try {
        // CORRECCI√ìN: Eliminar referencia a 'mov-total-impact'
        const previewElements = ['mov-balance-before', 'mov-movement-value', 'mov-balance-after'];
        previewElements.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = '$0';
                el.style.color = '#1976d2';
                el.style.fontWeight = 'normal';
            }
        });
    } catch (error) {
        console.error('Error en clearMovementPreview:', error);
    }
}

// =====================================================
// FUNCI√ìN PRINCIPAL - AGREGAR MOVIMIENTO
// =====================================================

function addMovement() {
    try {
        const day = parseInt(document.getElementById('mov-day').value);
        const type = document.getElementById('mov-type').value;
        const amount = parseFloat(document.getElementById('mov-amount').value);
        const category = document.getElementById('mov-category').value;
        const description = document.getElementById('mov-description').value;
        
        // Validaciones exhaustivas
        if (!day || day < 1 || day > 90) {
            showAlert('mov-alerts', '‚ùå El d√≠a debe estar entre 1 y 90', 'error');
            return;
        }
        
        if (!type) {
            showAlert('mov-alerts', '‚ùå Debe seleccionar el tipo de movimiento', 'error');
            return;
        }
        
        if (!amount || amount <= 0) {
            showAlert('mov-alerts', '‚ùå El monto debe ser mayor a 0', 'error');
            return;
        }
        
        if (!category) {
            showAlert('mov-alerts', '‚ùå Debe seleccionar una categor√≠a', 'error');
            return;
        }
        
        if (!description || description.trim() === '') {
            showAlert('mov-alerts', '‚ùå Debe proporcionar una descripci√≥n', 'error');
            return;
        }
        
        // Validar que el monto no sea excesivo
        if (amount > 1000000) {
            showAlert('mov-alerts', '‚ùå El monto no puede exceder $1,000,000', 'error');
            return;
        }
        
        // Validar categor√≠a existe
        if (!movementCategories[type] || !movementCategories[type][category]) {
            showAlert('mov-alerts', '‚ùå Categor√≠a no v√°lida para el tipo seleccionado', 'error');
            return;
        }
        
        // Verificar si ya existe un movimiento similar el mismo d√≠a
        const similarMovement = additionalMovements.find(m => 
            m.day === day && 
            m.type === type && 
            m.amount === amount && 
            m.category === category
        );
        
        if (similarMovement) {
            const confirmDuplicate = confirm(
                `‚ö†Ô∏è POSIBLE MOVIMIENTO DUPLICADO\n\n` +
                `Ya existe un ${type === 'income' ? 'ingreso' : 'egreso'} similar:\n` +
                `‚Ä¢ D√≠a: ${day}\n` +
                `‚Ä¢ Monto: $${amount.toLocaleString()}\n` +
                `‚Ä¢ Categor√≠a: ${movementCategories[type][category]}\n\n` +
                `¬øContinuar de todas formas?`
            );
            
            if (!confirmDuplicate) {
                return;
            }
        }
        
        // Crear nuevo movimiento
        const newMovement = {
            id: Date.now() + Math.random(),
            day: day,
            type: type,
            amount: amount,
            category: category,
            description: description.trim(),
            date: new Date().toISOString(),
            impact: type === 'income' ? amount : -amount,
            categoryName: movementCategories[type][category],
            dayDate: systemConfig.startDate ? 
                new Date(systemConfig.startDate.getTime() + (day - 1) * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES') : 
                'Fecha no calculable'
        };
        
        additionalMovements.push(newMovement);
        
        // Actualizar displays y recalcular
        updateMovimientosDisplay();
        updateAllCalculations();
        clearMovementForm();
        
        // Mostrar confirmaci√≥n con detalles
        const balanceImpact = calculateBalanceAtDay(day) - calculateBalanceAtDay(day - 1);
        
        showAlert('mov-alerts', 
            `‚úÖ <strong>${type === 'income' ? 'Ingreso' : 'Egreso'} agregado exitosamente</strong><br>` +
            `üìÖ D√≠a: ${day} | üí∞ Monto: ${type === 'income' ? '+' : '-'}$${amount.toLocaleString()}<br>` +
            `üè∑Ô∏è Categor√≠a: ${movementCategories[type][category]}<br>` +
            `üìä Impacto en balance: ${balanceImpact >= 0 ? '+' : ''}$${balanceImpact.toLocaleString()}<br>` +
            `<small>${description}</small>`, 'success');
        
        logMessage(`üí∞ Movimiento agregado: ${type} $${amount} en d√≠a ${day} - ${description}`);
        
    } catch (error) {
        console.error('Error en addMovement:', error);
        showAlert('mov-alerts', '‚ùå Error interno al agregar el movimiento', 'error');
    }
}

function clearMovementForm() {
    try {
        const elements = ['mov-day', 'mov-type', 'mov-amount', 'mov-category', 'mov-description'];
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        
        // Limpiar vista previa
        clearMovementPreview();
        
        // Limpiar categor√≠as
        const categorySelect = document.getElementById('mov-category');
        if (categorySelect) {
            categorySelect.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';
        }
        
        logMessage('üîÑ Formulario de movimiento limpiado');
    } catch (error) {
        console.error('Error en clearMovementForm:', error);
    }
}

// =====================================================
// FUNCIONES DE RESUMEN Y ESTAD√çSTICAS
// =====================================================

function updateMovementsSummary() {
    try {
        const incomeMovements = additionalMovements.filter(m => m.type === 'income');
        const expenseMovements = additionalMovements.filter(m => m.type === 'expense');
        
        // CORRECCI√ìN: Solo contar ingresos de categor√≠a "recarga"
        const rechargeMovements = incomeMovements.filter(m => m.category === 'recarga');
        const totalRecharges = rechargeMovements.reduce((sum, m) => sum + m.amount, 0);
        
        // NUEVO C√ÅLCULO: Total Ingresos = Saldo inicial + Recargas
        const totalRealIncome = systemConfig.initialBalance + totalRecharges;
        
        // Total Egresos (sin cambios)
        const totalExpenses = expenseMovements.reduce((sum, m) => sum + m.amount, 0);
        
        // NUEVO C√ÅLCULO: Balance Neto = Capital real - Egresos = Ganancia real
        const realNetBalance = totalRealIncome - totalExpenses;
        
        // Actualizar elementos del DOM
        const elements = {
            income: document.getElementById('mov-total-income'),
            expenses: document.getElementById('mov-total-expenses'),
            net: document.getElementById('mov-net-balance')
        };
        
        // Total Ingresos = Saldo inicial + Recargas
        if (elements.income) {
            elements.income.textContent = `$${totalRealIncome.toLocaleString()}`;
            elements.income.style.color = '#28a745';
            elements.income.style.fontWeight = 'bold';
        }
        
        // Total Egresos (sin cambios)
        if (elements.expenses) {
            elements.expenses.textContent = `$${totalExpenses.toLocaleString()}`;
            elements.expenses.style.color = '#dc3545';
            elements.expenses.style.fontWeight = 'bold';
        }
        
        // Balance Neto = Ganancia real
        if (elements.net) {
            elements.net.textContent = `${realNetBalance >= 0 ? '+' : ''}$${Math.abs(realNetBalance).toLocaleString()}`;
            elements.net.style.color = realNetBalance >= 0 ? '#28a745' : '#dc3545';
            elements.net.style.fontWeight = 'bold';
        }
        
        // Calcular otros ingresos (no recargas)
const otherIncomeMovements = incomeMovements.filter(m => m.category !== 'recarga');
const totalOtherIncome = otherIncomeMovements.reduce((sum, m) => sum + m.amount, 0);

// Estad√≠sticas actualizadas para el log
const stats = {
    totalMovimientos: additionalMovements.length,
    ingresos: incomeMovements.length,
    egresos: expenseMovements.length,
    saldoInicial: systemConfig.initialBalance,
    totalRecargas: totalRecharges,
    totalIngresoReal: totalRealIncome,
    totalEgresos: totalExpenses,
    gananciaNeta: realNetBalance,
    recargasRegistradas: rechargeMovements.length,
    otrosIngresos: otherIncomeMovements.length,
    montoOtrosIngresos: totalOtherIncome,
    diasConMovimientos: [...new Set(additionalMovements.map(m => m.day))].length
};
        
        logMessage(`üìä Resumen actualizado - Capital real: $${stats.totalIngresoReal.toLocaleString()} (Inicial: $${systemConfig.initialBalance.toLocaleString()} + Recargas: $${stats.totalRecargas.toLocaleString()}), Ganancia neta: $${stats.gananciaNeta.toLocaleString()}`);

if (stats.otrosIngresos > 0) {
    logMessage(`üí° Otros ingresos no contabilizados en capital: $${stats.montoOtrosIngresos.toLocaleString()} (${stats.otrosIngresos} movimientos)`);
}
        
    } catch (error) {
        console.error('Error en updateMovementsSummary:', error);
    }
}

// =====================================================
// FUNCIONES DE TABLA DE MOVIMIENTOS
// =====================================================

function updateMovementsTable() {
    try {
        const tbody = document.getElementById('mov-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (additionalMovements.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 30px; color: #6c757d; font-style: italic;">
                        üí∞ No hay movimientos registrados<br>
                        <small>Agrega tu primer movimiento usando el formulario de arriba</small>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Ordenar movimientos por d√≠a (m√°s recientes primero)
        const sortedMovements = [...additionalMovements].sort((a, b) => b.day - a.day);
        
        sortedMovements.forEach(movement => {
            const row = document.createElement('tr');
            
            // Aplicar estilos seg√∫n el tipo
            const typeColor = movement.type === 'income' ? '#28a745' : '#dc3545';
            const typeIcon = movement.type === 'income' ? 'üí∞' : 'üí∏';
            const typeText = movement.type === 'income' ? 'Ingreso' : 'Egreso';
            const amountText = `${movement.type === 'income' ? '+' : '-'}$${movement.amount.toLocaleString()}`;
            
            // Calcular fecha real si es posible
            const realDate = movement.dayDate || 'Fecha no disponible';
            
            row.innerHTML = `
                <td>
                    <strong>${movement.day}</strong>
                    <br><small style="color: #666;">${realDate}</small>
                </td>
                <td>
                    <span style="color: ${typeColor}; font-weight: bold;">
                        ${typeIcon} ${typeText}
                    </span>
                </td>
                <td>
                    <strong>${movement.categoryName || movementCategories[movement.type]?.[movement.category] || movement.category}</strong>
                    <br><small style="color: #666;">${movement.category}</small>
                </td>
                <td style="font-family: monospace; font-weight: bold; color: ${typeColor};">
                    ${amountText}
                </td>
                <td>
                    <span title="${movement.description}">${movement.description.substring(0, 50)}${movement.description.length > 50 ? '...' : ''}</span>
                </td>
                <td>
                    <div style="display: flex; gap: 2px; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="editMovement(${movement.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Editar movimiento">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-danger" onclick="deleteMovement(${movement.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Eliminar movimiento">
                            üóëÔ∏è
                        </button>
                        <button class="btn btn-info" onclick="duplicateMovement(${movement.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Duplicar movimiento">
                            üìã
                        </button>
                    </div>
                </td>
            `;
            
            // Aplicar estilos de fila
            if (movement.amount > 1000) {
                row.style.backgroundColor = movement.type === 'income' ? '#f8fff9' : '#fff8f8';
            }
            
            tbody.appendChild(row);
        });
        
        logMessage(`üìã Tabla de movimientos actualizada: ${sortedMovements.length} registros`);
        
    } catch (error) {
        console.error('Error en updateMovementsTable:', error);
    }
}

// =====================================================
// FUNCIONES DE GESTI√ìN DE MOVIMIENTOS
// =====================================================

function editMovement(id) {
    try {
        const movement = additionalMovements.find(m => m.id === id);
        if (!movement) {
            showAlert('mov-alerts', '‚ùå Movimiento no encontrado', 'error');
            return;
        }
        
        // Cargar datos en el formulario
        document.getElementById('mov-day').value = movement.day;
        document.getElementById('mov-type').value = movement.type;
        document.getElementById('mov-amount').value = movement.amount;
        updateMovementCategories();
        document.getElementById('mov-category').value = movement.category;
        document.getElementById('mov-description').value = movement.description;
        
        // Actualizar vista previa
        updateMovementPreview();
        
        // Eliminar el movimiento original para permitir edici√≥n
        deleteMovement(id, false);
        
        showAlert('mov-alerts', 
            `üìù <strong>Movimiento cargado para edici√≥n</strong><br>` +
            `${movement.type === 'income' ? 'üí∞ Ingreso' : 'üí∏ Egreso'} del d√≠a ${movement.day}<br>` +
            `Modifica los valores necesarios y presiona "Agregar Movimiento" para confirmar los cambios.`, 'info');
        
        logMessage(`‚úèÔ∏è Editando movimiento: ${movement.type} $${movement.amount} d√≠a ${movement.day}`);
        
        // Scroll al formulario
        document.getElementById('mov-day').scrollIntoView({ behavior: 'smooth', block: 'center' });
        
    } catch (error) {
        console.error('Error en editMovement:', error);
        showAlert('mov-alerts', '‚ùå Error al editar el movimiento', 'error');
    }
}

function deleteMovement(id, showConfirm = true) {
    try {
        const movement = additionalMovements.find(m => m.id === id);
        if (!movement) {
            showAlert('mov-alerts', '‚ùå Movimiento no encontrado', 'error');
            return;
        }
        
        if (showConfirm) {
            const confirmMessage = 
                `‚ö†Ô∏è ¬øEst√°s seguro de eliminar este movimiento?\n\n` +
                `üìÖ D√≠a: ${movement.day}\n` +
                `üí∞ Tipo: ${movement.type === 'income' ? 'Ingreso' : 'Egreso'}\n` +
                `üíµ Monto: $${movement.amount.toLocaleString()}\n` +
                `üè∑Ô∏è Categor√≠a: ${movement.categoryName || movement.category}\n` +
                `üìù Descripci√≥n: ${movement.description}\n\n` +
                `Esta acci√≥n NO se puede deshacer.`;
                
            if (!confirm(confirmMessage)) {
                return;
            }
        }
        
        const movementIndex = additionalMovements.findIndex(m => m.id === id);
        if (movementIndex >= 0) {
            const deletedMovement = additionalMovements.splice(movementIndex, 1)[0];
            
            updateMovimientosDisplay();
            updateAllCalculations();
            
            if (showConfirm) {
                showAlert('mov-alerts', 
                    `üóëÔ∏è <strong>Movimiento eliminado exitosamente</strong><br>` +
                    `${deletedMovement.type === 'income' ? 'üí∞' : 'üí∏'} $${deletedMovement.amount.toLocaleString()} del d√≠a ${deletedMovement.day}<br>` +
                    `<small>El impacto se ha revertido del balance</small>`, 'warning');
            }
            
            logMessage(`üóëÔ∏è Movimiento eliminado: ${deletedMovement.type} $${deletedMovement.amount} d√≠a ${deletedMovement.day}`);
        }
    } catch (error) {
        console.error('Error en deleteMovement:', error);
        showAlert('mov-alerts', '‚ùå Error al eliminar el movimiento', 'error');
    }
}

function duplicateMovement(id) {
    try {
        const movement = additionalMovements.find(m => m.id === id);
        if (!movement) {
            showAlert('mov-alerts', '‚ùå Movimiento no encontrado', 'error');
            return;
        }
        
        // Cargar datos en el formulario (sin el d√≠a para que el usuario lo establezca)
        document.getElementById('mov-day').value = '';
        document.getElementById('mov-type').value = movement.type;
        document.getElementById('mov-amount').value = movement.amount;
        updateMovementCategories();
        document.getElementById('mov-category').value = movement.category;
        document.getElementById('mov-description').value = `[COPIA] ${movement.description}`;
        
        showAlert('mov-alerts', 
            `üìã <strong>Movimiento preparado para duplicar</strong><br>` +
            `${movement.type === 'income' ? 'üí∞ Ingreso' : 'üí∏ Egreso'} de $${movement.amount.toLocaleString()}<br>` +
            `Establece el d√≠a y presiona "Agregar Movimiento"`, 'info');
        
        logMessage(`üìã Duplicando movimiento: ${movement.type} $${movement.amount}`);
        
        // Enfocar el campo de d√≠a
        document.getElementById('mov-day').focus();
        
    } catch (error) {
        console.error('Error en duplicateMovement:', error);
        showAlert('mov-alerts', '‚ùå Error al duplicar el movimiento', 'error');
    }
}

// =====================================================
// FUNCIONES DE FILTRADO Y B√öSQUEDA
// =====================================================

function filterMovements() {
    try {
        const typeFilter = document.getElementById('mov-filter-type')?.value;
        const dayFilter = parseInt(document.getElementById('mov-filter-day')?.value);
        
        let filteredMovements = [...additionalMovements];
        
        if (typeFilter) {
            filteredMovements = filteredMovements.filter(m => m.type === typeFilter);
        }
        
        if (dayFilter && dayFilter > 0) {
            filteredMovements = filteredMovements.filter(m => m.day === dayFilter);
        }
        
        // Actualizar tabla con movimientos filtrados
        updateFilteredMovementsTable(filteredMovements);
        
        logMessage(`üîç Filtro aplicado: ${filteredMovements.length}/${additionalMovements.length} movimientos`);
        
    } catch (error) {
        console.error('Error en filterMovements:', error);
    }
}

function updateFilteredMovementsTable(movements) {
    try {
        const tbody = document.getElementById('mov-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (movements.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">
                        üîç No se encontraron movimientos con los filtros aplicados<br>
                        <small>Intenta cambiar los criterios de b√∫squeda</small>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Usar la misma l√≥gica que updateMovementsTable pero con los movimientos filtrados
        const sortedMovements = movements.sort((a, b) => b.day - a.day);
        
        sortedMovements.forEach(movement => {
            const row = document.createElement('tr');
            const typeColor = movement.type === 'income' ? '#28a745' : '#dc3545';
            const typeIcon = movement.type === 'income' ? 'üí∞' : 'üí∏';
            const typeText = movement.type === 'income' ? 'Ingreso' : 'Egreso';
            const amountText = `${movement.type === 'income' ? '+' : '-'}$${movement.amount.toLocaleString()}`;
            
            row.innerHTML = `
                <td><strong>${movement.day}</strong></td>
                <td><span style="color: ${typeColor};">${typeIcon} ${typeText}</span></td>
                <td>${movement.categoryName || movementCategories[movement.type]?.[movement.category] || movement.category}</td>
                <td style="color: ${typeColor}; font-weight: bold;">${amountText}</td>
                <td>${movement.description}</td>
                <td>
                    <button class="btn btn-warning" onclick="editMovement(${movement.id})" style="padding: 4px 8px; font-size: 11px;">‚úèÔ∏è</button>
                    <button class="btn btn-danger" onclick="deleteMovement(${movement.id})" style="padding: 4px 8px; font-size: 11px;">üóëÔ∏è</button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error en updateFilteredMovementsTable:', error);
    }
}

function clearMovFilters() {
    try {
        const typeFilter = document.getElementById('mov-filter-type');
        const dayFilter = document.getElementById('mov-filter-day');
        
        if (typeFilter) typeFilter.value = '';
        if (dayFilter) dayFilter.value = '';
        
        updateMovementsTable();
        
        showAlert('mov-alerts', 'üîÑ Filtros eliminados', 'info');
        logMessage('üîÑ Filtros de movimientos limpiados');
        
    } catch (error) {
        console.error('Error en clearMovFilters:', error);
    }
}

function exportMovements() {
    try {
        // Calcular estad√≠sticas con nueva l√≥gica
const incomeMovements = additionalMovements.filter(m => m.type === 'income');
const expenseMovements = additionalMovements.filter(m => m.type === 'expense');
const rechargeMovements = incomeMovements.filter(m => m.category === 'recarga');
const totalRecharges = rechargeMovements.reduce((sum, m) => sum + m.amount, 0);
const totalRealIncome = systemConfig.initialBalance + totalRecharges;
const totalExpenses = expenseMovements.reduce((sum, m) => sum + m.amount, 0);
const realNetBalance = totalRealIncome - totalExpenses;

const exportData = {
    metadata: {
        fechaExportacion: new Date().toISOString(),
        usuario: systemConfig.userName || 'No especificado',
        totalMovimientos: additionalMovements.length,
        saldoInicial: systemConfig.initialBalance,
        totalRecargas: totalRecharges,
        totalIngresoReal: totalRealIncome,
        totalEgresos: totalExpenses,
        gananciaNeta: realNetBalance
    },
    movimientos: additionalMovements.map(movement => ({
        ...movement,
        categoryName: movementCategories[movement.type]?.[movement.category] || movement.category,
        typeDescription: movement.type === 'income' ? 'Ingreso' : 'Egreso',
        contabilizaEnCapital: movement.type === 'income' && movement.category === 'recarga'
    }))
};
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const filename = `vivabox_movimientos_${new Date().toISOString().split('T')[0]}.json`;
        
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        
        showAlert('mov-alerts', `üìä Movimientos exportados: ${filename}`, 'success');
        logMessage(`üìä Exportaci√≥n de movimientos: ${filename}`);
        
    } catch (error) {
        console.error('Error en exportMovements:', error);
        showAlert('mov-alerts', '‚ùå Error al exportar movimientos', 'error');
    }
}

// =====================================================
// EVENT LISTENERS PARA VISTA PREVIA EN TIEMPO REAL
// =====================================================

// Funci√≥n para configurar listeners de vista previa
function setupMovementPreviewListeners() {
    try {
        const elements = {
            day: document.getElementById('mov-day'),
            type: document.getElementById('mov-type'),
            amount: document.getElementById('mov-amount'),
            category: document.getElementById('mov-category')
        };
        
        // Agregar listeners para actualizaci√≥n autom√°tica
        if (elements.day) {
    elements.day.addEventListener('input', updateMovementPreview);
    elements.day.addEventListener('change', updateMovementPreview);
    elements.day.addEventListener('keyup', updateMovementPreview); // NUEVO: Actualizar al escribir
}
        
        if (elements.type) {
            elements.type.addEventListener('change', function() {
                updateMovementCategories();
                updateMovementPreview();
            });
        }
        
        if (elements.amount) {
            elements.amount.addEventListener('input', updateMovementPreview);
            elements.amount.addEventListener('change', updateMovementPreview);
        }
        
        if (elements.category) {
            elements.category.addEventListener('change', updateMovementPreview);
        }
        
        logMessage('üëÅÔ∏è Listeners de vista previa configurados');
    } catch (error) {
        console.error('Error configurando listeners:', error);
    }
}

// Configurar listeners cuando se carga la pesta√±a de movimientos
setTimeout(() => {
    setupMovementPreviewListeners();
}, 1000);

// =====================================================
// FIN DEL M√ìDULO 7C1 - MOVIMIENTOS ADICIONALES
// =====================================================

// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7C2-1
// FUNCIONES B√ÅSICAS DE EDICI√ìN - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// FUNCI√ìN PRINCIPAL - CARGAR DATOS DE D√çA PARA EDICI√ìN
// =====================================================

function loadDayEditData() {
    try {
        const day = parseInt(document.getElementById('edit-day').value);
        
        if (!day || day < 1 || day > 90) {
            clearEditComparison();
            return;
        }
        
        // Calcular ganancias originales del d√≠a
        let originalEarnings = 0;
        
        // CORRECCI√ìN: Procesar TODAS las cajas activas en ese d√≠a
        boxes.forEach(box => {
            if (day >= box.purchaseDay && day <= box.expiryDay && box.dailyEarning > 0) {
                originalEarnings += box.dailyEarning;
            }
        });
        
        // Actualizar ganancia original en la vista
        const originalEarningsEl = document.getElementById('edit-original-earnings');
        if (originalEarningsEl) {
            originalEarningsEl.textContent = `$${originalEarnings.toLocaleString()}`;
        }
        
        // Verificar si ya existe una edici√≥n para este d√≠a
        const existingEdit = dayEditions.find(e => e.day === day);
        
        const realEarningsEl = document.getElementById('edit-real-earnings');
        const notesEl = document.getElementById('edit-notes');
        const reasonEl = document.getElementById('edit-reason');
        const adjustmentEl = document.getElementById('edit-adjustment');
        
        if (existingEdit) {
            // Cargar datos de edici√≥n existente
            if (realEarningsEl) realEarningsEl.value = existingEdit.finalEarnings || 0;
            if (notesEl) notesEl.value = existingEdit.notes || '';
            if (reasonEl) reasonEl.value = existingEdit.reason || '';
            if (adjustmentEl) adjustmentEl.value = existingEdit.adjustment || 0;
            
            showAlert('edit-alerts', 
                `üìù <strong>Edici√≥n existente cargada</strong><br>` +
                `Este d√≠a ya tiene una edici√≥n aplicada.<br>` +
                `<small>Puedes modificar los valores y aplicar una nueva edici√≥n</small>`, 'info');
        } else {
            // Limpiar para nueva edici√≥n
            if (realEarningsEl) realEarningsEl.value = originalEarnings;
            if (notesEl) notesEl.value = '';
            if (reasonEl) reasonEl.value = '';
            if (adjustmentEl) adjustmentEl.value = 0;
        }
        
        // IMPORTANTE: Actualizar comparaci√≥n despu√©s de cargar datos
        updateEditComparison();
        
        logMessage(`üìù Datos cargados para edici√≥n del d√≠a ${day}: $${originalEarnings} originales`);
        
    } catch (error) {
        console.error('Error en loadDayEditData:', error);
        showAlert('edit-alerts', '‚ùå Error al cargar datos del d√≠a', 'error');
    }
}

function showDayInfo(day, originalEarnings) {
    try {
        // Calcular informaci√≥n adicional del d√≠a
        const dayMovements = additionalMovements.filter(m => m.day === day);
        const dayBoxes = boxes.filter(box => 
            box.status === 'active' && day >= box.purchaseDay && day <= box.expiryDay
        );
        const expiringBoxes = boxes.filter(box => box.expiryDay === day);
        
        let infoText = `üìÖ INFORMACI√ìN DEL D√çA ${day}:\n`;
        infoText += `üí∞ Ganancias originales: $${originalEarnings.toLocaleString()}\n`;
        infoText += `üì¶ Cajas activas: ${dayBoxes.length}\n`;
        
        if (expiringBoxes.length > 0) {
            infoText += `‚ö†Ô∏è Cajas que vencen: ${expiringBoxes.map(box => box.name).join(', ')}\n`;
        }
        
        if (dayMovements.length > 0) {
            infoText += `üí∏ Movimientos adicionales: ${dayMovements.length}\n`;
        }
        
        const dateReal = systemConfig.startDate ? 
            new Date(systemConfig.startDate.getTime() + (day - 1) * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES') : 
            'Fecha no calculable';
        infoText += `üìÜ Fecha real: ${dateReal}`;
        
        console.log(infoText);
        
    } catch (error) {
        console.error('Error en showDayInfo:', error);
    }
}

// =====================================================
// FUNCIONES DE ACTUALIZACI√ìN DE FORMULARIO
// =====================================================

function updateEditForm() {
    try {
        updateEditComparison();
        
        const reason = document.getElementById('edit-reason').value;
        const realEarningsEl = document.getElementById('edit-real-earnings');
        const adjustmentEl = document.getElementById('edit-adjustment');
        
        // Configurar valores seg√∫n el motivo
        if (reason === 'no-cobro' && realEarningsEl) {
            realEarningsEl.value = 0;
            if (adjustmentEl) adjustmentEl.value = 0;
        } else if (reason === 'cobro-parcial' && realEarningsEl) {
            const originalText = document.getElementById('edit-original-earnings').textContent;
            const original = parseInt(originalText.replace(/[$,]/g, '')) || 0;
            realEarningsEl.value = Math.round(original * 0.5); // 50% por defecto
        }
        
        updateEditComparison();
        
    } catch (error) {
        console.error('Error en updateEditForm:', error);
    }
}

function updateEditComparison() {
    try {
        const day = parseInt(document.getElementById('edit-day').value);
        if (!day || day < 1 || day > 90) {
            clearEditComparison();
            return;
        }

        // PASO 1: Calcular ganancia original del d√≠a seleccionado
        let originalEarnings = 0;
        boxes.forEach(box => {
            if (day >= box.purchaseDay && day <= box.expiryDay && box.dailyEarning > 0) {
                originalEarnings += box.dailyEarning;
            }
        });

        // PASO 2: Obtener valores del formulario
        const realEarnings = parseFloat(document.getElementById('edit-real-earnings').value) || 0;
        const adjustment = parseFloat(document.getElementById('edit-adjustment').value) || 0;
        const finalEarnings = realEarnings + adjustment;

        // PASO 3: Calcular diferencia
        const difference = finalEarnings - originalEarnings;

        // PASO 4: Calcular nuevo saldo
        const previousDayBalance = calculateBalanceAtDay(day - 1);
        let dayOperations = 0;

        // Sumar/restar operaciones del d√≠a (compras de cajas, movimientos)
        boxes.forEach(box => {
            if (day === box.purchaseDay) {
                dayOperations -= box.pricePaid;
            }
        });

        additionalMovements.filter(m => m.day === day).forEach(movement => {
            if (movement.type === 'income') {
                dayOperations += movement.amount;
            } else {
                dayOperations -= movement.amount;
            }
        });

        const newBalance = previousDayBalance + finalEarnings + dayOperations;

        // PASO 5: Actualizar elementos del DOM
        const elements = {
            originalEarnings: document.getElementById('edit-original-earnings'),
            realEarnings: document.getElementById('edit-real-earnings-display'),
            difference: document.getElementById('edit-earnings-difference'),
            newBalance: document.getElementById('edit-new-balance')
        };

        // Ganancia Original
        if (elements.originalEarnings) {
            elements.originalEarnings.textContent = `$${originalEarnings.toLocaleString()}`;
            elements.originalEarnings.style.color = '#1976d2';
        }

        // Ganancia Real
        if (elements.realEarnings) {
            elements.realEarnings.textContent = `$${finalEarnings.toLocaleString()}`;
            elements.realEarnings.style.color = finalEarnings >= 0 ? '#1976d2' : '#d32f2f';
        }

        // Diferencia con colores
        if (elements.difference) {
            elements.difference.textContent = `${difference >= 0 ? '+' : ''}$${difference.toLocaleString()}`;
            if (difference > 0) {
                elements.difference.style.color = '#28a745';
            } else if (difference < 0) {
                elements.difference.style.color = '#dc3545';
            } else {
                elements.difference.style.color = '#ffc107';
            }
            elements.difference.style.fontWeight = 'bold';
        }

        // Nuevo Saldo
        if (elements.newBalance) {
            elements.newBalance.textContent = `$${newBalance.toLocaleString()}`;
            elements.newBalance.style.color = newBalance >= 0 ? '#28a745' : '#dc3545';
            elements.newBalance.style.fontWeight = 'bold';
        }

    } catch (error) {
        console.error('Error en updateEditComparison:', error);
        clearEditComparison();
    }
}

function clearEditComparison() {
    try {
        const displayElements = [
            'edit-original-earnings', 'edit-real-earnings-display', 
            'edit-earnings-difference', 'edit-new-balance'
        ];
        displayElements.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = '$0';
                el.style.color = '#1976d2';
                el.style.fontWeight = 'normal';
            }
        });
    } catch (error) {
        console.error('Error en clearEditComparison:', error);
    }
}

// =====================================================
// FUNCI√ìN PRINCIPAL - APLICAR EDICI√ìN DE D√çA
// =====================================================

function applyDayEdit() {
    try {
        const day = parseInt(document.getElementById('edit-day').value);
        const reason = document.getElementById('edit-reason').value;
        const realEarnings = parseFloat(document.getElementById('edit-real-earnings').value);
        const adjustment = parseFloat(document.getElementById('edit-adjustment').value) || 0;
        const notes = document.getElementById('edit-notes').value;
        
        // Validaciones
        if (!day || day < 1 || day > 90) {
            showAlert('edit-alerts', '‚ùå Debe seleccionar un d√≠a v√°lido entre 1 y 90', 'error');
            return;
        }
        
        if (!reason) {
            showAlert('edit-alerts', '‚ùå Debe seleccionar un motivo para la edici√≥n', 'error');
            return;
        }
        
        if (realEarnings === undefined || realEarnings < 0) {
            showAlert('edit-alerts', '‚ùå La ganancia real debe ser 0 o mayor', 'error');
            return;
        }
        
        if (!notes || notes.trim() === '') {
            showAlert('edit-alerts', '‚ùå Debe proporcionar notas explicando la edici√≥n', 'error');
            return;
        }
        
        // Validar que las notas tengan contenido suficiente
        if (notes.trim().length < 10) {
            showAlert('edit-alerts', '‚ùå Las notas deben tener al menos 10 caracteres', 'error');
            return;
        }
        
        // Calcular ganancias originales
        const originalText = document.getElementById('edit-original-earnings').textContent;
        const originalEarnings = parseInt(originalText.replace(/[$,]/g, '')) || 0;
        const finalEarnings = realEarnings + adjustment;
        
        // Verificar si ya existe una edici√≥n para este d√≠a
        const existingEditIndex = dayEditions.findIndex(e => e.day === day);
        
        const editData = {
            id: existingEditIndex >= 0 ? dayEditions[existingEditIndex].id : Date.now() + Math.random(),
            day: day,
            originalEarnings: originalEarnings,
            realEarnings: realEarnings,
            adjustment: adjustment,
            finalEarnings: finalEarnings,
            reason: reason,
            notes: notes.trim(),
            date: new Date().toISOString(),
            previousEdit: existingEditIndex >= 0 ? dayEditions[existingEditIndex] : null,
            editedBy: systemConfig.userName || 'Usuario',
            impactPercent: originalEarnings > 0 ? (((finalEarnings - originalEarnings) / originalEarnings) * 100).toFixed(2) : 0
        };
        
        // Confirmar edici√≥n si es significativa
        const difference = Math.abs(finalEarnings - originalEarnings);
        if (difference > originalEarnings * 0.5) {
            const confirmEdit = confirm(
                `‚ö†Ô∏è EDICI√ìN SIGNIFICATIVA DETECTADA\n\n` +
                `La diferencia es mayor al 50% de las ganancias originales:\n` +
                `‚Ä¢ Original: $${originalEarnings.toLocaleString()}\n` +
                `‚Ä¢ Final: $${finalEarnings.toLocaleString()}\n` +
                `‚Ä¢ Diferencia: ${finalEarnings - originalEarnings >= 0 ? '+' : ''}$${(finalEarnings - originalEarnings).toLocaleString()}\n` +
                `‚Ä¢ Impacto: ${editData.impactPercent}%\n\n` +
                `¬øConfirmar esta edici√≥n?`
            );
            
            if (!confirmEdit) {
                return;
            }
        }
        
        // Aplicar o actualizar edici√≥n
        if (existingEditIndex >= 0) {
            dayEditions[existingEditIndex] = editData;
            showAlert('edit-alerts', 
                `‚úÖ <strong>Edici√≥n actualizada exitosamente</strong><br>` +
                `üìÖ D√≠a ${day}: $${originalEarnings.toLocaleString()} ‚Üí $${finalEarnings.toLocaleString()}<br>` +
                `üìä Diferencia: ${finalEarnings - originalEarnings >= 0 ? '+' : ''}$${(finalEarnings - originalEarnings).toLocaleString()}<br>` +
                `üìà Impacto: ${editData.impactPercent}%`, 'success');
            
            logMessage(`‚úèÔ∏è Edici√≥n actualizada: d√≠a ${day}, ${reason}, $${originalEarnings} ‚Üí $${finalEarnings}`);
        } else {
            dayEditions.push(editData);
            showAlert('edit-alerts', 
                `‚úÖ <strong>Edici√≥n aplicada exitosamente</strong><br>` +
                `üìÖ D√≠a ${day}: $${originalEarnings.toLocaleString()} ‚Üí $${finalEarnings.toLocaleString()}<br>` +
                `üìä Impacto: ${finalEarnings - originalEarnings >= 0 ? '+' : ''}$${(finalEarnings - originalEarnings).toLocaleString()}<br>` +
                `üìà Cambio: ${editData.impactPercent}%`, 'success');
            
            logMessage(`‚úèÔ∏è Nueva edici√≥n aplicada: d√≠a ${day}, ${reason}, $${originalEarnings} ‚Üí $${finalEarnings}`);
        }
        
       // Actualizar sistema y recalcular d√≠as posteriores
        updateMovimientosDisplay();
        updateAllCalculations();
        
        // NUEVO: Forzar rec√°lculo de Control Diario con nuevos valores
        setTimeout(() => {
            updateControlDisplay();
            updateAutomationPreview();
        }, 200);
        
        clearEditForm();
        
    } catch (error) {
        console.error('Error en applyDayEdit:', error);
        showAlert('edit-alerts', '‚ùå Error al aplicar la edici√≥n', 'error');
    }
}

// =====================================================
// FUNCIONES DE GESTI√ìN DEL FORMULARIO
// =====================================================

function clearEditForm() {
    try {
        const elements = ['edit-day', 'edit-reason', 'edit-real-earnings', 'edit-adjustment', 'edit-notes'];
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        
        // Limpiar displays de comparaci√≥n
        const displayElements = [
            'edit-original-earnings', 'edit-real-earnings-display', 
            'edit-earnings-difference', 'edit-new-balance'
        ];
        displayElements.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = '$0';
                el.style.color = '#1976d2';
            }
        });
        
        logMessage('üîÑ Formulario de edici√≥n limpiado');
    } catch (error) {
        console.error('Error en clearEditForm:', error);
    }
}

function undoLastEdit() {
    try {
        if (dayEditions.length === 0) {
            showAlert('edit-alerts', '‚ùå No hay ediciones para deshacer', 'error');
            return;
        }
        
        // Obtener la √∫ltima edici√≥n
        const lastEdit = dayEditions[dayEditions.length - 1];
        
        const confirmUndo = confirm(
            `‚Ü©Ô∏è ¬øDeshacer la √∫ltima edici√≥n?\n\n` +
            `üìÖ D√≠a: ${lastEdit.day}\n` +
            `üí∞ Cambio: $${lastEdit.originalEarnings.toLocaleString()} ‚Üí $${lastEdit.finalEarnings.toLocaleString()}\n` +
            `üìù Motivo: ${lastEdit.reason}\n` +
            `üìÑ Notas: ${lastEdit.notes}\n` +
            `üìà Impacto: ${lastEdit.impactPercent}%\n\n` +
            `Esta acci√≥n eliminar√° la edici√≥n permanentemente.`
        );
        
        if (!confirmUndo) return;
        
        // Eliminar la √∫ltima edici√≥n
        const removedEdit = dayEditions.pop();
        
        // Actualizar sistema
        updateMovimientosDisplay();
        updateAllCalculations();
        
        showAlert('edit-alerts', 
            `‚Ü©Ô∏è <strong>√öltima edici√≥n deshecha</strong><br>` +
            `üìÖ D√≠a ${removedEdit.day} restaurado a ganancias originales<br>` +
            `üí∞ $${removedEdit.finalEarnings.toLocaleString()} ‚Üí $${removedEdit.originalEarnings.toLocaleString()}`, 'warning');
        
        logMessage(`‚Ü©Ô∏è √öltima edici√≥n deshecha: d√≠a ${removedEdit.day}`);
        
    } catch (error) {
        console.error('Error en undoLastEdit:', error);
        showAlert('edit-alerts', '‚ùå Error al deshacer la edici√≥n', 'error');
    }
}

// =====================================================
// FUNCIONES B√ÅSICAS DE TABLA DE EDICIONES
// =====================================================

function updateEditionsTable() {
    try {
        const tbody = document.getElementById('edit-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (dayEditions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 30px; color: #6c757d; font-style: italic;">
                        ‚úèÔ∏è No hay ediciones registradas<br>
                        <small>Las ediciones de d√≠as aparecer√°n aqu√≠ una vez aplicadas</small>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Ordenar ediciones por d√≠a (m√°s recientes primero)
        const sortedEditions = [...dayEditions].sort((a, b) => b.day - a.day);
        
        sortedEditions.forEach(edition => {
            const row = document.createElement('tr');
            const difference = edition.finalEarnings - edition.originalEarnings;
            const diffColor = difference >= 0 ? '#28a745' : '#dc3545';
            const diffText = `${difference >= 0 ? '+' : ''}$${Math.abs(difference).toLocaleString()}`;
            
            // Mapear motivos a texto m√°s descriptivo
            const reasonMap = {
                'no-cobro': 'No se cobr√≥',
                'cobro-parcial': 'Cobro parcial',
                'error-calculo': 'Error de c√°lculo',
                'ajuste-manual': 'Ajuste manual',
                'correccion': 'Correcci√≥n'
            };
            
            const reasonText = reasonMap[edition.reason] || edition.reason;
            const dateFormatted = new Date(edition.date).toLocaleDateString('es-ES');
            
            row.innerHTML = `
                <td>
                    <strong>${edition.day}</strong>
                    <br><small style="color: #666;">${dateFormatted}</small>
                </td>
                <td>
                    <span style="padding: 2px 6px; background-color: #e9ecef; border-radius: 3px; font-size: 11px;">
                        ${reasonText}
                    </span>
                </td>
                <td style="font-family: monospace;">$${edition.originalEarnings.toLocaleString()}</td>
                <td style="font-family: monospace; font-weight: bold;">$${edition.finalEarnings.toLocaleString()}</td>
                <td style="font-family: monospace; color: ${diffColor}; font-weight: bold;">${diffText}</td>
                <td>
                    <span title="${edition.notes}">${edition.notes.substring(0, 30)}${edition.notes.length > 30 ? '...' : ''}</span>
                </td>
                <td>
                    <div style="display: flex; gap: 2px; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="revertEdit(${edition.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Revertir edici√≥n">
                            ‚Ü©Ô∏è
                        </button>
                        <button class="btn btn-danger" onclick="deleteEdit(${edition.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Eliminar edici√≥n">
                            üóëÔ∏è
                        </button>
                        <button class="btn btn-info" onclick="viewEditDetails(${edition.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Ver detalles">
                            üëÅÔ∏è
                        </button>
                    </div>
                </td>
            `;
            
            // Resaltar ediciones significativas
            if (Math.abs(difference) > edition.originalEarnings * 0.3) {
                row.style.backgroundColor = difference > 0 ? '#f8fff9' : '#fff8f8';
                row.style.borderLeft = `3px solid ${diffColor}`;
            }
            
            tbody.appendChild(row);
        });
        
        logMessage(`üìã Tabla de ediciones actualizada: ${sortedEditions.length} registros`);
        
    } catch (error) {
        console.error('Error en updateEditionsTable:', error);
    }
}

// =====================================================
// FUNCIONES B√ÅSICAS DE GESTI√ìN DE EDICIONES
// =====================================================

function revertEdit(id) {
    try {
        const edition = dayEditions.find(e => e.id === id);
        if (!edition) {
            showAlert('edit-alerts', '‚ùå Edici√≥n no encontrada', 'error');
            return;
        }
        
        const confirmRevert = confirm(
            `‚Ü©Ô∏è ¬øRevertir esta edici√≥n?\n\n` +
            `üìÖ D√≠a: ${edition.day}\n` +
            `üí∞ Actual: $${edition.finalEarnings.toLocaleString()}\n` +
            `üîô Revertir a: $${edition.originalEarnings.toLocaleString()}\n` +
            `üìù Motivo original: ${edition.reason}\n\n` +
            `Esto eliminar√° la edici√≥n permanentemente.`
        );
        
        if (!confirmRevert) return;
        
        deleteEdit(id, false);
        
        showAlert('edit-alerts', 
            `‚Ü©Ô∏è <strong>Edici√≥n revertida exitosamente</strong><br>` +
            `üìÖ D√≠a ${edition.day} restaurado a $${edition.originalEarnings.toLocaleString()}`, 'warning');
        
        logMessage(`‚Ü©Ô∏è Edici√≥n revertida: d√≠a ${edition.day}`);
        
    } catch (error) {
        console.error('Error en revertEdit:', error);
        showAlert('edit-alerts', '‚ùå Error al revertir la edici√≥n', 'error');
    }
}

function deleteEdit(id, showConfirm = true) {
    try {
        const edition = dayEditions.find(e => e.id === id);
        if (!edition) {
            showAlert('edit-alerts', '‚ùå Edici√≥n no encontrada', 'error');
            return;
        }
        
        if (showConfirm) {
            const confirmDelete = confirm(
                `üóëÔ∏è ¬øEliminar esta edici√≥n?\n\n` +
                `üìÖ D√≠a: ${edition.day}\n` +
                `üí∞ Cambio: $${edition.originalEarnings.toLocaleString()} ‚Üí $${edition.finalEarnings.toLocaleString()}\n` +
                `üìù Motivo: ${edition.reason}\n\n` +
                `Esta acci√≥n NO se puede deshacer.`
            );
            
            if (!confirmDelete) return;
        }
        
        const editionIndex = dayEditions.findIndex(e => e.id === id);
        if (editionIndex >= 0) {
            const deletedEdition = dayEditions.splice(editionIndex, 1)[0];
            
            updateMovimientosDisplay();
            updateAllCalculations();
            
            if (showConfirm) {
                showAlert('edit-alerts', 
                    `üóëÔ∏è <strong>Edici√≥n eliminada</strong><br>` +
                    `D√≠a ${deletedEdition.day} restaurado a valores originales`, 'warning');
            }
            
            logMessage(`üóëÔ∏è Edici√≥n eliminada: d√≠a ${deletedEdition.day}`);
        }
    } catch (error) {
        console.error('Error en deleteEdit:', error);
        showAlert('edit-alerts', '‚ùå Error al eliminar la edici√≥n', 'error');
    }
}

function viewEditDetails(id) {
    try {
        const edition = dayEditions.find(e => e.id === id);
        if (!edition) {
            alert('‚ùå Edici√≥n no encontrada');
            return;
        }
        
        const difference = edition.finalEarnings - edition.originalEarnings;
        const impact = difference >= 0 ? 'Ganancia adicional' : 'Reducci√≥n de ganancia';
        
        const details = 
            `‚úèÔ∏è DETALLES DE LA EDICI√ìN\n\n` +
            `üìÖ D√≠a: ${edition.day}\n` +
            `üìù Motivo: ${edition.reason}\n` +
            `üí∞ Ganancia original: $${edition.originalEarnings.toLocaleString()}\n` +
            `üíµ Ganancia real: $${edition.realEarnings.toLocaleString()}\n` +
            `üîß Ajuste: ${edition.adjustment ? '$' + edition.adjustment.toLocaleString() : '$0'}\n` +
            `üìä Ganancia final: $${edition.finalEarnings.toLocaleString()}\n` +
            `üìà Diferencia: ${difference >= 0 ? '+' : ''}$${difference.toLocaleString()}\n` +
            `üìâ Impacto: ${edition.impactPercent}%\n` +
            `üéØ Tipo: ${impact}\n` +
            `üìÜ Fecha de edici√≥n: ${new Date(edition.date).toLocaleString('es-ES')}\n` +
            `üë§ Editado por: ${edition.editedBy || 'Usuario'}\n` +
            `üóíÔ∏è Notas: ${edition.notes}\n` +
            `üÜî ID: ${edition.id}`;
        
        alert(details);
        logMessage(`üëÅÔ∏è Detalles consultados: edici√≥n d√≠a ${edition.day}`);
        
    } catch (error) {
        console.error('Error en viewEditDetails:', error);
        alert('‚ùå Error al mostrar detalles');
    }
}

// =====================================================
// CONFIGURACI√ìN DE EVENT LISTENERS B√ÅSICOS
// =====================================================

function setupEditFormListeners() {
    try {
        console.log('üîß Configurando event listeners de edici√≥n...');
        
        // Obtener elementos
        const elements = {
            day: document.getElementById('edit-day'),
            reason: document.getElementById('edit-reason'),
            realEarnings: document.getElementById('edit-real-earnings'),
            adjustment: document.getElementById('edit-adjustment')
        };
        
        // IMPORTANTE: Remover listeners anteriores para evitar duplicados
        Object.values(elements).forEach(element => {
            if (element) {
                // Clonar elemento para eliminar todos los listeners
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
            }
        });
        
        // Obtener elementos nuevamente despu√©s del clonado
        const cleanElements = {
            day: document.getElementById('edit-day'),
            reason: document.getElementById('edit-reason'),
            realEarnings: document.getElementById('edit-real-earnings'),
            adjustment: document.getElementById('edit-adjustment')
        };
        
        // Configurar listeners para d√≠a
        if (cleanElements.day) {
            cleanElements.day.addEventListener('input', function() {
                console.log('üìù Campo d√≠a cambiado:', this.value);
                loadDayEditData();
            });
            cleanElements.day.addEventListener('change', function() {
                console.log('üìù Campo d√≠a change:', this.value);
                loadDayEditData();
            });
            console.log('‚úÖ Listeners para edit-day configurados');
        }
        
        // Configurar listeners para motivo
        if (cleanElements.reason) {
            cleanElements.reason.addEventListener('change', function() {
                console.log('üìù Motivo cambiado:', this.value);
                updateEditForm();
            });
            console.log('‚úÖ Listeners para edit-reason configurados');
        }
        
        // Configurar listeners para ganancia real
        if (cleanElements.realEarnings) {
            cleanElements.realEarnings.addEventListener('input', function() {
                console.log('üìù Ganancia real cambiada:', this.value);
                updateEditComparison();
            });
            cleanElements.realEarnings.addEventListener('change', function() {
                console.log('üìù Ganancia real change:', this.value);
                updateEditComparison();
            });
            cleanElements.realEarnings.addEventListener('keyup', function() {
                updateEditComparison();
            });
            console.log('‚úÖ Listeners para edit-real-earnings configurados');
        }
        
        // Configurar listeners para ajuste
        if (cleanElements.adjustment) {
            cleanElements.adjustment.addEventListener('input', function() {
                console.log('üìù Ajuste cambiado:', this.value);
                updateEditComparison();
            });
            cleanElements.adjustment.addEventListener('change', function() {
                console.log('üìù Ajuste change:', this.value);
                updateEditComparison();
            });
            cleanElements.adjustment.addEventListener('keyup', function() {
                updateEditComparison();
            });
            console.log('‚úÖ Listeners para edit-adjustment configurados');
        }
        
        logMessage('üëÅÔ∏è Event listeners de edici√≥n configurados correctamente');
        
    } catch (error) {
        console.error('Error configurando listeners de edici√≥n:', error);
    }
}

// Configurar listeners cuando se actualiza el display de movimientos
setTimeout(() => {
    setupEditFormListeners();
}, 1000);

// =====================================================
// FIN DEL M√ìDULO 7C2-1 - FUNCIONES B√ÅSICAS DE EDICI√ìN
// =====================================================

// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7C2-2A
// FILTROS Y EXPORTACI√ìN AVANZADA - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// FUNCIONES DE FILTRADO AVANZADO DE EDICIONES
// =====================================================

function filterEditions() {
    try {
        const reasonFilter = document.getElementById('edit-filter-reason')?.value;
        const dayFilter = parseInt(document.getElementById('edit-filter-day')?.value);
        const impactFilter = document.getElementById('edit-filter-impact')?.value;
        
        let filteredEditions = [...dayEditions];
        
        // Filtrar por motivo
        if (reasonFilter) {
            filteredEditions = filteredEditions.filter(e => e.reason === reasonFilter);
        }
        
        // Filtrar por d√≠a espec√≠fico
        if (dayFilter && dayFilter > 0) {
            filteredEditions = filteredEditions.filter(e => e.day === dayFilter);
        }
        
        // Filtrar por impacto
        if (impactFilter) {
            filteredEditions = filteredEditions.filter(edition => {
                const difference = edition.finalEarnings - edition.originalEarnings;
                switch (impactFilter) {
                    case 'positive':
                        return difference > 0;
                    case 'negative':
                        return difference < 0;
                    case 'neutral':
                        return difference === 0;
                    case 'significant':
                        return Math.abs(difference) > edition.originalEarnings * 0.25;
                    default:
                        return true;
                }
            });
        }
        
        // Actualizar tabla con ediciones filtradas
        updateFilteredEditionsTable(filteredEditions);
        
        // Mostrar estad√≠sticas del filtro
        showFilterStatistics(filteredEditions);
        
        logMessage(`üîç Filtro aplicado a ediciones: ${filteredEditions.length}/${dayEditions.length} resultados`);
        
    } catch (error) {
        console.error('Error en filterEditions:', error);
        showAlert('edit-alerts', '‚ùå Error al filtrar ediciones', 'error');
    }
}

function updateFilteredEditionsTable(editions) {
    try {
        const tbody = document.getElementById('edit-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (editions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 30px; color: #6c757d;">
                        üîç No se encontraron ediciones con los filtros aplicados<br>
                        <small>Intenta cambiar los criterios de b√∫squeda</small>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Ordenar por d√≠a (m√°s recientes primero)
        const sortedEditions = editions.sort((a, b) => b.day - a.day);
        
        sortedEditions.forEach(edition => {
            const row = document.createElement('tr');
            const difference = edition.finalEarnings - edition.originalEarnings;
            const diffColor = difference >= 0 ? '#28a745' : '#dc3545';
            const diffText = `${difference >= 0 ? '+' : ''}$${Math.abs(difference).toLocaleString()}`;
            
            const reasonMap = {
                'no-cobro': 'No se cobr√≥',
                'cobro-parcial': 'Cobro parcial', 
                'error-calculo': 'Error de c√°lculo',
                'ajuste-manual': 'Ajuste manual',
                'correccion': 'Correcci√≥n'
            };
            
            const reasonText = reasonMap[edition.reason] || edition.reason;
            const dateFormatted = new Date(edition.date).toLocaleDateString('es-ES');
            const impactPercent = Math.abs(parseFloat(edition.impactPercent || 0));
            
            row.innerHTML = `
                <td>
                    <strong>${edition.day}</strong>
                    <br><small style="color: #666;">${dateFormatted}</small>
                </td>
                <td>
                    <span style="padding: 2px 6px; background-color: #e9ecef; border-radius: 3px; font-size: 11px;">
                        ${reasonText}
                    </span>
                    ${impactPercent > 25 ? '<br><span style="color: #ff9800; font-size: 10px;">‚ö†Ô∏è Significativo</span>' : ''}
                </td>
                <td style="font-family: monospace;">$${edition.originalEarnings.toLocaleString()}</td>
                <td style="font-family: monospace; font-weight: bold;">$${edition.finalEarnings.toLocaleString()}</td>
                <td style="font-family: monospace; color: ${diffColor}; font-weight: bold;">
                    ${diffText}
                    <br><small style="color: #666; font-size: 10px;">${impactPercent.toFixed(1)}%</small>
                </td>
                <td>
                    <span title="${edition.notes}">${edition.notes.substring(0, 30)}${edition.notes.length > 30 ? '...' : ''}</span>
                </td>
                <td>
                    <div style="display: flex; gap: 2px; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="revertEdit(${edition.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Revertir">‚Ü©Ô∏è</button>
                        <button class="btn btn-danger" onclick="deleteEdit(${edition.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Eliminar">üóëÔ∏è</button>
                        <button class="btn btn-info" onclick="viewEditDetails(${edition.id})" 
                                style="padding: 4px 8px; font-size: 11px;" title="Detalles">üëÅÔ∏è</button>
                    </div>
                </td>
            `;
            
            // Resaltar ediciones seg√∫n impacto
            if (impactPercent > 50) {
                row.style.backgroundColor = difference > 0 ? '#e8f8e8' : '#ffe8e8';
                row.style.borderLeft = `4px solid ${diffColor}`;
            } else if (impactPercent > 25) {
                row.style.backgroundColor = '#fff9e6';
                row.style.borderLeft = `2px solid #ff9800`;
            }
            
            tbody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error en updateFilteredEditionsTable:', error);
    }
}

function showFilterStatistics(filteredEditions) {
    try {
        if (filteredEditions.length === 0) return;
        
        const stats = calculateFilterStatistics(filteredEditions);
        
        console.group('üìä ESTAD√çSTICAS DEL FILTRO DE EDICIONES');
        console.log('üìã Total filtrado:', filteredEditions.length, 'de', dayEditions.length);
        console.log('üí∞ Impacto total:', stats.totalImpact >= 0 ? '+$' : '-$', Math.abs(stats.totalImpact).toLocaleString());
        console.log('üìà Ediciones positivas:', stats.positiveEditions, `(+$${stats.positiveImpact.toLocaleString()})`);
        console.log('üìâ Ediciones negativas:', stats.negativeEditions, `(-$${stats.negativeImpact.toLocaleString()})`);
        console.log('‚öñÔ∏è Ediciones neutras:', stats.neutralEditions);
        console.log('‚ö†Ô∏è Ediciones significativas:', stats.significantEditions);
        console.log('üìÖ Rango de d√≠as:', stats.dayRange.min, '-', stats.dayRange.max);
        console.log('üìä Impacto promedio:', stats.averageImpact >= 0 ? '+$' : '-$', Math.abs(stats.averageImpact).toLocaleString());
        console.groupEnd();
        
    } catch (error) {
        console.error('Error en showFilterStatistics:', error);
    }
}

function calculateFilterStatistics(editions) {
    try {
        const stats = {
            totalImpact: 0,
            positiveEditions: 0,
            negativeEditions: 0,
            neutralEditions: 0,
            significantEditions: 0,
            positiveImpact: 0,
            negativeImpact: 0,
            dayRange: { min: 90, max: 1 },
            averageImpact: 0,
            motivos: {}
        };
        
        editions.forEach(edition => {
            const difference = edition.finalEarnings - edition.originalEarnings;
            const impactPercent = Math.abs(parseFloat(edition.impactPercent || 0));
            
            stats.totalImpact += difference;
            
            if (difference > 0) {
                stats.positiveEditions++;
                stats.positiveImpact += difference;
            } else if (difference < 0) {
                stats.negativeEditions++;
                stats.negativeImpact += Math.abs(difference);
            } else {
                stats.neutralEditions++;
            }
            
            if (impactPercent > 25) {
                stats.significantEditions++;
            }
            
            // Rango de d√≠as
            if (edition.day < stats.dayRange.min) stats.dayRange.min = edition.day;
            if (edition.day > stats.dayRange.max) stats.dayRange.max = edition.day;
            
            // Contar motivos
            stats.motivos[edition.reason] = (stats.motivos[edition.reason] || 0) + 1;
        });
        
        stats.averageImpact = editions.length > 0 ? stats.totalImpact / editions.length : 0;
        
        return stats;
    } catch (error) {
        console.error('Error en calculateFilterStatistics:', error);
        return {};
    }
}

function clearEditFilters() {
    try {
        const filters = ['edit-filter-reason', 'edit-filter-day', 'edit-filter-impact'];
        filters.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        
        // Actualizar tabla sin filtros
        updateEditionsTable();
        
        showAlert('edit-alerts', 'üîÑ Filtros de ediciones eliminados', 'info');
        logMessage('üîÑ Filtros de ediciones limpiados');
        
    } catch (error) {
        console.error('Error en clearEditFilters:', error);
    }
}

// =====================================================
// FUNCIONES DE EXPORTACI√ìN ESPEC√çFICA DE EDICIONES
// =====================================================

function exportEditions() {
    try {
        logMessage('üìä Generando exportaci√≥n de ediciones...');
        
        const exportData = {
            metadata: {
                tipo: 'Exportaci√≥n de Ediciones VIVABOX',
                fechaExportacion: new Date().toISOString(),
                fechaLegible: new Date().toLocaleString('es-ES'),
                usuario: systemConfig.userName || 'No especificado',
                totalEdiciones: dayEditions.length,
                version: '1.0'
            },
            
            configuracion: {
                saldoInicial: systemConfig.initialBalance,
                fechaInicio: systemConfig.startDate ? systemConfig.startDate.toISOString() : null,
                diaActual: systemConfig.currentDay || 1
            },
            
            ediciones: dayEditions.map(edition => ({
                ...edition,
                fechaLegible: new Date(edition.date).toLocaleString('es-ES'),
                impactoAbsoluto: edition.finalEarnings - edition.originalEarnings,
                impactoRelativo: edition.impactPercent + '%',
                motivoDescriptivo: getMotivoDescriptivo(edition.reason),
                fechaDelDia: systemConfig.startDate ? 
                    new Date(systemConfig.startDate.getTime() + (edition.day - 1) * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES') : 
                    'No calculable',
                esSignificativo: Math.abs(parseFloat(edition.impactPercent || 0)) > 25,
                esPositivo: edition.finalEarnings > edition.originalEarnings,
                categoria: categorizeEdit(edition)
            })),
            
            estadisticas: generateEditionStatistics(),
            
            resumen: {
                totalEdiciones: dayEditions.length,
                impactoTotalPositivo: dayEditions.filter(e => e.finalEarnings > e.originalEarnings)
                    .reduce((sum, e) => sum + (e.finalEarnings - e.originalEarnings), 0),
                impactoTotalNegativo: dayEditions.filter(e => e.finalEarnings < e.originalEarnings)
                    .reduce((sum, e) => sum + (e.originalEarnings - e.finalEarnings), 0),
                edicionesSignificativas: dayEditions.filter(e => Math.abs(parseFloat(e.impactPercent || 0)) > 25).length,
                diasEditados: [...new Set(dayEditions.map(e => e.day))].length,
                motivoMasComun: getMostCommonReason()
            }
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const timestamp = new Date().toISOString().split('T')[0];
        const timeString = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
        const filename = `vivabox_ediciones_${timestamp}_${timeString}.json`;
        
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        
        // Mostrar resumen de exportaci√≥n
        const stats = exportData.resumen;
        showAlert('edit-alerts', 
            `üìä <strong>Ediciones exportadas exitosamente</strong><br>` +
            `üìÅ Archivo: ${filename}<br>` +
            `üìã Total: ${stats.totalEdiciones} ediciones<br>` +
            `üìÖ D√≠as editados: ${stats.diasEditados}<br>` +
            `‚ö†Ô∏è Significativas: ${stats.edicionesSignificativas}<br>` +
            `üìà Impacto neto: ${stats.impactoTotalPositivo >= stats.impactoTotalNegativo ? '+' : '-'}$${Math.abs(stats.impactoTotalPositivo - stats.impactoTotalNegativo).toLocaleString()}`, 'success');
        
        logMessage(`üìä Ediciones exportadas: ${filename} (${stats.totalEdiciones} registros)`);
        
        return { success: true, filename, data: exportData };
        
    } catch (error) {
        console.error('Error en exportEditions:', error);
        showAlert('edit-alerts', '‚ùå Error al exportar ediciones', 'error');
        return { success: false, error: error.message };
    }
}

function getMotivoDescriptivo(reason) {
    const motivos = {
        'no-cobro': 'No se cobr√≥ la ganancia del d√≠a',
        'cobro-parcial': 'Se cobr√≥ parcialmente la ganancia',
        'error-calculo': 'Error detectado en el c√°lculo original',
        'ajuste-manual': 'Ajuste manual por circunstancias especiales',
        'correccion': 'Correcci√≥n de datos incorrectos'
    };
    return motivos[reason] || reason;
}

function categorizeEdit(edition) {
    const impactPercent = Math.abs(parseFloat(edition.impactPercent || 0));
    const difference = edition.finalEarnings - edition.originalEarnings;
    
    if (impactPercent > 50) {
        return difference > 0 ? 'Ganancia Extraordinaria' : 'P√©rdida Significativa';
    } else if (impactPercent > 25) {
        return difference > 0 ? 'Ganancia Adicional' : 'Reducci√≥n Notable';
    } else if (impactPercent > 10) {
        return difference > 0 ? 'Ajuste Positivo' : 'Ajuste Negativo';
    } else {
        return 'Ajuste Menor';
    }
}

function generateEditionStatistics() {
    try {
        if (dayEditions.length === 0) {
            return { mensaje: 'No hay ediciones para analizar' };
        }
        
        const stats = {
            total: dayEditions.length,
            porMotivo: {},
            porImpacto: {
                positivos: 0,
                negativos: 0,
                neutros: 0,
                significativos: 0
            },
            montos: {
                totalPositivo: 0,
                totalNegativo: 0,
                promedioImpacto: 0,
                mayorImpacto: 0,
                menorImpacto: 0
            },
            temporal: {
                primerDia: 90,
                ultimoDia: 1,
                diasConEdiciones: 0
            }
        };
        
        let totalImpact = 0;
        const impacts = [];
        const uniqueDays = new Set();
        
        dayEditions.forEach(edition => {
            const difference = edition.finalEarnings - edition.originalEarnings;
            const impactPercent = Math.abs(parseFloat(edition.impactPercent || 0));
            
            // Por motivo
            stats.porMotivo[edition.reason] = (stats.porMotivo[edition.reason] || 0) + 1;
            
            // Por impacto
            if (difference > 0) {
                stats.porImpacto.positivos++;
                stats.montos.totalPositivo += difference;
            } else if (difference < 0) {
                stats.porImpacto.negativos++;
                stats.montos.totalNegativo += Math.abs(difference);
            } else {
                stats.porImpacto.neutros++;
            }
            
            if (impactPercent > 25) {
                stats.porImpacto.significativos++;
            }
            
            // Montos
            totalImpact += difference;
            impacts.push(Math.abs(difference));
            
            // Temporal
            if (edition.day < stats.temporal.primerDia) stats.temporal.primerDia = edition.day;
            if (edition.day > stats.temporal.ultimoDia) stats.temporal.ultimoDia = edition.day;
            uniqueDays.add(edition.day);
        });
        
        stats.montos.promedioImpacto = totalImpact / dayEditions.length;
        stats.montos.mayorImpacto = Math.max(...impacts);
        stats.montos.menorImpacto = Math.min(...impacts);
        stats.temporal.diasConEdiciones = uniqueDays.size;
        
        return stats;
    } catch (error) {
        console.error('Error en generateEditionStatistics:', error);
        return { error: 'Error al generar estad√≠sticas' };
    }
}

function getMostCommonReason() {
    try {
        if (dayEditions.length === 0) return 'N/A';
        
        const reasons = {};
        dayEditions.forEach(e => {
            reasons[e.reason] = (reasons[e.reason] || 0) + 1;
        });
        
        const mostCommon = Object.entries(reasons).reduce((max, [reason, count]) => 
            count > max.count ? { reason, count } : max, { reason: 'N/A', count: 0 });
        
        return getMotivoDescriptivo(mostCommon.reason);
    } catch (error) {
        return 'Error';
    }
}

// =====================================================
// FUNCIONES AUXILIARES PARA FILTROS AVANZADOS
// =====================================================

function createAdvancedFilterUI() {
    try {
        // Esta funci√≥n puede ser llamada para crear filtros adicionales din√°micamente
        logMessage('üîß Sistema de filtros avanzados inicializado');
        
        // Agregar filtro por impacto si no existe
        const filterContainer = document.querySelector('#edit-filter-reason')?.parentNode?.parentNode;
        if (filterContainer && !document.getElementById('edit-filter-impact')) {
            const impactFilter = document.createElement('select');
            impactFilter.id = 'edit-filter-impact';
            impactFilter.style.cssText = 'padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;';
            impactFilter.innerHTML = `
                <option value="">Todos los impactos</option>
                <option value="positive">Solo positivos</option>
                <option value="negative">Solo negativos</option>
                <option value="neutral">Solo neutros</option>
                <option value="significant">Solo significativos</option>
            `;
            impactFilter.addEventListener('change', filterEditions);
            
            // Agregar despu√©s del filtro de d√≠a
            const dayFilter = document.getElementById('edit-filter-day');
            if (dayFilter && dayFilter.parentNode) {
                dayFilter.parentNode.insertBefore(impactFilter, dayFilter.nextSibling);
            }
        }
        
    } catch (error) {
        console.error('Error en createAdvancedFilterUI:', error);
    }
}

function quickFilterEditions(filterType) {
    try {
        // Funci√≥n para filtros r√°pidos predefinidos
        clearEditFilters();
        
        switch (filterType) {
            case 'significant':
                document.getElementById('edit-filter-impact').value = 'significant';
                break;
            case 'today':
                document.getElementById('edit-filter-day').value = systemConfig.currentDay || 1;
                break;
            case 'no-cobro':
                document.getElementById('edit-filter-reason').value = 'no-cobro';
                break;
            case 'positive':
                document.getElementById('edit-filter-impact').value = 'positive';
                break;
            case 'negative':
                document.getElementById('edit-filter-impact').value = 'negative';
                break;
        }
        
        filterEditions();
        logMessage(`‚ö° Filtro r√°pido aplicado: ${filterType}`);
        
    } catch (error) {
        console.error('Error en quickFilterEditions:', error);
    }
}

// =====================================================
// ACTUALIZACI√ìN DE DISPLAY MEJORADA
// =====================================================

function updateMovimientosDisplayEnhanced() {
    try {
        // Llamar a la funci√≥n original
        updateMovimientosDisplay();
        
        // Actualizar tabla de ediciones mejorada
        updateEditionsTable();
        
        // Crear filtros avanzados si no existen
        createAdvancedFilterUI();
        
        logMessage('üí∞ Display de movimientos actualizado con mejoras avanzadas');
        
    } catch (error) {
        console.error('Error en updateMovimientosDisplayEnhanced:', error);
    }
}

// =====================================================
// FIN DEL M√ìDULO 7C2-2A - FILTROS Y EXPORTACI√ìN AVANZADA
// =====================================================

// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7C2-2B-1
// AN√ÅLISIS AVANZADO - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// FUNCIONES DE AN√ÅLISIS AVANZADO DE EDICIONES
// =====================================================

function generateEditionAnalysisReport() {
    try {
        logMessage('üìã Generando reporte de an√°lisis de ediciones...');
        
        const report = {
            metadata: {
                fechaAnalisis: new Date().toLocaleString('es-ES'),
                usuario: systemConfig.userName || 'No especificado',
                diasAnalizados: systemConfig.currentDay || 1,
                totalEdiciones: dayEditions.length
            },
            
            resumenEjecutivo: generateExecutiveSummaryEditions(),
            estadisticasDetalladas: generateEditionStatistics(),
            analisisImpacto: analyzeEditionImpact(),
            tendenciasTemporales: analyzeTemporal(),
            comparativasMotivos: analyzeReasonComparison(),
            recomendacionesEstrategicas: generateStrategicRecommendations()
        };
        
        console.group('üìã REPORTE DE AN√ÅLISIS DE EDICIONES');
        console.log('üìä Resumen Ejecutivo:', report.resumenEjecutivo);
        console.log('üìà Estad√≠sticas:', report.estadisticasDetalladas);
        console.log('üí° An√°lisis de Impacto:', report.analisisImpacto);
        console.log('üìÖ Tendencias Temporales:', report.tendenciasTemporales);
        console.log('üîç Comparativas por Motivos:', report.comparativasMotivos);
        console.log('üéØ Recomendaciones Estrat√©gicas:', report.recomendacionesEstrategicas);
        console.groupEnd();
        
        showAlert('edit-alerts', 
            `üìã <strong>Reporte de an√°lisis generado</strong><br>` +
            `üìä ${dayEditions.length} ediciones analizadas<br>` +
            `<small>Revisa la consola (F12) para ver el reporte completo</small>`, 'success');
        
        logMessage('üìã Reporte de an√°lisis de ediciones generado exitosamente');
        
        return report;
    } catch (error) {
        console.error('Error en generateEditionAnalysisReport:', error);
        showAlert('edit-alerts', '‚ùå Error al generar reporte de an√°lisis', 'error');
        return null;
    }
}

function generateExecutiveSummaryEditions() {
    try {
        if (dayEditions.length === 0) {
            return 'No se han realizado ediciones en el sistema';
        }
        
        const totalImpact = dayEditions.reduce((sum, e) => sum + (e.finalEarnings - e.originalEarnings), 0);
        const significantEditions = dayEditions.filter(e => Math.abs(parseFloat(e.impactPercent || 0)) > 25);
        const positiveEditions = dayEditions.filter(e => e.finalEarnings > e.originalEarnings);
        
        const summary = 
            `üìä RESUMEN EJECUTIVO DE EDICIONES:\n` +
            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
            `‚Ä¢ Total de ediciones: ${dayEditions.length}\n` +
            `‚Ä¢ Impacto financiero neto: ${totalImpact >= 0 ? '+' : ''}$${totalImpact.toLocaleString()}\n` +
            `‚Ä¢ Ediciones significativas: ${significantEditions.length} (${((significantEditions.length / dayEditions.length) * 100).toFixed(1)}%)\n` +
            `‚Ä¢ Balance positivo/negativo: ${positiveEditions.length}/${dayEditions.length - positiveEditions.length}\n` +
            `‚Ä¢ D√≠as con ediciones: ${[...new Set(dayEditions.map(e => e.day))].length} de ${systemConfig.currentDay || 1} d√≠as\n` +
            `‚Ä¢ Motivo m√°s frecuente: ${getMostCommonReason()}\n` +
            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
        
        return summary;
    } catch (error) {
        return 'Error al generar resumen ejecutivo';
    }
}

function analyzeEditionImpact() {
    try {
        const impact = {
            balanceGeneral: 'Sin ediciones',
            tendencia: 'Neutral',
            recomendaciones: [],
            metricas: {
                frecuenciaEdicion: 0,
                impactoPromedio: 0,
                consistencia: 'Alta'
            }
        };
        
        if (dayEditions.length === 0) {
            impact.recomendaciones.push('No hay ediciones que analizar');
            return impact;
        }
        
        const totalImpact = dayEditions.reduce((sum, e) => sum + (e.finalEarnings - e.originalEarnings), 0);
        const avgImpact = totalImpact / dayEditions.length;
        const significantEditions = dayEditions.filter(e => Math.abs(parseFloat(e.impactPercent || 0)) > 25);
        
        // Balance general
        if (totalImpact > 0) {
            impact.balanceGeneral = 'Positivo';
            impact.tendencia = 'Favorable';
        } else if (totalImpact < 0) {
            impact.balanceGeneral = 'Negativo';
            impact.tendencia = 'Desfavorable';
        } else {
            impact.balanceGeneral = 'Neutro';
            impact.tendencia = 'Estable';
        }
        
        // M√©tricas
        impact.metricas.frecuenciaEdicion = (dayEditions.length / 90 * 100).toFixed(1) + '%';
        impact.metricas.impactoPromedio = avgImpact;
        
        if (significantEditions.length > dayEditions.length * 0.3) {
            impact.metricas.consistencia = 'Baja';
        } else if (significantEditions.length > dayEditions.length * 0.1) {
            impact.metricas.consistencia = 'Media';
        }
        
        // Recomendaciones
        if (significantEditions.length > 5) {
            impact.recomendaciones.push('Muchas ediciones significativas - revisar procesos de c√°lculo');
        }
        if (dayEditions.filter(e => e.reason === 'no-cobro').length > 3) {
            impact.recomendaciones.push('Frecuentes d√≠as sin cobro - verificar disponibilidad del sistema');
        }
        if (Math.abs(avgImpact) > 100) {
            impact.recomendaciones.push('Impacto promedio alto - considerar ajustar expectativas');
        }
        if (impact.recomendaciones.length === 0) {
            impact.recomendaciones.push('Patr√≥n de ediciones saludable');
        }
        
        return impact;
    } catch (error) {
        console.error('Error en analyzeEditionImpact:', error);
        return { error: 'Error al analizar impacto' };
    }
}

function analyzeTemporal() {
    try {
        const temporal = {
            distribucionPorSemana: {},
            tendenciaCreciente: false,
            diasConMasEdiciones: [],
            patrones: []
        };
        
        if (dayEditions.length === 0) {
            temporal.patrones.push('Sin datos para analizar patrones temporales');
            return temporal;
        }
        
        // Agrupar por semanas
        dayEditions.forEach(edition => {
            const week = Math.ceil(edition.day / 7);
            if (!temporal.distribucionPorSemana[week]) {
                temporal.distribucionPorSemana[week] = {
                    cantidad: 0,
                    impactoTotal: 0,
                    dias: []
                };
            }
            temporal.distribucionPorSemana[week].cantidad++;
            temporal.distribucionPorSemana[week].impactoTotal += (edition.finalEarnings - edition.originalEarnings);
            temporal.distribucionPorSemana[week].dias.push(edition.day);
        });
        
        // Analizar tendencias
        const weeks = Object.keys(temporal.distribucionPorSemana).map(Number).sort();
        if (weeks.length > 1) {
            const firstHalf = weeks.slice(0, Math.ceil(weeks.length / 2));
            const secondHalf = weeks.slice(Math.ceil(weeks.length / 2));
            
            const firstHalfAvg = firstHalf.reduce((sum, week) => 
                sum + temporal.distribucionPorSemana[week].cantidad, 0) / firstHalf.length;
            const secondHalfAvg = secondHalf.reduce((sum, week) => 
                sum + temporal.distribucionPorSemana[week].cantidad, 0) / secondHalf.length;
            
            temporal.tendenciaCreciente = secondHalfAvg > firstHalfAvg;
        }
        
        // D√≠as con m√°s ediciones
        const editionsByDay = {};
        dayEditions.forEach(edition => {
            editionsByDay[edition.day] = (editionsByDay[edition.day] || 0) + 1;
        });
        
        const maxEditions = Math.max(...Object.values(editionsByDay));
        temporal.diasConMasEdiciones = Object.entries(editionsByDay)
            .filter(([day, count]) => count === maxEditions)
            .map(([day, count]) => ({ day: parseInt(day), ediciones: count }));
        
        // Patrones identificados
        if (temporal.tendenciaCreciente) {
            temporal.patrones.push('Tendencia creciente de ediciones a lo largo del tiempo');
        }
        if (maxEditions > 1) {
            temporal.patrones.push(`D√≠as con m√∫ltiples ediciones detectados (m√°ximo: ${maxEditions})`);
        }
        if (weeks.length > 4 && Object.values(temporal.distribucionPorSemana).every(w => w.cantidad > 0)) {
            temporal.patrones.push('Ediciones distribuidas consistentemente por semanas');
        }
        
        return temporal;
    } catch (error) {
        console.error('Error en analyzeTemporal:', error);
        return { error: 'Error al analizar patrones temporales' };
    }
}

function analyzeReasonComparison() {
    try {
        const comparison = {
            frecuenciaPorMotivo: {},
            impactoPorMotivo: {},
            recomendacionesPorMotivo: {}
        };
        
        if (dayEditions.length === 0) {
            return { mensaje: 'No hay datos para comparar motivos' };
        }
        
        // An√°lisis por motivo
        dayEditions.forEach(edition => {
            const reason = edition.reason;
            const impact = edition.finalEarnings - edition.originalEarnings;
            
            // Frecuencia
            comparison.frecuenciaPorMotivo[reason] = (comparison.frecuenciaPorMotivo[reason] || 0) + 1;
            
            // Impacto acumulado
            if (!comparison.impactoPorMotivo[reason]) {
                comparison.impactoPorMotivo[reason] = {
                    total: 0,
                    promedio: 0,
                    maximo: impact,
                    minimo: impact,
                    cantidad: 0
                };
            }
            
            const reasonData = comparison.impactoPorMotivo[reason];
            reasonData.total += impact;
            reasonData.cantidad++;
            reasonData.promedio = reasonData.total / reasonData.cantidad;
            reasonData.maximo = Math.max(reasonData.maximo, impact);
            reasonData.minimo = Math.min(reasonData.minimo, impact);
        });
        
        // Generar recomendaciones por motivo
        Object.keys(comparison.frecuenciaPorMotivo).forEach(reason => {
            const frequency = comparison.frecuenciaPorMotivo[reason];
            const impact = comparison.impactoPorMotivo[reason];
            
            switch (reason) {
                case 'no-cobro':
                    if (frequency > 5) {
                        comparison.recomendacionesPorMotivo[reason] = 'Frecuencia alta de d√≠as sin cobro - verificar estabilidad del sistema';
                    }
                    break;
                case 'cobro-parcial':
                    if (frequency > 3) {
                        comparison.recomendacionesPorMotivo[reason] = 'M√∫ltiples cobros parciales - investigar causas t√©cnicas';
                    }
                    break;
                case 'error-calculo':
                    if (frequency > 2) {
                        comparison.recomendacionesPorMotivo[reason] = 'Errores de c√°lculo recurrentes - revisar algoritmos';
                    }
                    break;
                default:
                    if (frequency === 1) {
                        comparison.recomendacionesPorMotivo[reason] = 'Caso aislado - monitear si se repite';
                    }
            }
        });
        
        return comparison;
    } catch (error) {
        console.error('Error en analyzeReasonComparison:', error);
        return { error: 'Error al comparar motivos' };
    }
}

function generateStrategicRecommendations() {
    try {
        const recommendations = {
            inmediatas: [],
            cortoPlayzo: [],
            largoPlayzo: [],
            preventivas: []
        };
        
        if (dayEditions.length === 0) {
            recommendations.inmediatas.push('No hay ediciones que analizar');
            return recommendations;
        }
        
        const totalImpact = dayEditions.reduce((sum, e) => sum + (e.finalEarnings - e.originalEarnings), 0);
        const avgImpact = totalImpact / dayEditions.length;
        const significantEditions = dayEditions.filter(e => Math.abs(parseFloat(e.impactPercent || 0)) > 25);
        const noCobroEditions = dayEditions.filter(e => e.reason === 'no-cobro');
        
        // Recomendaciones inmediatas
        if (significantEditions.length > dayEditions.length * 0.3) {
            recommendations.inmediatas.push('Revisar procesos de c√°lculo - alto porcentaje de ediciones significativas');
        }
        if (noCobroEditions.length > 5) {
            recommendations.inmediatas.push('Investigar problemas de conectividad o disponibilidad del sistema');
        }
        if (Math.abs(avgImpact) > 200) {
            recommendations.inmediatas.push('Impacto promedio muy alto - verificar configuraci√≥n de cajas');
        }
        
        // Recomendaciones a corto plazo
        if (dayEditions.length > 10) {
            recommendations.cortoPlayzo.push('Implementar monitoreo autom√°tico de ganancias esperadas vs reales');
        }
        if ([...new Set(dayEditions.map(e => e.reason))].length > 3) {
            recommendations.cortoPlayzo.push('Estandarizar motivos de edici√≥n para mejor an√°lisis');
        }
        
        // Recomendaciones a largo plazo
        recommendations.largoPlayzo.push('Desarrollar sistema de alertas tempranas para desviaciones');
        recommendations.largoPlayzo.push('Crear dashboard de m√©tricas de rendimiento en tiempo real');
        
        // Recomendaciones preventivas
        recommendations.preventivas.push('Establecer l√≠mites de tolerancia para ediciones autom√°ticas');
        recommendations.preventivas.push('Implementar backup autom√°tico antes de cada edici√≥n');
        recommendations.preventivas.push('Crear reportes semanales de tendencias de ediciones');
        
        return recommendations;
    } catch (error) {
        console.error('Error en generateStrategicRecommendations:', error);
        return { error: 'Error al generar recomendaciones estrat√©gicas' };
    }
}

// =====================================================
// FUNCIONES DE REPORTES ESPECIALIZADOS
// =====================================================

function generateDailyImpactReport() {
    try {
        const dailyReport = {};
        
        if (dayEditions.length === 0) {
            return { mensaje: 'No hay ediciones para generar reporte diario' };
        }
        
        // Agrupar ediciones por d√≠a
        dayEditions.forEach(edition => {
            if (!dailyReport[edition.day]) {
                dailyReport[edition.day] = {
                    fecha: systemConfig.startDate ? 
                        new Date(systemConfig.startDate.getTime() + (edition.day - 1) * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES') : 
                        'Fecha no calculable',
                    ediciones: [],
                    impactoTotal: 0,
                    gananciaOriginalTotal: 0,
                    gananciaFinalTotal: 0
                };
            }
            
            const dayData = dailyReport[edition.day];
            dayData.ediciones.push(edition);
            dayData.impactoTotal += (edition.finalEarnings - edition.originalEarnings);
            dayData.gananciaOriginalTotal += edition.originalEarnings;
            dayData.gananciaFinalTotal += edition.finalEarnings;
        });
        
        // Calcular m√©tricas adicionales por d√≠a
        Object.keys(dailyReport).forEach(day => {
            const dayData = dailyReport[day];
            dayData.cantidadEdiciones = dayData.ediciones.length;
            dayData.impactoPromedio = dayData.impactoTotal / dayData.cantidadEdiciones;
            dayData.esSignificativo = Math.abs(dayData.impactoTotal) > dayData.gananciaOriginalTotal * 0.25;
            dayData.motivos = [...new Set(dayData.ediciones.map(e => e.reason))];
            dayData.categoria = categorizeDayImpact(dayData.impactoTotal, dayData.gananciaOriginalTotal);
        });
        
        console.group('üìÖ REPORTE DE IMPACTO DIARIO');
        Object.entries(dailyReport).forEach(([day, data]) => {
            console.log(`D√≠a ${day} (${data.fecha}):`, {
                ediciones: data.cantidadEdiciones,
                impacto: data.impactoTotal >= 0 ? '+$' : '-$' + Math.abs(data.impactoTotal).toLocaleString(),
                categoria: data.categoria,
                motivos: data.motivos
            });
        });
        console.groupEnd();
        
        return dailyReport;
    } catch (error) {
        console.error('Error en generateDailyImpactReport:', error);
        return { error: 'Error al generar reporte diario' };
    }
}

function categorizeDayImpact(impacto, gananciaOriginal) {
    const impactPercent = gananciaOriginal > 0 ? Math.abs(impacto / gananciaOriginal) * 100 : 0;
    
    if (impactPercent > 75) {
        return impacto > 0 ? 'D√≠a Excepcional' : 'D√≠a Cr√≠tico';
    } else if (impactPercent > 50) {
        return impacto > 0 ? 'D√≠a Muy Bueno' : 'D√≠a Problem√°tico';
    } else if (impactPercent > 25) {
        return impacto > 0 ? 'D√≠a Bueno' : 'D√≠a Complicado';
    } else if (impactPercent > 10) {
        return impacto > 0 ? 'D√≠a Positivo' : 'D√≠a Negativo';
    } else {
        return 'D√≠a Normal';
    }
}

function generateWeeklyTrendReport() {
    try {
        const weeklyTrends = {};
        
        if (dayEditions.length === 0) {
            return { mensaje: 'No hay ediciones para analizar tendencias semanales' };
        }
        
        // Agrupar por semanas
        dayEditions.forEach(edition => {
            const week = Math.ceil(edition.day / 7);
            if (!weeklyTrends[week]) {
                weeklyTrends[week] = {
                    semana: week,
                    diasInicio: (week - 1) * 7 + 1,
                    diasFin: Math.min(week * 7, 90),
                    ediciones: [],
                    impactoTotal: 0,
                    edicionesPositivas: 0,
                    edicionesNegativas: 0,
                    motivosPredominantes: {}
                };
            }
            
            const weekData = weeklyTrends[week];
            weekData.ediciones.push(edition);
            
            const impact = edition.finalEarnings - edition.originalEarnings;
            weekData.impactoTotal += impact;
            
            if (impact > 0) {
                weekData.edicionesPositivas++;
            } else if (impact < 0) {
                weekData.edicionesNegativas++;
            }
            
            weekData.motivosPredominantes[edition.reason] = 
                (weekData.motivosPredominantes[edition.reason] || 0) + 1;
        });
        
        // Calcular tendencias entre semanas
        const weeks = Object.keys(weeklyTrends).map(Number).sort();
        const trends = {
            semanas: weeklyTrends,
            analisisTendencias: {
                crecimientoEdiciones: false,
                mejorImpacto: false,
                consistencia: 'Variable'
            }
        };
        
        if (weeks.length > 1) {
            const firstWeek = weeklyTrends[weeks[0]];
            const lastWeek = weeklyTrends[weeks[weeks.length - 1]];
            
            trends.analisisTendencias.crecimientoEdiciones = 
                lastWeek.ediciones.length > firstWeek.ediciones.length;
            trends.analisisTendencias.mejorImpacto = 
                lastWeek.impactoTotal > firstWeek.impactoTotal;
            
            // Calcular consistencia
            const impacts = weeks.map(w => weeklyTrends[w].impactoTotal);
            const avgImpact = impacts.reduce((sum, i) => sum + i, 0) / impacts.length;
            const variance = impacts.reduce((sum, i) => sum + Math.pow(i - avgImpact, 2), 0) / impacts.length;
            
            if (variance < 10000) {
                trends.analisisTendencias.consistencia = 'Alta';
            } else if (variance < 50000) {
                trends.analisisTendencias.consistencia = 'Media';
            } else {
                trends.analisisTendencias.consistencia = 'Baja';
            }
        }
        
        console.group('üìä REPORTE DE TENDENCIAS SEMANALES');
        console.log('üìà An√°lisis de tendencias:', trends.analisisTendencias);
        weeks.forEach(week => {
            const data = weeklyTrends[week];
            console.log(`Semana ${week} (D√≠as ${data.diasInicio}-${data.diasFin}):`, {
                ediciones: data.ediciones.length,
                impacto: data.impactoTotal >= 0 ? '+$' : '-$' + Math.abs(data.impactoTotal).toLocaleString(),
                positivas: data.edicionesPositivas,
                negativas: data.edicionesNegativas,
                motivoPrincipal: Object.keys(data.motivosPredominantes).reduce((a, b) => 
                    data.motivosPredominantes[a] > data.motivosPredominantes[b] ? a : b, 'ninguno')
            });
        });
        console.groupEnd();
        
        return trends;
    } catch (error) {
        console.error('Error en generateWeeklyTrendReport:', error);
        return { error: 'Error al generar reporte semanal' };
    }
}

// =====================================================
// FUNCIONES DE BOTONES PARA REPORTES
// =====================================================

function showEditionAnalysisReport() {
    try {
        const report = generateEditionAnalysisReport();
        showAlert('edit-alerts', 
            `üìã <strong>An√°lisis de ediciones completado</strong><br>` +
            `üìä Reporte detallado generado en consola<br>` +
            `<small>Presiona F12 y revisa el grupo "REPORTE DE AN√ÅLISIS DE EDICIONES"</small>`, 'info');
        return report;
    } catch (error) {
        showAlert('edit-alerts', '‚ùå Error al mostrar an√°lisis de ediciones', 'error');
    }
}

function showDailyImpactReport() {
    try {
        const report = generateDailyImpactReport();
        showAlert('edit-alerts', 
            `üìÖ <strong>Reporte de impacto diario generado</strong><br>` +
            `üìä An√°lisis por d√≠a disponible en consola<br>` +
            `<small>Presiona F12 y revisa "REPORTE DE IMPACTO DIARIO"</small>`, 'info');
        return report;
    } catch (error) {
        showAlert('edit-alerts', '‚ùå Error al generar reporte diario', 'error');
    }
}

function showWeeklyTrendReport() {
    try {
        const report = generateWeeklyTrendReport();
        showAlert('edit-alerts', 
            `üìä <strong>Reporte de tendencias semanales generado</strong><br>` +
            `üìà An√°lisis de patrones por semana disponible<br>` +
            `<small>Presiona F12 y revisa "REPORTE DE TENDENCIAS SEMANALES"</small>`, 'info');
        return report;
    } catch (error) {
        showAlert('edit-alerts', '‚ùå Error al generar reporte semanal', 'error');
    }
}

// =====================================================
// FIN DEL M√ìDULO 7C2-2B-1 - AN√ÅLISIS AVANZADO
// =====================================================

// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7C2-2B-2A
// MANTENIMIENTO Y UTILIDADES FINALES - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// FUNCIONES DE MANTENIMIENTO DEL SISTEMA
// =====================================================

function performSystemMaintenance() {
    try {
        logMessage('üßπ Iniciando mantenimiento autom√°tico del sistema...');
        
        const maintenance = {
            accionesRealizadas: [],
            erroresCorregidos: [],
            optimizacionesAplicadas: [],
            estadisticasLimpieza: {
                antes: {},
                despues: {}
            }
        };
        
        // Estad√≠sticas antes del mantenimiento
        maintenance.estadisticasLimpieza.antes = {
            cajas: boxes.length,
            movimientos: additionalMovements.length,
            ediciones: dayEditions.length,
            balancesDiarios: dailyBalances.length
        };
        
        // 1. Limpiar datos duplicados
        const cajasOriginales = boxes.length;
        const cajasUnicas = [];
        const idsVistos = new Set();
        
        boxes.forEach(box => {
            if (!idsVistos.has(box.id)) {
                idsVistos.add(box.id);
                cajasUnicas.push(box);
            }
        });
        
        if (cajasUnicas.length < cajasOriginales) {
            boxes = cajasUnicas;
            maintenance.erroresCorregidos.push(`Eliminados ${cajasOriginales - cajasUnicas.length} duplicados de cajas`);
        }
        
        // 2. Actualizar estados de cajas
        const currentDay = systemConfig.currentDay || 1;
        let cajasActualizadas = 0;
        
        boxes.forEach(box => {
            if (box.expiryDay < currentDay && box.status !== 'expired') {
                box.status = 'expired';
                cajasActualizadas++;
            }
        });
        
        if (cajasActualizadas > 0) {
            maintenance.accionesRealizadas.push(`Actualizado estado de ${cajasActualizadas} cajas vencidas`);
        }
        
        // 3. Validar integridad de datos
        let datosCorregidos = 0;
        
        boxes.forEach(box => {
            if (box.purchaseDay > box.expiryDay) {
                box.expiryDay = box.purchaseDay + box.duration - 1;
                datosCorregidos++;
            }
            if (!box.id) {
                box.id = Date.now() + Math.random();
                datosCorregidos++;
            }
        });
        
        if (datosCorregidos > 0) {
            maintenance.erroresCorregidos.push(`Corregidos ${datosCorregidos} problemas de integridad`);
        }
        
        // 4. Optimizar balances diarios
        if (dailyBalances.length > 90) {
            const balancesOriginales = dailyBalances.length;
            dailyBalances = dailyBalances.slice(0, 90);
            maintenance.optimizacionesAplicadas.push(`Optimizados balances diarios: ${balancesOriginales} ‚Üí 90`);
        }
        
        // 5. Limpiar movimientos fuera de rango
        const movimientosOriginales = additionalMovements.length;
        additionalMovements = additionalMovements.filter(m => m.day >= 1 && m.day <= 90);
        
        if (additionalMovements.length < movimientosOriginales) {
            maintenance.optimizacionesAplicadas.push(`Eliminados ${movimientosOriginales - additionalMovements.length} movimientos fuera de rango`);
        }
        
        // 6. Validar ediciones
        const edicionesOriginales = dayEditions.length;
        dayEditions = dayEditions.filter(e => e.day >= 1 && e.day <= 90 && e.finalEarnings >= 0);
        
        if (dayEditions.length < edicionesOriginales) {
            maintenance.erroresCorregidos.push(`Eliminadas ${edicionesOriginales - dayEditions.length} ediciones inv√°lidas`);
        }
        
        // Estad√≠sticas despu√©s del mantenimiento
        maintenance.estadisticasLimpieza.despues = {
            cajas: boxes.length,
            movimientos: additionalMovements.length,
            ediciones: dayEditions.length,
            balancesDiarios: dailyBalances.length
        };
        
        // Recalcular todo despu√©s del mantenimiento
        updateAllCalculations();
        
        // Mostrar resultados
        const totalAcciones = maintenance.accionesRealizadas.length + 
                            maintenance.erroresCorregidos.length + 
                            maintenance.optimizacionesAplicadas.length;
        
        console.group('üßπ REPORTE DE MANTENIMIENTO DEL SISTEMA');
        console.log('üìä Estad√≠sticas antes:', maintenance.estadisticasLimpieza.antes);
        console.log('üìä Estad√≠sticas despu√©s:', maintenance.estadisticasLimpieza.despues);
        console.log('‚úÖ Acciones realizadas:', maintenance.accionesRealizadas);
        console.log('üîß Errores corregidos:', maintenance.erroresCorregidos);
        console.log('‚ö° Optimizaciones aplicadas:', maintenance.optimizacionesAplicadas);
        console.groupEnd();
        
        if (totalAcciones > 0) {
            showAlert('auto-alerts', 
                `üßπ <strong>Mantenimiento completado</strong><br>` +
                `‚úÖ ${totalAcciones} acciones realizadas<br>` +
                `<small>Sistema optimizado y errores corregidos</small>`, 'success');
        } else {
            showAlert('auto-alerts', 
                `üßπ <strong>Sistema en perfecto estado</strong><br>` +
                `‚úÖ No se requiri√≥ mantenimiento<br>` +
                `<small>Todos los datos est√°n optimizados</small>`, 'info');
        }
        
        logMessage(`üßπ Mantenimiento completado: ${totalAcciones} acciones realizadas`);
        
        return maintenance;
    } catch (error) {
        console.error('Error en performSystemMaintenance:', error);
        showAlert('auto-alerts', '‚ùå Error durante el mantenimiento del sistema', 'error');
        return null;
    }
}

// =====================================================
// FUNCIONES DE DIAGN√ìSTICO Y VALIDACI√ìN
// =====================================================

function runAdvancedSystemDiagnostics() {
    try {
        logMessage('üîç Ejecutando diagn√≥stico avanzado del sistema...');
        
        const diagnostics = {
            timestamp: new Date().toISOString(),
            configuracion: validateAdvancedSystemConfig(),
            integridad: checkAdvancedDataIntegrity(),
            rendimiento: analyzeAdvancedSystemPerformance(),
            consistencia: checkDataConsistency(),
            recomendaciones: generateAdvancedRecommendations()
        };
        
        console.group('üîç DIAGN√ìSTICO AVANZADO DEL SISTEMA VIVABOX');
        console.log('‚öôÔ∏è Configuraci√≥n:', diagnostics.configuracion);
        console.log('üîó Integridad:', diagnostics.integridad);
        console.log('‚ö° Rendimiento:', diagnostics.rendimiento);
        console.log('üìä Consistencia:', diagnostics.consistencia);
        console.log('üí° Recomendaciones:', diagnostics.recomendaciones);
        console.groupEnd();
        
        const totalIssues = (diagnostics.configuracion.problemas || []).length +
                           (diagnostics.integridad.problemas || []).length +
                           (diagnostics.consistencia.problemas || []).length;
        
        showAlert('auto-alerts', 
            `üîç <strong>Diagn√≥stico avanzado completado</strong><br>` +
            `${totalIssues === 0 ? '‚úÖ Sistema perfecto' : `‚ö†Ô∏è ${totalIssues} problemas detectados`}<br>` +
            `<small>Revisa la consola para detalles completos</small>`, 
            totalIssues === 0 ? 'success' : 'warning');
        
        return diagnostics;
    } catch (error) {
        console.error('Error en runAdvancedSystemDiagnostics:', error);
        return null;
    }
}

function validateAdvancedSystemConfig() {
    const validation = {
        estado: 'V√ÅLIDA',
        problemas: [],
        advertencias: []
    };
    
    try {
        // Validaciones cr√≠ticas
        if (!systemConfig.startDate || isNaN(systemConfig.startDate.getTime())) {
            validation.problemas.push('Fecha de inicio inv√°lida o no establecida');
        }
        
        if (systemConfig.initialBalance < 0) {
            validation.problemas.push('Saldo inicial negativo');
        }
        
        if (systemConfig.currentDay < 1 || systemConfig.currentDay > 90) {
            validation.problemas.push('D√≠a actual fuera del rango v√°lido (1-90)');
        }
        
        // Validaciones de advertencia
        if (!systemConfig.userName || systemConfig.userName.trim() === '') {
            validation.advertencias.push('Nombre de usuario no establecido');
        }
        
        if (systemConfig.initialBalance === 0) {
            validation.advertencias.push('Saldo inicial es cero');
        }
        
        // Determinar estado
        if (validation.problemas.length > 0) {
            validation.estado = 'PROBLEM√ÅTICA';
        } else if (validation.advertencias.length > 0) {
            validation.estado = 'CON ADVERTENCIAS';
        }
        
        return validation;
    } catch (error) {
        return {
            estado: 'ERROR',
            problemas: ['Error al validar configuraci√≥n'],
            advertencias: []
        };
    }
}

function checkAdvancedDataIntegrity() {
    const integrity = {
        estado: '√çNTEGRA',
        problemas: [],
        estadisticas: {}
    };
    
    try {
        // Validar cajas
        let cajasProblematicas = 0;
        boxes.forEach((box, index) => {
            if (!box.id || !box.name || !box.type) {
                integrity.problemas.push(`Caja ${index + 1}: Datos b√°sicos incompletos`);
                cajasProblematicas++;
            }
            if (box.purchaseDay >= box.expiryDay) {
                integrity.problemas.push(`${box.name}: Fechas inconsistentes`);
                cajasProblematicas++;
            }
            if (!boxCatalog[box.type]) {
                integrity.problemas.push(`${box.name}: Tipo no reconocido`);
                cajasProblematicas++;
            }
        });
        
        // Validar movimientos
        let movimientosProblematicos = 0;
        additionalMovements.forEach((movement, index) => {
            if (!movement.day || !movement.type || movement.amount === undefined) {
                integrity.problemas.push(`Movimiento ${index + 1}: Datos incompletos`);
                movimientosProblematicos++;
            }
            if (movement.day < 1 || movement.day > 90) {
                integrity.problemas.push(`Movimiento ${index + 1}: D√≠a fuera de rango`);
                movimientosProblematicos++;
            }
        });
        
        // Validar ediciones
        let edicionesProblematicas = 0;
        dayEditions.forEach((edition, index) => {
            if (!edition.day || edition.finalEarnings === undefined) {
                integrity.problemas.push(`Edici√≥n ${index + 1}: Datos incompletos`);
                edicionesProblematicas++;
            }
            if (edition.finalEarnings < 0) {
                integrity.problemas.push(`Edici√≥n d√≠a ${edition.day}: Ganancia final negativa`);
                edicionesProblematicas++;
            }
        });
        
        // Estad√≠sticas
        integrity.estadisticas = {
            cajasProblematicas: cajasProblematicas,
            movimientosProblematicos: movimientosProblematicos,
            edicionesProblematicas: edicionesProblematicas,
            porcentajeIntegridad: ((boxes.length + additionalMovements.length + dayEditions.length - 
                                   cajasProblematicas - movimientosProblematicos - edicionesProblematicas) / 
                                   Math.max(1, boxes.length + additionalMovements.length + dayEditions.length) * 100).toFixed(1)
        };
        
        if (integrity.problemas.length > 0) {
            integrity.estado = 'COMPROMETIDA';
        }
        
        return integrity;
    } catch (error) {
        return {
            estado: 'ERROR',
            problemas: ['Error al verificar integridad'],
            estadisticas: {}
        };
    }
}

function analyzeAdvancedSystemPerformance() {
    const performance = {
        estado: '√ìPTIMO',
        metricas: {},
        alertas: []
    };
    
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const currentBalance = calculateCurrentBalance();
        
        // M√©tricas principales
        performance.metricas = {
            cajasActivas: activeBoxes.length,
            inversionActiva: totalInvestment,
            gananciasDiarias: dailyEarnings,
            balanceActual: currentBalance,
            roiPromedio: totalInvestment > 0 ? ((dailyEarnings / totalInvestment) * 100).toFixed(2) + '%' : '0%',
            crecimientoBalance: systemConfig.initialBalance > 0 ? 
                (((currentBalance - systemConfig.initialBalance) / systemConfig.initialBalance) * 100).toFixed(2) + '%' : '0%',
            eficienciaOperativa: (activeBoxes.length / Math.max(1, boxes.length) * 100).toFixed(1) + '%'
        };
        
        // Alertas de rendimiento
        if (activeBoxes.length === 0) {
            performance.alertas.push('Sin cajas activas - sistema inoperativo');
            performance.estado = 'CR√çTICO';
        }
        
        if (totalInvestment > 0 && dailyEarnings / totalInvestment < 0.03) {
            performance.alertas.push('ROI diario menor al 3% - rendimiento bajo');
            performance.estado = 'SUB√ìPTIMO';
        }
        
        if (currentBalance < systemConfig.initialBalance * 0.5) {
            performance.alertas.push('Balance actual muy bajo comparado con saldo inicial');
            performance.estado = 'CR√çTICO';
        }
        
        return performance;
    } catch (error) {
        return {
            estado: 'ERROR',
            metricas: {},
            alertas: ['Error al analizar rendimiento']
        };
    }
}

function checkDataConsistency() {
    const consistency = {
        estado: 'CONSISTENTE',
        problemas: [],
        verificaciones: {}
    };
    
    try {
        // Verificar balance calculado vs configurado
        const calculatedBalance = calculateCurrentBalance();
        const configuredBalance = systemConfig.initialBalance;
        
        // Verificar coherencia temporal
        const invalidDates = boxes.filter(box => box.purchaseDay > (systemConfig.currentDay || 1));
        if (invalidDates.length > 0) {
            consistency.problemas.push(`${invalidDates.length} cajas con fecha de compra futura`);
        }
        
        // Verificar duplicados
        const boxIds = boxes.map(box => box.id);
        const duplicateBoxes = boxIds.filter((id, index) => boxIds.indexOf(id) !== index);
        if (duplicateBoxes.length > 0) {
            consistency.problemas.push(`${duplicateBoxes.length} cajas con IDs duplicados`);
        }
        
        // Verificar rangos de d√≠as
        const outOfRangeMovements = additionalMovements.filter(m => m.day < 1 || m.day > 90);
        if (outOfRangeMovements.length > 0) {
            consistency.problemas.push(`${outOfRangeMovements.length} movimientos fuera del rango de d√≠as`);
        }
        
        consistency.verificaciones = {
            balanceConsistente: calculatedBalance !== null,
            fechasValidas: invalidDates.length === 0,
            sinDuplicados: duplicateBoxes.length === 0,
            rangosCorrectos: outOfRangeMovements.length === 0
        };
        
        if (consistency.problemas.length > 0) {
            consistency.estado = 'INCONSISTENTE';
        }
        
        return consistency;
    } catch (error) {
        return {
            estado: 'ERROR',
            problemas: ['Error al verificar consistencia'],
            verificaciones: {}
        };
    }
}

function generateAdvancedRecommendations() {
    const recommendations = {
        criticas: [],
        mejoras: [],
        optimizaciones: []
    };
    
    try {
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const currentBalance = calculateCurrentBalance();
        
        // Recomendaciones cr√≠ticas
        if (activeBoxes.length === 0) {
            recommendations.criticas.push('URGENTE: Sin cajas activas - sistema sin generar ingresos');
        }
        
        if (currentBalance < 0) {
            recommendations.criticas.push('CR√çTICO: Balance negativo - revisar configuraci√≥n');
        }
        
        // Recomendaciones de mejora
        if (dayEditions.length > boxes.length) {
            recommendations.mejoras.push('Muchas ediciones - considera automatizar monitoreo');
        }
        
        if (additionalMovements.length > 50) {
            recommendations.mejoras.push('Muchos movimientos adicionales - eval√∫a si son necesarios');
        }
        
        // Recomendaciones de optimizaci√≥n
        recommendations.optimizaciones.push('Ejecuta mantenimiento semanal del sistema');
        recommendations.optimizaciones.push('Realiza respaldos regulares de los datos');
        
        if (activeBoxes.length > 0) {
            const uniqueTypes = [...new Set(activeBoxes.map(box => box.type))];
            if (uniqueTypes.length < 3) {
                recommendations.optimizaciones.push('Considera diversificar en m√°s tipos de cajas');
            }
        }
        
        return recommendations;
    } catch (error) {
        return {
            criticas: ['Error al generar recomendaciones'],
            mejoras: [],
            optimizaciones: []
        };
    }
}

// =====================================================
// FUNCIONES DE UTILIDAD FINAL
// =====================================================

function createSystemSnapshot() {
    try {
        const snapshot = {
            timestamp: new Date().toISOString(),
            version: '1.0',
            data: {
                configuracion: { ...systemConfig },
                cajas: [...boxes],
                movimientos: [...additionalMovements],
                ediciones: [...dayEditions],
                balances: [...dailyBalances]
            },
            metadata: {
                totalElements: boxes.length + additionalMovements.length + dayEditions.length,
                activeBoxes: boxes.filter(box => box.status === 'active').length,
                currentBalance: calculateCurrentBalance(),
                systemHealth: 'OK'
            }
        };
        
        logMessage(`üì∏ Snapshot del sistema creado: ${snapshot.metadata.totalElements} elementos`);
        return snapshot;
    } catch (error) {
        console.error('Error en createSystemSnapshot:', error);
        return null;
    }
}

function quickSystemStatus() {
    try {
        const status = {
            estado: 'üü¢ OPERATIVO',
            cajas: boxes.filter(box => box.status === 'active').length,
            balance: calculateCurrentBalance(),
            ultimaActividad: new Date().toLocaleString('es-ES')
        };
        
        console.log('‚ö° ESTADO R√ÅPIDO DEL SISTEMA:', status);
        return status;
    } catch (error) {
        console.error('Error en quickSystemStatus:', error);
        return { estado: 'üî¥ ERROR' };
    }
}

// =====================================================
// FIN DEL M√ìDULO 7C2-2B-2A - MANTENIMIENTO Y UTILIDADES
// =====================================================

// =====================================================
// VIVABOX SISTEMA - M√ìDULO 7C2-2B-2B (FINAL)
// COMPLETACI√ìN Y FINALIZACI√ìN - IMPLEMENTACI√ìN COMPLETA
// =====================================================

// =====================================================
// REPORTES INTEGRALES FINALES
// =====================================================

function generateComprehensiveSystemReport() {
    try {
        logMessage('üìã Generando reporte integral del sistema...');
        
        const comprehensiveReport = {
            timestamp: new Date().toISOString(),
            usuario: systemConfig.userName || 'No especificado',
            
            configuracionActual: {
                ...systemConfig,
                startDate: systemConfig.startDate ? systemConfig.startDate.toISOString() : null,
                balanceActual: calculateCurrentBalance(),
                diaActual: systemConfig.currentDay || 1
            },
            
            estadisticasGenerales: {
                totalCajas: boxes.length,
                cajasActivas: boxes.filter(box => box.status === 'active').length,
                totalMovimientos: additionalMovements.length,
                totalEdiciones: dayEditions.length,
                diasConActividad: [...new Set([
                    ...boxes.map(box => box.purchaseDay),
                    ...additionalMovements.map(mov => mov.day),
                    ...dayEditions.map(edit => edit.day)
                ])].length
            },
            
            analisisFinanciero: {
                inversionTotal: boxes.reduce((sum, box) => sum + box.pricePaid, 0),
                gananciasDiariasActuales: boxes.filter(box => box.status === 'active')
                    .reduce((sum, box) => sum + box.dailyEarning, 0),
                impactoMovimientos: additionalMovements.reduce((sum, mov) => 
                    sum + (mov.type === 'income' ? mov.amount : -mov.amount), 0),
                impactoEdiciones: dayEditions.reduce((sum, edit) => 
                    sum + (edit.finalEarnings - edit.originalEarnings), 0)
            },
            
            analisisRiesgos: calculateRiskMetrics(),
            rendimientoPorTipo: analyzePerformanceByType(),
            
            proyecciones: {
                balance7Dias: calculateProjection(7),
                balance30Dias: calculateProjection(30),
                balance60Dias: calculateProjection(60)
            },
            
            reporteEdiciones: dayEditions.length > 0 ? generateEditionAnalysisReport() : null,
            
            recomendacionesFinales: generateFinalSystemRecommendations(),
            
            saludDelSistema: checkSystemHealth()
        };
        
        // Mostrar reporte en consola
        console.group('üìã REPORTE INTEGRAL DEL SISTEMA VIVABOX');
        console.log('üïí Timestamp:', comprehensiveReport.timestamp);
        console.log('üë§ Usuario:', comprehensiveReport.usuario);
        console.log('‚öôÔ∏è Configuraci√≥n:', comprehensiveReport.configuracionActual);
        console.log('üìä Estad√≠sticas:', comprehensiveReport.estadisticasGenerales);
        console.log('üí∞ An√°lisis Financiero:', comprehensiveReport.analisisFinanciero);
        console.log('‚ö†Ô∏è An√°lisis de Riesgos:', comprehensiveReport.analisisRiesgos);
        console.log('üìà Rendimiento por Tipo:', comprehensiveReport.rendimientoPorTipo);
        console.log('üîÆ Proyecciones:', comprehensiveReport.proyecciones);
        console.log('üí° Recomendaciones Finales:', comprehensiveReport.recomendacionesFinales);
        console.log('üè• Salud del Sistema:', comprehensiveReport.saludDelSistema);
        console.groupEnd();
        
        showAlert('auto-alerts', 
            `üìã <strong>Reporte integral generado</strong><br>` +
            `üìä An√°lisis completo del sistema<br>` +
            `<small>Revisa la consola (F12) para ver todos los detalles</small>`, 'success');
        
        logMessage('üìã Reporte integral del sistema generado exitosamente');
        
        return comprehensiveReport;
    } catch (error) {
        console.error('Error en generateComprehensiveSystemReport:', error);
        showAlert('auto-alerts', '‚ùå Error al generar reporte integral', 'error');
        return null;
    }
}

function generateFinalSystemRecommendations() {
    try {
        const recommendations = {
            rendimiento: [],
            estrategia: [],
            mantenimiento: [],
            crecimiento: []
        };
        
        const activeBoxes = boxes.filter(box => box.status === 'active');
        const currentBalance = calculateCurrentBalance();
        const dailyEarnings = activeBoxes.reduce((sum, box) => sum + box.dailyEarning, 0);
        const totalInvestment = activeBoxes.reduce((sum, box) => sum + box.pricePaid, 0);
        
        // Recomendaciones de rendimiento
        if (activeBoxes.length === 0) {
            recommendations.rendimiento.push('Sin cajas activas - considera iniciar con una Caja B√°sica');
        } else {
            const avgROI = totalInvestment > 0 ? (dailyEarnings / totalInvestment) * 100 : 0;
            
            if (avgROI < 4) {
                recommendations.rendimiento.push('ROI bajo - considera cajas de mayor rendimiento como Premium o VIP');
            } else if (avgROI > 6) {
                recommendations.rendimiento.push('Excelente ROI - mant√©n la estrategia actual');
            } else {
                recommendations.rendimiento.push('ROI saludable - considera diversificar gradualmente');
            }
        }
        
        // Recomendaciones estrat√©gicas
        const uniqueTypes = [...new Set(activeBoxes.map(box => box.type))];
        if (uniqueTypes.length < 3 && activeBoxes.length > 2) {
            recommendations.estrategia.push('Diversifica en m√°s tipos de cajas para reducir riesgo');
        }
        
        if (currentBalance > systemConfig.initialBalance * 2) {
            recommendations.estrategia.push('Balance excelente - considera reinvertir para acelerar crecimiento');
        }
        
        const expiringBoxes = activeBoxes.filter(box => 
            box.expiryDay - (systemConfig.currentDay || 1) <= 7
        );
        if (expiringBoxes.length > 0) {
            recommendations.estrategia.push(`${expiringBoxes.length} caja(s) vencen pronto - planifica renovaciones`);
        }
        
        // Recomendaciones de mantenimiento
        if (dayEditions.length > 10) {
            recommendations.mantenimiento.push('Muchas ediciones registradas - considera automatizar el monitoreo');
        }
        
        if (additionalMovements.length > 20) {
            recommendations.mantenimiento.push('Muchos movimientos adicionales - revisa si son necesarios');
        }
        
        recommendations.mantenimiento.push('Realiza respaldos semanales de tus datos');
        recommendations.mantenimiento.push('Revisa el reporte de salud del sistema mensualmente');
        
        // Recomendaciones de crecimiento
        if (activeBoxes.length > 0 && dailyEarnings > 100) {
            recommendations.crecimiento.push('Considera escalamiento gradual con cajas de mayor valor');
        }
        
        if (currentBalance > systemConfig.initialBalance * 1.5) {
            recommendations.crecimiento.push('Capital suficiente para estrategias m√°s agresivas');
        }
        
        recommendations.crecimiento.push('Establece metas de crecimiento mensual del 20-30%');
        recommendations.crecimiento.push('Considera reinvertir al menos 70% de las ganancias');
        
        return recommendations;
    } catch (error) {
        console.error('Error en generateFinalSystemRecommendations:', error);
        return {
            rendimiento: ['Error al generar recomendaciones'],
            estrategia: [],
            mantenimiento: [],
            crecimiento: []
        };
    }
}

// =====================================================
// FUNCIONES DE FINALIZACI√ìN DEL PROYECTO
// =====================================================

function finalizeSystemSetup() {
    try {
        logMessage('üéØ Finalizando configuraci√≥n del sistema VIVABOX...');
        
        const finalization = {
            timestamp: new Date().toISOString(),
            version: '1.0.0',
            status: 'COMPLETADO',
            modules: [
                'Configuraci√≥n Base ‚úÖ',
                'Control Diario ‚úÖ',
                'Registro de Cajas ‚úÖ',
                'Automatizaci√≥n ‚úÖ',
                'Movimientos Adicionales ‚úÖ',
                'Edici√≥n de D√≠as ‚úÖ',
                'Filtros Avanzados ‚úÖ',
                'An√°lisis y Reportes ‚úÖ',
                'Mantenimiento ‚úÖ',
                'Utilidades Finales ‚úÖ'
            ],
            features: {
                sistemaConfiguracion: true,
                controlDiario: true,
                registroCajas: true,
                automatizacion: true,
                movimientosAdicionales: true,
                edicionDias: true,
                filtrosAvanzados: true,
                reportesCompletos: true,
                exportacionImportacion: true,
                mantenimientoSistema: true,
                validacionesCompletas: true,
                analisisRiesgos: true
            },
            estadisticasFinales: {
                totalLineasCodigo: 'Estimado: 3000+ l√≠neas',
                totalFunciones: 'Estimado: 150+ funciones',
                modulosImplementados: 10,
                pesta√±asPrincipales: 5,
                subPesta√±as: 2,
                tiposReportes: 8,
                funcionesAnalisis: 12
            }
        };
        
        console.group('üéØ FINALIZACI√ìN DEL SISTEMA VIVABOX');
        console.log('üìÖ Fecha de finalizaci√≥n:', finalization.timestamp);
        console.log('üì¶ Versi√≥n:', finalization.version);
        console.log('‚úÖ Estado:', finalization.status);
        console.log('üîß M√≥dulos implementados:', finalization.modules);
        console.log('‚öôÔ∏è Caracter√≠sticas:', finalization.features);
        console.log('üìä Estad√≠sticas finales:', finalization.estadisticasFinales);
        console.groupEnd();
        
        showAlert('auto-alerts', 
            `üéØ <strong>¬°SISTEMA VIVABOX COMPLETADO AL 100%!</strong><br>` +
            `‚úÖ Todos los m√≥dulos implementados<br>` +
            `üöÄ Sistema listo para uso completo<br>` +
            `<small>¬°Felicitaciones! El proyecto est√° terminado.</small>`, 'success');
        
        logMessage('üéØ ¬°SISTEMA VIVABOX COMPLETADO EXITOSAMENTE AL 100%!');
        
        return finalization;
    } catch (error) {
        console.error('Error en finalizeSystemSetup:', error);
        return null;
    }
}

function validateCompleteSystem() {
    try {
        const validation = {
            sistemCompleto: true,
            modulosFaltantes: [],
            funcionesEsenciales: {},
            recomendacionesFinales: []
        };
        
        // Validar funciones esenciales
        const essentialFunctions = [
            'updateSystemConfig', 'addNewBox', 'addMovement', 'applyDayEdit',
            'exportSystemData', 'importSystemData', 'generateSystemReport',
            'performSystemMaintenance', 'filterEditions', 'calculateProjection'
        ];
        
        essentialFunctions.forEach(funcName => {
            validation.funcionesEsenciales[funcName] = typeof window[funcName] === 'function';
        });
        
        // Verificar completitud
        const missingFunctions = Object.entries(validation.funcionesEsenciales)
            .filter(([name, exists]) => !exists)
            .map(([name]) => name);
        
        if (missingFunctions.length > 0) {
            validation.sistemCompleto = false;
            validation.modulosFaltantes = missingFunctions;
        }
        
        // Generar recomendaciones finales
        if (validation.sistemCompleto) {
            validation.recomendacionesFinales = [
                'üéâ ¬°Sistema completamente funcional!',
                'üìä Utiliza los reportes para analizar tu rendimiento',
                'üîß Ejecuta mantenimiento peri√≥dico del sistema',
                'üíæ Realiza respaldos regulares de tus datos',
                'üìà Monitorea las proyecciones para planificar mejor'
            ];
        } else {
            validation.recomendacionesFinales = [
                '‚ö†Ô∏è Faltan algunas funciones esenciales',
                'üîß Revisa la integraci√≥n de los m√≥dulos',
                'üìã Consulta la documentaci√≥n de implementaci√≥n'
            ];
        }
        
        console.group('‚úÖ VALIDACI√ìN COMPLETA DEL SISTEMA');
        console.log('üéØ Sistema completo:', validation.sistemCompleto ? 'S√ç' : 'NO');
        console.log('üîß Funciones esenciales:', validation.funcionesEsenciales);
        if (validation.modulosFaltantes.length > 0) {
            console.warn('‚ùå M√≥dulos faltantes:', validation.modulosFaltantes);
        }
        console.log('üí° Recomendaciones finales:', validation.recomendacionesFinales);
        console.groupEnd();
        
        return validation;
    } catch (error) {
        console.error('Error en validateCompleteSystem:', error);
        return { sistemCompleto: false, error: error.message };
    }
}

// =====================================================
// FUNCIONES DE UTILIDAD FINAL
// =====================================================

function showSystemCelebration() {
    try {
        const celebration = `
üéâ ¬°FELICITACIONES! üéâ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üèÜ SISTEMA VIVABOX COMPLETADO AL 100%
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ M√ìDULOS IMPLEMENTADOS:
   üìä Sistema de Configuraci√≥n
   üìÖ Control Diario con Calendario
   üì¶ Registro Completo de Cajas
   üîß Motor de Automatizaci√≥n
   üí∞ Movimientos Adicionales
   ‚úèÔ∏è Edici√≥n Avanzada de D√≠as
   üîç Filtros y B√∫squedas
   üìã Reportes y An√°lisis
   üíæ Exportaci√≥n/Importaci√≥n
   üßπ Mantenimiento del Sistema

üöÄ CARACTER√çSTICAS PRINCIPALES:
   ‚Ä¢ Control completo de inversiones
   ‚Ä¢ C√°lculos autom√°ticos de balances
   ‚Ä¢ Proyecciones financieras
   ‚Ä¢ Sistema de alertas inteligentes
   ‚Ä¢ Reportes ejecutivos completos
   ‚Ä¢ An√°lisis de riesgos
   ‚Ä¢ Gesti√≥n de ediciones
   ‚Ä¢ Exportaci√≥n completa de datos

üéØ ¬°EL PROYECTO EST√Å TERMINADO Y LISTO PARA USAR!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
        `;
        
        console.log(celebration);
        
        showAlert('auto-alerts', 
            `üéâ <strong>¬°PROYECTO COMPLETADO!</strong><br>` +
            `üèÜ Sistema VIVABOX terminado al 100%<br>` +
            `üöÄ Todos los m√≥dulos implementados<br>` +
            `<small>¬°Revisa la consola para ver la celebraci√≥n completa!</small>`, 'success');
        
        return celebration;
    } catch (error) {
        console.error('Error en showSystemCelebration:', error);
    }
}

function generateProjectSummary() {
    try {
        const summary = {
            nombreProyecto: 'Sistema VIVABOX - Control Completo de Cajas',
            version: '1.0.0',
            fechaCompletacion: new Date().toLocaleDateString('es-ES'),
            desarrollador: 'Claude (Anthropic) + Usuario',
            
            resumenTecnico: {
                lenguajes: ['HTML5', 'CSS3', 'JavaScript ES6+'],
                arquitectura: 'Single Page Application (SPA)',
                patrones: ['Modular Design', 'Event-Driven Programming'],
                almacenamiento: 'Client-side (Variables + Local Storage)',
                responsive: 'S√≠ (Mobile-friendly)'
            },
            
            modulosDesarrollados: [
                'M√≥dulo de Configuraci√≥n (Base)',
                'M√≥dulo de Control Diario (Calendario)',
                'M√≥dulo de Registro de Cajas',
                'M√≥dulo de Automatizaci√≥n y Reportes',
                'M√≥dulo de Movimientos Adicionales',
                'M√≥dulo de Edici√≥n de D√≠as (B√°sico)',
                'M√≥dulo de Filtros Avanzados',
                'M√≥dulo de An√°lisis y Tendencias',
                'M√≥dulo de Mantenimiento',
                'M√≥dulo de Utilidades Finales'
            ],
            
            funcionesPrincipales: [
                'Gesti√≥n completa de cajas de inversi√≥n',
                'C√°lculo autom√°tico de balances diarios',
                'Proyecciones financieras a 7, 30 y 60 d√≠as',
                'Sistema de alertas por vencimientos',
                'An√°lisis de rendimiento por tipo de caja',
                'Edici√≥n y correcci√≥n de d√≠as espec√≠ficos',
                'Exportaci√≥n/importaci√≥n completa de datos',
                'Reportes ejecutivos detallados',
                'Mantenimiento autom√°tico del sistema',
                'An√°lisis de riesgos y recomendaciones'
            ],
            
            estadisticasDesarrollo: {
                tiempoEstimado: 'Varios d√≠as de desarrollo intensivo',
                lineasCodigo: '3000+ l√≠neas',
                funciones: '150+ funciones',
                modulosImplementados: 10,
                pesta√±asPrincipales: 5
            }
        };
        
        console.group('üìã RESUMEN COMPLETO DEL PROYECTO');
        console.log('üéØ Proyecto:', summary.nombreProyecto);
        console.log('üì¶ Versi√≥n:', summary.version);
        console.log('üìÖ Completado:', summary.fechaCompletacion);
        console.log('üë®‚Äçüíª Desarrollado por:', summary.desarrollador);
        console.log('üîß Resumen t√©cnico:', summary.resumenTecnico);
        console.log('üìä M√≥dulos desarrollados:', summary.modulosDesarrollados);
        console.log('‚öôÔ∏è Funciones principales:', summary.funcionesPrincipales);
        console.log('üìà Estad√≠sticas:', summary.estadisticasDesarrollo);
        console.groupEnd();
        
        return summary;
    } catch (error) {
        console.error('Error en generateProjectSummary:', error);
        return null;
    }
}

// =====================================================
// INICIALIZACI√ìN AUTOM√ÅTICA DE FINALIZACI√ìN
// =====================================================

// Ejecutar autom√°ticamente al cargar el m√≥dulo final
setTimeout(() => {
    try {
        logMessage('üéØ Ejecutando finalizaci√≥n autom√°tica del sistema...');
        
        // Validar sistema completo
        const validation = validateCompleteSystem();
        
        // Si el sistema est√° completo, mostrar celebraci√≥n
        if (validation.sistemCompleto) {
            setTimeout(() => {
                finalizeSystemSetup();
                showSystemCelebration();
                generateProjectSummary();
            }, 1000);
        }
        
    } catch (error) {
        console.error('Error en inicializaci√≥n de finalizaci√≥n:', error);
    }
}, 2000);

// =====================================================
// FIN DEL SISTEMA VIVABOX - PROYECTO COMPLETADO AL 100%
// =====================================================


// =====================================================
// INICIALIZACI√ìN DEL SISTEMA - CORREGIDA
// =====================================================

document.addEventListener('DOMContentLoaded', function() {
    try {
        // Establecer fecha actual por defecto
        const today = new Date();
        const fechaInput = document.getElementById('fecha-inicio');
        if (fechaInput) {
            fechaInput.value = today.toISOString().split('T')[0];
            systemConfig.startDate = today;
        }
        
        // Inicializar sistema
        logMessage('üöÄ Sistema VIVABOX - Parte 6 iniciada correctamente');
        
        // Configurar estilos din√°micos para sub-tabs
        const movTabs = document.querySelectorAll('.mov-tab');
        movTabs.forEach((tab, index) => {
            if (index === 0) {
                tab.style.backgroundColor = '#667eea';
                tab.style.color = 'white';
            }
            
            tab.addEventListener('mouseenter', function() {
                if (!this.classList.contains('active')) {
                    this.style.backgroundColor = '#e9ecef';
                }
            });
            
            tab.addEventListener('mouseleave', function() {
                if (!this.classList.contains('active')) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#6c757d';
                }
            });
        });
        
        // INICIALIZACI√ìN CORREGIDA DE SUB-PESTA√ëAS
setTimeout(() => {
    initializeMovementSubtabs();
}, 500);
        
        // Configurar configuraci√≥n inicial
        updateSystemConfig();

        // Inicializar selector de fecha en automatizaci√≥n
        setTimeout(() => {
            const analysisSelector = document.getElementById('analysis-day-selector');
            if (analysisSelector) {
                analysisSelector.value = systemConfig.currentDay || 1;
                updateMetricsBySelectedDate();
                logMessage('üìÖ Selector de an√°lisis inicializado');
            }
        }, 500);
        
        logMessage('‚úÖ Inicializaci√≥n completada - Sistema listo para Parte 7');
        
    } catch (error) {
        console.error('Error en inicializaci√≥n:', error);
        logMessage('‚ùå Error en inicializaci√≥n del sistema');
    }
});

// =====================================================
// FIN DE PARTE 6 - ESTRUCTURA BASE COMPLETADA
// =====================================================

function generateAutomation30DayTable() {
    let tableHTML = '<table class="calendar-table">';
    
    // Generar 5 filas de 6 d√≠as cada una = 30 d√≠as
    for (let row = 0; row < 5; row++) {
        // Fila de headers
        tableHTML += '<tr>';
        for (let col = 1; col <= 6; col++) {
            const dayNum = row * 6 + col;
            if (dayNum <= 30) {
                tableHTML += `<td class="day-header">D√çA ${dayNum}</td>`;
            }
        }
        tableHTML += '</tr>';
        
        // Fila de fechas
        tableHTML += '<tr>';
        for (let col = 1; col <= 6; col++) {
            const dayNum = row * 6 + col;
            if (dayNum <= 30) {
                tableHTML += `<td class="date-cell" id="auto-date-${dayNum}">[FECHA]</td>`;
            }
        }
        tableHTML += '</tr>';
        
        // Fila de c√°lculos
        tableHTML += '<tr>';
        for (let col = 1; col <= 6; col++) {
            const dayNum = row * 6 + col;
            if (dayNum <= 30) {
                tableHTML += `
                    <td class="calc-cell" id="auto-calc-${dayNum}">
                        <div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; font-size: 7px; line-height: 1.1;">
                            <div style="font-weight: bold; color: #1976D2; font-size: 8px;" id="auto-total-${dayNum}">$0</div>
                            <div style="color: #666; font-size: 6px;" id="auto-ops-${dayNum}">[OPS]</div>
                        </div>
                    </td>
                `;
            }
        }
        tableHTML += '</tr>';
    }
    
    tableHTML += '</table>';
    return tableHTML;
}

function changeAutomationRange(range) {
    window.automationRange = range;
    
    // Actualizar display del rango
    const ranges = {
        1: '1-30',
        2: '31-60', 
        3: '61-90'
    };
    
    const rangeDisplay = document.getElementById('range-display');
    if (rangeDisplay) {
        rangeDisplay.textContent = ranges[range];
    }
    
    // Actualizar botones activos - CORREGIDO
    const buttonContainer = rangeDisplay?.parentElement;
    if (buttonContainer) {
        const buttons = buttonContainer.querySelectorAll('.btn');
        buttons.forEach((btn, index) => {
            if (index + 1 === range) {
                btn.className = 'btn btn-primary';
            } else {
                btn.className = 'btn btn-secondary';
            }
        });
    }
    
    // Actualizar vista previa - USAR FUNCI√ìN CORRECTA
    updateAutomationPreview();
    
    logMessage(`üìÖ Rango de automatizaci√≥n cambiado a d√≠as ${ranges[range]}`);
}

function debugAutomationTable() {
    console.log('üîç DIAGN√ìSTICO DE TABLA DE AUTOMATIZACI√ìN');
    
    // Verificar cu√°ntos elementos auto-date existen
    let dateElements = 0;
    for (let i = 1; i <= 30; i++) {
        const element = document.getElementById(`auto-date-${i}`);
        if (element) {
            dateElements++;
        } else {
            console.log(`‚ùå No existe auto-date-${i}`);
            break;
        }
    }
    
    console.log(`üìä Elementos auto-date encontrados: ${dateElements}/30`);
    
    // Verificar cu√°ntos elementos auto-total existen
    let totalElements = 0;
    for (let i = 1; i <= 30; i++) {
        const element = document.getElementById(`auto-total-${i}`);
        if (element) {
            totalElements++;
        } else {
            console.log(`‚ùå No existe auto-total-${i}`);
            break;
        }
    }
    
    console.log(`üí∞ Elementos auto-total encontrados: ${totalElements}/30`);
    
    // Mostrar el HTML generado
    const container = document.getElementById('automation-table-container');
    if (container) {
        console.log('üìã HTML de la tabla:', container.innerHTML.substring(0, 500) + '...');
    }
}


function changeControlRange(range) {
    window.controlRange = range;
    
    // Actualizar display del rango
    const ranges = {
        1: '1-30',
        2: '31-60', 
        3: '61-90'
    };
    
    const rangeDisplay = document.getElementById('control-range-display');
    if (rangeDisplay) {
        rangeDisplay.textContent = ranges[range];
    }
    
    // Actualizar botones activos - M√âTODO MEJORADO
    const buttonContainer = rangeDisplay?.parentElement;
    if (buttonContainer) {
        const buttons = buttonContainer.querySelectorAll('.btn');
        buttons.forEach((btn, index) => {
            // Los botones est√°n en orden: 1-30, 31-60, 61-90
            if (index + 1 === range) {
                btn.className = 'btn btn-primary';
            } else {
                btn.className = 'btn btn-secondary';
            }
        });
    }
    
    // Actualizar vista del control diario
    updateControlDisplayWithRange(range);
    
    logMessage(`üìÖ Control Diario cambiado a d√≠as ${ranges[range]}`);
}

function updateControlDisplayWithRange(range) {
    try {
        const startDay = (range - 1) * 30 + 1;
        const endDay = Math.min(range * 30, 90);
        
        // CORRECCI√ìN: Usar los IDs reales que existen (auto-date, auto-total, etc.)
        for (let day = startDay; day <= endDay; day++) {
            const displayIndex = day - startDay + 1;
            if (displayIndex <= 30) {
                
                // Calcular fecha basada en el d√≠a REAL
                const currentDate = createDateWithoutTimezone(systemConfig.startDate);
                currentDate.setDate(currentDate.getDate() + day - 1);
                
                // USAR LOS IDs QUE REALMENTE EXISTEN
                const dateElement = document.getElementById(`auto-date-${displayIndex}`);
if (dateElement) {
    const formatDate = formatDateDisplay(currentDate, false);
    dateElement.textContent = formatDate;
} else {
    console.warn(`‚ùå Elemento auto-date-${displayIndex} no encontrado`);
}
            }
        }
        
        // Recalcular balances para el nuevo rango
        calculateAndDisplayBalancesWithRange(range);
        
    } catch (error) {
        console.error('Error en updateControlDisplayWithRange:', error);
    }
}

function calculateAndDisplayBalancesWithRange(range) {
    try {
        const startDay = (range - 1) * 30 + 1;
        const endDay = Math.min(range * 30, 90);
        
        let currentBalance = systemConfig.initialBalance;
        
        // Calcular balance acumulado HASTA el d√≠a de inicio del rango
        for (let day = 1; day < startDay; day++) {
            let dayEarnings = 0;
            let dayExpenses = 0;
            
            boxes.forEach(box => {
                if (day >= box.purchaseDay && day <= box.expiryDay) {
                    dayEarnings += box.dailyEarning;
                }
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                }
            });
            
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                } else {
                    dayExpenses += movement.amount;
                }
            });
            
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
            }
            
            currentBalance = currentBalance + dayEarnings - dayExpenses;
        }
        
        // Calcular y mostrar el rango actual
        for (let day = startDay; day <= endDay; day++) {
            const displayIndex = day - startDay + 1;
            
            let dayEarnings = 0;
            let dayExpenses = 0;
            let operations = [];
            
            boxes.forEach(box => {
                if (day >= box.purchaseDay && day <= box.expiryDay) {
                    dayEarnings += box.dailyEarning;
                }
                if (day === box.purchaseDay) {
                    dayExpenses += box.pricePaid;
                    operations.push(`üì¶ ${box.name.substring(0, 8)}...`);
                }
            });
            
            additionalMovements.filter(m => m.day === day).forEach(movement => {
                if (movement.type === 'income') {
                    dayEarnings += movement.amount;
                    operations.push(`üí∞ +${movement.amount}`);
                } else {
                    dayExpenses += movement.amount;
                    operations.push(`üí∏ -${movement.amount}`);
                }
            });
            
            const dayEdit = dayEditions.find(e => e.day === day);
            if (dayEdit) {
                dayEarnings = dayEdit.finalEarnings || dayEarnings;
                operations.push(`‚úèÔ∏è Editado`);
            }
            
            currentBalance = currentBalance + dayEarnings - dayExpenses;
            
            // USAR LOS IDs QUE REALMENTE EXISTEN
            const totalElement = document.getElementById(`auto-total-${displayIndex}`);
            const opsElement = document.getElementById(`auto-ops-${displayIndex}`);
            
            if (totalElement) {
                totalElement.textContent = `$${currentBalance.toLocaleString()}`;
                totalElement.style.color = currentBalance >= 0 ? '#1976D2' : '#d32f2f';
            }
            
            if (opsElement) {
                if (dayEarnings > 0) {
                    opsElement.textContent = `+$${dayEarnings.toLocaleString()}`;
                } else if (dayExpenses > 0) {
                    opsElement.textContent = `-$${dayExpenses.toLocaleString()}`;
                } else {
                    opsElement.textContent = 'Sin operaciones';
                }
            }
            
            const calcElement = document.getElementById(`auto-calc-${displayIndex}`);
            const hasExpiry = boxes.some(box => box.expiryDay === day);
            if (calcElement && hasExpiry) {
                calcElement.classList.add('alert');
            }
        }
        
    } catch (error) {
        console.error('Error en calculateAndDisplayBalancesWithRange:', error);
    }
}

function forceUpdateAutomation() {
    try {
        console.log('üîß Forzando actualizaci√≥n de automatizaci√≥n...');
        
        // Verificar configuraci√≥n
        if (!systemConfig.startDate) {
            console.error('‚ùå No hay fecha de inicio configurada');
            return;
        }
        
        console.log('‚úÖ Fecha de inicio:', systemConfig.startDate.toLocaleDateString());
        
        // Forzar actualizaci√≥n
        updateAutomationStatus();
        updateAutomationPreview();
        
        console.log('‚úÖ Automatizaci√≥n actualizada');
        
    } catch (error) {
        console.error('Error en forceUpdateAutomation:', error);
    }
}

// FUNCI√ìN DE PRUEBA PARA SUB-PESTA√ëAS
function testSubtabs() {
    console.group('üß™ PRUEBA DE SUB-PESTA√ëAS');
    
    try {
        // 1. Verificar elementos existen
        const elementos = {
            adicionalesTab: document.getElementById('adicionales-subtab'),
            edicionTab: document.getElementById('edicion-subtab'),
            btnAdicionales: document.getElementById('btn-adicionales'),
            btnEdicion: document.getElementById('btn-edicion')
        };
        
        console.log('üìã Elementos encontrados:', elementos);
        
        // 2. Probar cambio a edici√≥n
        console.log('üîÑ Probando cambio a edici√≥n...');
        switchMovTab('edicion');
        
        setTimeout(() => {
            const edicionVisible = elementos.edicionTab.classList.contains('active');
            const adicionalesOculto = !elementos.adicionalesTab.classList.contains('active');
            
            console.log('‚úÖ Estado despu√©s del cambio:');
            console.log('  - Edici√≥n visible:', edicionVisible);
            console.log('  - Adicionales oculto:', adicionalesOculto);
            console.log('  - Clases edici√≥n:', elementos.edicionTab.className);
            console.log('  - Clases adicionales:', elementos.adicionalesTab.className);
            
            // 3. Probar cambio de vuelta
            console.log('üîÑ Probando cambio de vuelta a adicionales...');
            switchMovTab('adicionales');
            
            setTimeout(() => {
                const adicionalesVisible = elementos.adicionalesTab.classList.contains('active');
                const edicionOculto = !elementos.edicionTab.classList.contains('active');
                
                console.log('‚úÖ Estado final:');
                console.log('  - Adicionales visible:', adicionalesVisible);
                console.log('  - Edici√≥n oculto:', edicionOculto);
                
                if (adicionalesVisible && edicionOculto) {
                    console.log('üéâ ¬°PRUEBA EXITOSA! Las sub-pesta√±as funcionan correctamente.');
                } else {
                    console.error('‚ùå PRUEBA FALLIDA. Revisa la implementaci√≥n.');
                }
            }, 100);
        }, 100);
        
    } catch (error) {
        console.error('‚ùå Error en la prueba:', error);
    }
    
    console.groupEnd();
}

// FUNCI√ìN PARA FORZAR REINICIO DE SUB-PESTA√ëAS
function resetSubtabs() {
    try {
        console.log('üîÑ Reiniciando sub-pesta√±as...');
        
        // Remover todas las clases active
        document.querySelectorAll('.mov-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.mov-tab').forEach(el => el.classList.remove('active'));
        
        // Reinicializar
        initializeMovementSubtabs();
        
        console.log('‚úÖ Sub-pesta√±as reiniciadas');
    } catch (error) {
        console.error('Error al reiniciar sub-pesta√±as:', error);
    }
}

    </script>
</body>
</html>